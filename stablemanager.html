<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stable Manager</title>
    <style>
        /* --- Global Styles --- */
        :root { /* Define light mode colors */
            --body-bg: #dcdcdc;
            --container-bg: #f8f9fa;
            --text-color: #212529;
            --heading-color: #1a1a1a;
            --border-color: #dee2e6;
            --border-color-light: #e9ecef;
            --border-color-dark: #cccccc;
            --card-bg: #ffffff;
            --card-shadow: rgba(0,0,0,0.06);
            --table-header-bg: #e9ecef;
            --table-header-color: #495057;
            --table-hover-bg: #f1f1f1;
            --table-footer-bg: #e2e6ea;
            --input-bg: #fff;
            --input-color: #495057;
            --input-border: #ced4da;
            --link-color: #0069d9;
            --link-hover-color: #004085;
            --inline-form-bg: #f8f9fa;
            --scroll-btn-bg: #5a6268;
            --scroll-btn-hover-bg: #343a40;
            --nav-btn-color: #6c757d;
            --nav-btn-hover-color: #545b62;
            --nav-btn-disabled-bg: #e9ecef;
            --nav-btn-disabled-color: #adb5bd;
            --nav-btn-disabled-border: #ced4da;
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --chart-text-color: #555555;
            --stars-color: #ffc107;
        }

        body.dark-mode { /* Define dark mode colors */
            --body-bg: #212529;
            --container-bg: #343a40;
            --text-color: #e9ecef;
            --heading-color: #f8f9fa;
            --border-color: #495057;
            --border-color-light: #495057;
            --border-color-dark: #5a6268;
            --card-bg: #454c52;
            --card-shadow: rgba(0,0,0,0.3);
            --table-header-bg: #495057;
            --table-header-color: #f8f9fa;
            --table-hover-bg: #5a6268;
            --table-footer-bg: #3e444a;
            --input-bg: #495057;
            --input-color: #f8f9fa;
            --input-border: #6c757d;
            --link-color: #58a6ff;
            --link-hover-color: #80bfff;
            --inline-form-bg: #495057;
            --scroll-btn-bg: #6c757d;
            --scroll-btn-hover-bg: #adb5bd;
            --nav-btn-color: #adb5bd;
            --nav-btn-hover-color: #ced4da;
            --nav-btn-disabled-bg: #495057;
            --nav-btn-disabled-color: #6c757d;
            --nav-btn-disabled-border: #6c757d;
            --chart-grid-color: rgba(255, 255, 255, 0.15);
            --chart-text-color: #FFFFFF;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6; margin: 0; padding: 0; background-color: var(--body-bg); color: var(--text-color); transition: background-color 0.3s ease, color 0.3s ease;
        }
        .page-container { max-width: 1400px; margin: 40px auto 25px; background: var(--container-bg); padding: 25px 30px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); color: var(--text-color); position: relative; transition: background-color 0.3s ease, color 0.3s ease; }
        .app-title { font-size: 1rem; font-style: italic; text-align: left; color: var(--text-color); margin-bottom: 15px; margin-top: 0; padding-top: 5px; border-bottom: 1px solid var(--border-color-light); padding-bottom: 10px; }
        h1, h2, h3 { color: var(--heading-color); text-align: center; margin-top: 0; margin-bottom: 25px; transition: color 0.3s ease; }
        h1 { border-bottom: 2px solid var(--border-color-dark); padding-bottom: 15px; font-size: 2.3em; font-weight: 600; margin-top: 0; }
        h2 { border-bottom: 1px solid var(--border-color); padding-bottom: 12px; margin-top: 40px; font-size: 1.9em; font-weight: 500; }
        h3 { font-size: 1.4em; font-weight: 600; color: var(--heading-color); }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95em; color: var(--text-color); opacity: 0.9; }
        select, input[type="text"], input[type="number"], input[type="url"] { width: 100%; padding: 10px 12px; margin-bottom: 18px; border: 1px solid var(--input-border); border-radius: 4px; box-sizing: border-box; font-size: 1em; background-color: var(--input-bg); color: var(--input-color); transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease; }
        select:focus, input:focus { border-color: #80bdff; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); }
        button, .button-link { padding: 10px 18px; margin: 5px; border: 1px solid transparent; border-radius: 4px; cursor: pointer; font-size: 0.95em; font-weight: 500; text-decoration: none; display: inline-block; text-align: center; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease, box-shadow 0.15s ease-in-out; line-height: 1.5; }
        .btn-primary { background-color: #007bff; color: white; border-color: #007bff;} .btn-primary:hover { background-color: #0056b3; border-color: #0056b3;}
        .btn-secondary { background-color: #6c757d; color: white; border-color: #6c757d;} .btn-secondary:hover { background-color: #545b62; border-color: #545b62;}
        .btn-success { background-color: #28a745; color: white; border-color: #28a745;} .btn-success:hover { background-color: #1e7e34; border-color: #1e7e34;}
        .btn-info { background-color: #17a2b8; color: white; border-color: #17a2b8;} .btn-info:hover { background-color: #117a8b; border-color: #117a8b;}
        .btn-danger { background-color: #dc3745; color: white; border-color: #dc3745;} .btn-danger:hover { background-color: #bd2130; border-color: #bd2130;}
        .btn-warning { background-color: #ffc107; color: black; border-color: #ffc107;} .btn-warning:hover { background-color: #d39e00; border-color: #d39e00;}
        .btn-sm { padding: 4px 8px; font-size: 0.85em; line-height: 1.4; }
        button:disabled, .button-link:disabled { background-color: var(--nav-btn-disabled-bg); border-color: var(--nav-btn-disabled-border); color: var(--nav-btn-disabled-color); cursor: not-allowed; opacity: 0.65; box-shadow: none; }
        .hidden { display: none !important; }

        /* --- Navigation Tabs Styling --- */
        .nav-links {
            margin-bottom: 0;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0;
            padding-top: 5px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 2px;
        }

        .nav-links .button-link {
            margin: 0;
            background-color: transparent;
            border: 1px solid transparent;
            border-bottom: none;
            color: var(--link-color);
            font-weight: 500;
            padding: 10px 16px;
            border-radius: 6px 6px 0 0;
            position: relative;
            bottom: -1px;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
            line-height: 1.5;
        }

        .nav-links .button-link:hover {
            background-color: var(--table-hover-bg);
            color: var(--link-hover-color);
            text-decoration: none;
        }

        .nav-links .button-link.active-tab {
            background-color: var(--container-bg);
            color: var(--heading-color);
            border-color: var(--border-color);
            border-bottom-color: var(--container-bg);
            font-weight: 600;
            z-index: 1;
        }

        .nav-links .btn-io {
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        .nav-links .btn-io:hover {
            background-color: var(--table-hover-bg);
            color: var(--link-hover-color);
        }

        .nav-links .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        .nav-links .btn-success:hover {
             background-color: #1e7e34;
             border-color: #1e7e34;
             color: white;
        }
        .nav-links .btn-warning { /* For Undo button */
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color-dark);
        }
        body.dark-mode .nav-links .btn-warning {
            background-color: #ffc107;
            color: black;
            border-color: #ffc107;
        }
        body.dark-mode .nav-links .btn-warning:hover {
            background-color: #d39e00;
            border-color: #d39e00;
        }
        /* --- End Navigation Tabs Styling --- */

        .theme-switch-wrapper { position: absolute; top: 20px; right: 30px; display: flex; align-items: center; z-index: 1001;}
        .theme-switch-wrapper em { margin-right: 10px; font-size: 0.9rem; color: var(--text-color); }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: #fff; bottom: 3px; content: ""; height: 18px; left: 3px; position: absolute; transition: .4s; width: 18px; border-radius: 50%; }
        input:checked + .slider { background-color: #007bff; }
        input:checked + .slider:before { transform: translateX(24px); }
        body.dark-mode .slider { background-color: #555; }
        body.dark-mode .slider:before { background-color: #ccc; }
        #overviewPage table, #financialsPage table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; background-color: var(--card-bg); border-radius: 4px; overflow: hidden; }
        #overviewPage th, #overviewPage td, #financialsPage th, #financialsPage td { border: 1px solid var(--border-color); padding: 9px 12px; text-align: left; white-space: nowrap; vertical-align: middle;}
        #overviewPage th, #financialsPage th { background-color: var(--table-header-bg); font-weight: 600; color: var(--table-header-color); border-bottom: 2px solid var(--border-color); }
        #overviewPage tbody tr, #financialsPage tbody tr { cursor: default; transition: background-color 0.15s ease; }
        #overviewPage tbody tr.dragging { opacity: 0.5; background: #cce1ff; }
        #overviewPage tbody tr.drag-over { border-top: 2px solid #007bff; }
        #overviewPage .action-link, #financialsPage .action-link { color: var(--link-color); text-decoration: none; font-weight: bold; cursor: pointer; }
        #overviewPage .action-link:hover, #financialsPage .action-link:hover { text-decoration: underline; color: var(--link-hover-color); }
        #overviewPage .no-horses, #financialsPage .no-horses { text-align: center; color: var(--text-color); opacity: 0.7; font-style: italic; white-space: normal; padding: 20px; background-color: transparent; }
        #overviewPage .drag-handle { cursor: grab; user-select: none; text-align: center; width: 30px; }
        #overviewPage .drag-handle:active { cursor: grabbing; }
        #overviewPage .table-footer td, #financialsPage .table-footer td { font-weight: bold; background-color: var(--table-footer-bg); color: var(--table-header-color); border-top: 2px solid var(--border-color-dark); }
        #overviewPage .table-footer td.footer-total, #financialsPage .table-footer td.footer-total { text-align: right; }
        #financialsPage th:nth-child(n+2), #financialsPage td:nth-child(n+2) { text-align: right; }
        #financialsPage .table-footer td { text-align: right; }
        #financialsPage .table-footer td:first-child { text-align: left;}
        #financialsPage .forged-label { font-size:0.8em; color:#dc3745; font-style: italic; margin-left: 5px;}
        #detailPage .page-container-inner { max-width: 950px; margin: 0 auto; }
        #detailPage #mainActions { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        #detailPage #horseProfileDisplay { border: 1px solid var(--border-color); padding: 25px; margin-top: 15px; background-color: var(--card-bg); border-radius: 6px; box-shadow: 0 1px 4px var(--card-shadow); }
        #detailPage #horseProfileDisplay h2 { text-align: left; border-bottom: none; font-size: 1.7em; margin-bottom: 20px; color: var(--heading-color); }
        #detailPage .profile-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        #detailPage .profile-section { background-color: var(--card-bg); padding: 20px; border: 1px solid var(--border-color-light); border-radius: 5px; box-shadow: 0 1px 2px var(--card-shadow); }
        #detailPage .profile-section h3 { margin-top: 0; color: #007bff; font-size: 1.2em; border-bottom: 1px solid var(--border-color-light); padding-bottom: 8px; margin-bottom: 15px; text-align: left; font-weight: 600;}
        body.dark-mode #detailPage .profile-section h3 { color: #58a6ff; border-bottom-color: var(--border-color-dark); }
        #detailPage #horseProfileDisplay p { margin: 7px 0; color: var(--text-color); font-size: 0.95em; }
        #detailPage #horseProfileDisplay strong { color: var(--heading-color); opacity: 0.9; display: inline-block; font-weight: 600; }
        #detailPage #basicInfo strong, #detailPage #raceRecord strong, #detailPage #pedigree strong, #detailPage #financials strong { min-width: 145px; }
        #detailPage #pedigree p strong { min-width: 110px; }
        #detailPage #stats p span.stars, #detailPage #augments p span { display: block; margin-top: 4px; }
        #detailPage #horseForm { border: 1px solid var(--border-color); padding: 30px; margin-top: 25px; background-color: var(--card-bg); border-radius: 6px; }
        #detailPage #horseForm h2 { text-align: left; font-size: 1.7em; border-bottom: 1px solid var(--border-color); color: var(--heading-color); }
        #detailPage .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px 25px; }
        #prevHorseBtn, #nextHorseBtn { background-color: var(--nav-btn-color); color: white; border-color: var(--nav-btn-color); }
        #prevHorseBtn:hover:not(:disabled), #nextHorseBtn:hover:not(:disabled) { background-color: var(--nav-btn-hover-color); border-color: var(--nav-btn-hover-color); }
        #race1TimeChartContainer, #zedBalanceChartContainer { margin-top: 20px; padding: 15px; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 5px; box-shadow: 0 1px 3px var(--card-shadow); }
        #race1TimeChartContainer h3, #zedBalanceChartContainer h3 { text-align: center; margin-top: 0; margin-bottom: 15px; color: var(--heading-color); border-bottom: 1px solid var(--border-color-light); padding-bottom: 10px; }
        #race1TimeChartContainer p, #zedBalanceChartContainer p { text-align: center; font-style: italic; opacity: 0.7; }
        #poolPage .horse-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; margin-top: 20px; }
        #poolPage .horse-card { border: 1px solid var(--border-color); border-radius: 6px; padding: 20px; background-color: var(--card-bg); box-shadow: 0 2px 5px var(--card-shadow); transition: box-shadow 0.2s ease; }
        #poolPage .horse-card:hover { box-shadow: 0 5px 12px var(--card-shadow); }
        #poolPage .horse-card h3 { margin-top: 0; margin-bottom: 18px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color-light); text-align: center; color: var(--link-color); font-size: 1.35em; font-weight: 600; }
        #poolPage .horse-card h4 { margin-top: 18px; margin-bottom: 10px; color: var(--heading-color); opacity: 0.8; font-size: 1.0em; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px dotted var(--border-color); padding-bottom: 5px;}
        #poolPage .horse-card p { margin: 6px 0; font-size: 0.9em; color: var(--text-color); }
        #poolPage .horse-card strong { display: inline-block; min-width: 85px; color: var(--heading-color); opacity: 0.9; margin-right: 5px; font-weight: 600; }
        #poolPage .view-details-link { display: block; margin-top: 20px; text-align: center; color: var(--link-color); text-decoration: none; font-weight: 600; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--container-bg); transition: background-color 0.2s, border-color 0.2s; }
        #poolPage .view-details-link:hover { background-color: var(--table-hover-bg); border-color: var(--border-color-dark); color: var(--link-hover-color); }
        #poolPage .no-horses { text-align: center; color: var(--text-color); opacity: 0.7; margin-top: 25px; font-style: italic; padding: 20px; }
        #poolPage .horse-card .financials-pool strong { min-width: 115px; }

        /* --- Breeding Simulator Specific Styling (on Pool Page) --- */
        #poolPage #breedingSimulationSection {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid var(--border-color-dark);
            border-radius: 6px;
            background-color: var(--card-bg);
        }
        #poolPage #breedingSimulationSection > h3 {
            text-align: left;
            font-size: 1.5em;
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        #poolPage .simulator-controls {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        #poolPage .simulator-select-group {
            flex-grow: 1;
        }
        #poolPage .simulator-button-group {
            flex-shrink: 0;
        }
        #poolPage #breedingSimulationSection .simulator-controls label {
            font-size: 0.9em;
            margin-bottom: 4px;
        }
        #poolPage #breedingSimulationSection #selectSire,
        #poolPage #breedingSimulationSection #selectDam {
            padding-top: 8px;
            padding-bottom: 8px;
            margin-bottom: 0;
            font-size: 0.95em;
        }
        #poolPage #breedingSimulationSection #breedButton {
            padding: 8px 18px;
            margin-bottom: 0;
        }
        #poolPage #offspringResult {
            padding: 20px;
            margin-top: 25px;
            background-color: var(--inline-form-bg);
            border: 1px solid var(--border-color-light);
            border-radius: 5px;
        }
        #poolPage #offspringResult h4 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.3em;
            color: var(--heading-color);
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
        }
        #poolPage #offspringResult .form-group { margin-bottom: 20px; }
        #poolPage #offspringResult .form-group label { font-size: 0.95em; }
        #poolPage #offspringResult p { font-size: 0.95em; margin: 5px 0; }
        #poolPage #offspringResult p strong { min-width: 110px; display: inline-block; }
        #poolPage #offspringResult .stars { font-size: 1em; margin-left: 3px; }
        #poolPage #offspringResult div[style*="text-align: center"] { margin-top: 25px; }
         /* --- End Breeding Simulator Specific Styling --- */

        #breedsPage .breeding-record-card { border: 1px solid var(--border-color-dark); border-radius: 6px; margin-bottom: 25px; padding: 25px; background-color: var(--card-bg); box-shadow: 0 2px 8px var(--card-shadow); }
        #breedsPage .record-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(290px, 1fr)); gap: 30px; }
        #breedsPage .parent-section, #breedsPage .offspring-section { border: 1px solid var(--border-color); padding: 20px; border-radius: 5px; background-color: var(--card-bg); display: flex; flex-direction: column; box-shadow: inset 0 1px 2px var(--card-shadow); }
        #breedsPage .parent-section h3, #breedsPage .offspring-section h3 { margin-top: 0; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color-light); text-align: left; font-size: 1.25em; color: #007bff; font-weight: 600;}
        body.dark-mode #breedsPage .parent-section h3, body.dark-mode #breedsPage .offspring-section h3 { color: #58a6ff; }
        #breedsPage .horse-details { flex-grow: 1; margin-bottom: 15px; }
        #breedsPage p { margin: 6px 0; font-size: 0.9em; color: var(--text-color); }
        #breedsPage strong { display: inline-block; min-width: 95px; font-weight: 600; color: var(--heading-color); opacity: 0.9; margin-right: 5px; }
        #breedsPage .no-records { text-align: center; color: var(--text-color); opacity: 0.7; margin-top: 25px; font-style: italic; padding: 20px; }
        #breedsPage .edit-parent-button, #breedsPage .edit-offspring-button { align-self: center; margin-top: auto; }
        #breedsPage .inline-edit-form { margin-top: 15px; border-top: 1px dashed var(--border-color); padding-top: 15px; background-color: var(--inline-form-bg); padding: 15px; border-radius: 4px; margin-bottom: 15px;}
        #breedsPage .inline-edit-form label { font-size: 0.9em; font-weight: 500; margin-bottom: 4px; color: var(--text-color); }
        #breedsPage .inline-edit-form select, #breedsPage .inline-edit-form input { font-size: 0.9em; padding: 7px 9px; margin-bottom: 12px; background-color: var(--input-bg); color: var(--input-color); border-color: var(--input-border); }
        #breedsPage .inline-edit-buttons { text-align: center; margin-top: 10px; }
        #breedsPage .forged-label { font-size:0.8em; color:#dc3745; font-style: italic; font-weight: bold; margin-left: 5px;}
        #breedsPage .clickable-horse-name { color: var(--link-color); cursor: pointer; text-decoration: underline; font-weight: bold; }
        #breedsPage .clickable-horse-name:hover { color: var(--link-hover-color); }
        #breedsPage .non-clickable-name { font-style: italic; opacity: 0.8; }
        #lineagePage #lineageDisplayArea { margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        #lineagePage .no-lineage { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; white-space: normal; text-align: center; color: var(--text-color); opacity: 0.7; padding: 20px; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 5px; grid-column: 1 / -1; }
        #lineagePage .lineage-family-card { background-color: var(--card-bg); border: 1px solid var(--border-color-dark); border-radius: 6px; padding: 15px; margin-bottom: 0; box-shadow: 0 1px 3px var(--card-shadow); font-size: 0.9em; }
        #lineagePage .lineage-family-card h4 { margin-top: 0; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color-light); color: var(--heading-color); font-size: 1.1em; }
        #lineagePage .lineage-parent { margin-bottom: 10px; }
        #lineagePage .lineage-parent span:first-child { font-weight: bold; }
        #lineagePage .lineage-parent-extra-details {
            font-size: 0.85em;
            opacity: 0.9;
            margin-left: 10px;
            margin-top: 3px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        #lineagePage .lineage-parent-extra-details span { white-space: nowrap; }
        #lineagePage .lineage-parent-extra-details .stars { font-size: 1em; margin-left: 2px;}
        #lineagePage .lineage-offspring { padding-left: 15px; margin-bottom: 5px; line-height: 1.4;}
        #lineagePage .lineage-offspring span:first-child { font-weight: bold; }
        #lineagePage .lineage-offspring .forged-label, #lineagePage .lineage-parent .forged-label { font-size: 0.75em; }
        #lineagePage .lineage-offspring-details { font-size: 0.85em; opacity: 0.8; margin-left: 5px; font-style: italic; }
        .stars { white-space: nowrap; color: var(--stars-color); }
        #scrollTopBtn { display: none; position: fixed; bottom: 25px; right: 30px; z-index: 1000; border: none; outline: none; background-color: var(--scroll-btn-bg); color: white; cursor: pointer; padding: 12px 15px; border-radius: 5px; font-size: 0.95em; opacity: 0.8; transition: background-color 0.3s ease, opacity 0.3s ease; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3); }
        #scrollTopBtn:hover { background-color: var(--scroll-btn-hover-bg); opacity: 1; }

        /* Modal Styling */
        .modal {
            position: fixed; z-index: 1005; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6); display: flex;
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: var(--card-bg); color: var(--text-color); margin: auto;
            padding: 25px 30px; border: 1px solid var(--border-color-dark);
            border-radius: 8px; width: 80%; max-width: 700px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative;
        }
        .modal-content h2 { margin-top: 0; text-align: left; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .close-button { color: var(--text-color); float: right; font-size: 28px; font-weight: bold; line-height: 1; }
        .close-button:hover, .close-button:focus { color: #dc3745; text-decoration: none; cursor: pointer; }
        .modal-actions { margin-top: 25px; text-align: right; }
        .modal-actions button { margin-left: 10px; }
        #csvPreviewContent {
            max-height: 60vh; overflow-y: auto; border: 1px solid var(--border-color-light);
            padding: 15px; border-radius: 4px; background-color: var(--inline-form-bg);
        }
        .csv-preview-grid .horse-changes { border-bottom: 1px dashed var(--border-color); padding-bottom: 15px; margin-bottom: 15px; }
        .csv-preview-grid .horse-changes:last-child { border-bottom: none; margin-bottom: 0; }
        .csv-preview-grid h4 { margin-top: 0; margin-bottom: 10px; color: var(--link-color); font-size: 1.2em; }
        .csv-preview-grid h4 .duplicate-notice { color: #17a2b8; font-style: italic; font-weight: normal; font-size: 0.9em;}
        .csv-preview-grid p { margin: 3px 0; font-size: 0.9em; }
        .csv-preview-grid .change-highlight { font-weight: bold; color: #28a745; }
        body.dark-mode .csv-preview-grid .change-highlight { color: #3dd563; }
        .csv-preview-grid .value-arrow { margin: 0 5px; }

        /* Backfill Race IDs Styling */
        #backfillRaceIdsSection { /* Ensure it's block when not hidden */
            /* display: block;  profile-section already makes it block */
            /* other styles are inherited from .profile-section */
            /* The style `grid-column: 1 / -1;` might be an issue if the parent is not a grid when horseProfileDisplay is hidden. */
            /* Let's ensure it's not part of a grid that might collapse it, by overriding grid-column if necessary. */
        }
        #backfillRaceIdsSection:not(.hidden) { /* When it's meant to be visible */
            display: block !important; /* Force display block */
            grid-column: auto !important; /* Override grid-column if it was causing issues */
            width: 100%; /* Ensure it takes full width available */
        }

        #backfillRaceIdsSection.hidden { /* This is already in global styles but reiterate for clarity */
            display: none !important;
        }
        #backfillRaceIdsSection .race-entry-backfill {
            border: 1px solid var(--border-color-light);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            background-color: var(--inline-form-bg);
        }
        #backfillRaceIdsSection .form-group-inline {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        #backfillRaceIdsSection .form-group-inline:last-child {
            margin-bottom: 0;
        }
        #backfillRaceIdsSection .form-group-inline label {
            margin-bottom: 0;
            flex-basis: 180px;
            flex-shrink: 0;
            font-size: 0.85em;
            font-weight: normal;
            opacity: 0.8;
        }
        #backfillRaceIdsSection .form-group-inline input[type="text"] {
            flex-grow: 1;
            padding: 6px 10px;
            font-size: 0.9em;
            margin-bottom: 0;
            width: auto;
        }
        #backfillRaceIdsSection .backfill-date,
        #backfillRaceIdsSection .backfill-timeofday {
             flex-basis: 120px !important;
        }
        #backfillRaceIdsSection .backfill-finishtime {
            flex-basis: 150px !important;
        }
         #backfillRaceIdsSection .backfill-raceid {
            flex-basis: 180px !important;
        }


        /* Chart.js Tooltip specific styling for Dark Mode */
        body.dark-mode .chartjs-tooltip { background: rgba(30, 30, 30, 0.9); }
        body.dark-mode .chartjs-tooltip .chartjs-tooltip-title,
        body.dark-mode .chartjs-tooltip .chartjs-tooltip-body,
        body.dark-mode .chartjs-tooltip .chartjs-tooltip-body li span {
             color: var(--text-color) !important;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>
    <div class="page-container">
        <div class="theme-switch-wrapper">
            <em>Dark Mode:</em>
            <label class="theme-switch" for="darkModeToggle"><input type="checkbox" id="darkModeToggle" /><div class="slider round"></div></label>
        </div>
        <p class="app-title">Stable Manager</p>
        <h1></h1>
        <div class="nav-links">
            <button class="button-link" onclick="showPage('overviewPage')">Overview</button>
            <button class="button-link" onclick="showPage('poolPage')">Pool</button>
            <button class="button-link" onclick="showPage('breedsPage')">Records</button>
            <button class="button-link" onclick="showPage('lineagePage')">Lineage</button>
            <button class="button-link" onclick="showPage('financialsPage')">Financials</button>
            <input type="file" id="importFile" accept=".json" style="display: none;">
            <button class="button-link btn-io" onclick="document.getElementById('importFile').click();">Import Data (JSON)</button>
            <button class="button-link btn-io" onclick="exportData()">Export Data</button>
            <input type="file" id="importRaceCsvFile" accept=".csv" style="display: none;">
            <button class="button-link btn-io" onclick="document.getElementById('importRaceCsvFile').click();">Import Race Data (CSV)</button>
            <button id="undoCsvImportBtn" class="button-link btn-warning hidden">Undo Last CSV Import</button>
            <button class="button-link btn-success" onclick="showDetailPage('ADD_NEW')">Add New Item</button>
        </div>

        <!-- CSV Import Preview Modal -->
        <div id="csvPreviewModal" class="modal hidden">
            <div class="modal-content">
                <span class="close-button" onclick="closeCsvPreviewModal()">&times;</span>
                <h2>CSV Import Preview</h2>
                <p>The following changes will be applied. Review carefully.</p>
                <div id="csvPreviewContent" class="csv-preview-grid">
                    {/* Preview data will be dynamically inserted here */}
                </div>
                <div class="modal-actions">
                    <button id="confirmCsvImportBtn" class="btn-success">Confirm Import</button>
                    <button onclick="closeCsvPreviewModal()" class="btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="overviewPage" class="page-view">
            <h2>Stable Overview</h2>
            <div style="overflow-x: auto;"><table id="horseTable"><thead><tr><th></th><th>Name</th><th>Gen</th><th>Gender</th><th>Breed</th><th>Overall</th><th>Speed</th><th>Sprint</th><th>Endurance</th><th>Races</th><th>Places</th><th>Cost</th><th>Current Balance</th><th>Overall P/L</th><th>Actions</th></tr></thead><tbody id="horseTableBody"></tbody></table></div>
        </div>
        <div id="detailPage" class="page-view hidden">
             <div class="page-container-inner">
                 <button class="button-link btn-secondary" style="margin-bottom:15px;" onclick="showPage('overviewPage')">← Back to Overview</button>
                 <label for="horseSelector">Select Item:</label>
                 <select id="horseSelector"><option value="">-- Select an Item --</option></select>
                 <div id="mainActions">
                     <button id="prevHorseBtn" class="hidden">← Previous</button>
                     <button id="editButton" class="btn-warning hidden">Edit Selected</button>
                     <button id="sendToBreedingPoolButton" class="btn-info hidden">Send to Pool</button>
                     <button id="forgeButton" class="btn-danger hidden">Forge</button>
                     <button id="nextHorseBtn" class="hidden">Next →</button>
                 </div>
                 <div id="horseProfileDisplay" class="hidden">
                     <h2 id="profileName"></h2>
                     <div class="profile-grid">
                         <div class="profile-section" id="basicInfo"><h3>Basic Info</h3><p><strong>Generation:</strong> <span id="displayGen"></span></p><p><strong>Gender:</strong> <span id="displayGender"></span></p><p><strong>Breed:</strong> <span id="displayBreed"></span></p><p><strong>Colour Trait:</strong> <span id="displayColourTrait"></span></p></div>
                         <div class="profile-section" id="stats"><h3>Stats</h3><p><strong>Overall:</strong><br><span id="displayOverall" class="stars"></span></p><p><strong>Speed:</strong><br><span id="displaySpeed" class="stars"></span></p><p><strong>Sprint:</strong><br><span id="displaySprint" class="stars"></span></p><p><strong>Endurance:</strong><br><span id="displayEndurance" class="stars"></span></p></div>
                         <div class="profile-section" id="raceRecord">
                             <h3>Race Record</h3>
                             <p><strong>Races:</strong> <span id="displayRaces"></span></p>
                             <p><strong>1st:</strong> <span id="displayFirst"></span></p>
                             <p><strong>2nd:</strong> <span id="displaySecond"></span></p>
                             <p><strong>3rd:</strong> <span id="displayThird"></span></p>
                             <p><strong>Places:</strong> <span id="displayPlaces"></span></p>
                             <p><strong>Fastest Time:</strong> <span id="displayFastestTime"></span></p>
                             <p><strong>Slowest Time:</strong> <span id="displaySlowestTime"></span></p>
                             <p><strong>Avg Race Time:</strong> <span id="displayAvgRaceTime"></span></p>
                         </div>
                         <div class="profile-section" id="pedigree"><h3>Pedigree</h3><p><strong>Sire Name:</strong> <span id="displaySireName"></span></p><p><strong>Sire Breed:</strong> <span id="displaySireBreed"></span></p><p><strong>Sire Colour:</strong> <span id="displaySireColourTrait"></span></p><p><strong>Dam Name:</strong> <span id="displayDamName"></span></p><p><strong>Dam Breed:</strong> <span id="displayDamBreed"></span></p><p><strong>Dam Colour:</strong> <span id="displayDamColourTrait"></span></p></div>
                         <div class="profile-section" id="augments"><h3>Augments</h3><p><strong>CPU:</strong><br><span id="displayCPU"></span></p><p><strong>RAM:</strong><br><span id="displayRAM"></span></p><p><strong>Hydraulic:</strong><br><span id="displayHydraulic"></span></p></div>
                         <div class="profile-section" id="financials">
                             <h3>Financials</h3>
                             <p><strong>Cost (Asset - ZED):</strong> <span id="displayBreedCost"></span></p>
                             <p><strong>Starting Balance (Derived):</strong> <span id="displayStrtZedBal"></span></p>
                             <p><strong>Total Race Net P/L:</strong> <span id="displayTotalRaceNetPL"></span></p>
                             <p><strong>Current Balance (ZED):</strong> <span id="displayZedBalance"></span></p>
                             <p><strong>Total Value Sold (ZED):</strong> <span id="displaySoldBreeds"></span></p>
                             <p><strong>Overall P/L (ZED):</strong> <span id="displayROI"></span></p>
                        </div>
                     </div>
                     <div id="race1TimeChartContainer" class="profile-section hidden" style="grid-column: 1 / -1;">
                        <h3>Race Times History</h3>
                        <canvas id="race1TimeChartCanvas"></canvas>
                        <p id="race1ChartNoDataMessage" class="hidden"></p>
                     </div>
                     <div id="zedBalanceChartContainer" class="profile-section hidden" style="grid-column: 1 / -1;">
                        <h3>ZED Balance History</h3>
                        <canvas id="zedBalanceChartCanvas"></canvas>
                        <p id="zedBalanceChartNoDataMessage" class="hidden">No ZED Balance history to display.</p>
                     </div>
                     <div style="margin-top: 20px; text-align: center;">
                        <button id="manageRaceIdsBtn" class="btn-info">Manage Historical Race Data</button>
                    </div>
                 </div>
                 <div id="backfillRaceIdsSection" class="profile-section hidden" style="margin-top:20px;"> {/* Removed grid-column here */}
                    <h3>Edit Historical Race Data for <span id="backfillHorseName"></span></h3>
                    <p>Modify race details or add missing Race IDs. Dates should be MM/DD/YYYY, Times HH:MM (24-hour).</p>
                    <div id="backfillRaceListContainer">
                        {/* Entries will be populated here by JS */}
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button id="saveBackfilledRaceIdsBtn" class="btn-success">Save Changes</button>
                        <button type="button" onclick="closeBackfillSection()" class="btn-secondary">Cancel</button>
                    </div>
                </div>
                 <div id="horseForm" class="hidden">
                     <h2 id="formTitle"></h2>
                     <form id="editAddForm">
                         <input type="hidden" id="horseIdInput">
                         <div class="form-grid">
                            <div class="form-group"><label for="inputName">Name:</label><input type="text" id="inputName" required></div>
                            <div class="form-group"><label for="inputGen">Generation:</label><select id="inputGen"><option>G0</option><option>G1</option><option>G2</option><option>G3</option><option>G4</option><option>G5</option></select></div>
                            <div class="form-group"><label for="inputGender">Gender:</label><select id="inputGender"><option>M</option><option>F</option></select></div>
                            <div class="form-group"><label for="inputBreed">Breed:</label><select id="inputBreed"><option>Nakamoto</option><option>Szabo</option><option>Finney</option><option>Buterin</option></select></div>
                            <div class="form-group"><label for="inputColourTrait">Colour Trait:</label><select id="inputColourTrait"><option>Nakamoto</option><option>Szabo</option><option>Finney</option><option>Buterin</option></select></div>
                            <div class="form-group"><label for="inputOverall">Overall:</label><select id="inputOverall"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputSpeed">Speed:</label><select id="inputSpeed"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputSprint">Sprint:</label><select id="inputSprint"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputEndurance">Endurance:</label><select id="inputEndurance"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputSireName">Sire Name:</label><input type="text" id="inputSireName"></div>
                            <div class="form-group">
                                <label for="inputSireGen">Sire Generation:</label>
                                <select id="inputSireGen">
                                    <option value="">Unknown</option><option>G0</option><option>G1</option><option>G2</option><option>G3</option><option>G4</option><option>G5</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="inputSireBreed">Sire Breed:</label><select id="inputSireBreed"><option value="">Unknown</option><option>Nakamoto</option><option>Szabo</option><option>Finney</option><option>Buterin</option></select></div>
                            <div class="form-group"><label for="inputSireColourTrait">Sire Colour Trait:</label><select id="inputSireColourTrait"><option value="">Unknown</option><option>Nakamoto</option><option>Szabo</option><option>Finney</option><option>Buterin</option></select></div>
                            <div class="form-group"><label for="inputSireOverall">Sire Overall:</label><select id="inputSireOverall"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputSireSpeed">Sire Speed:</label><select id="inputSireSpeed"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputSireSprint">Sire Sprint:</label><select id="inputSireSprint"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputSireEndurance">Sire Endurance:</label><select id="inputSireEndurance"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputDamName">Dam Name:</label><input type="text" id="inputDamName"></div>
                             <div class="form-group">
                                <label for="inputDamGen">Dam Generation:</label>
                                <select id="inputDamGen">
                                    <option value="">Unknown</option><option>G0</option><option>G1</option><option>G2</option><option>G3</option><option>G4</option><option>G5</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="inputDamBreed">Dam Breed:</label><select id="inputDamBreed"><option value="">Unknown</option><option>Nakamoto</option><option>Szabo</option><option>Finney</option><option>Buterin</option></select></div>
                            <div class="form-group"><label for="inputDamColourTrait">Dam Colour Trait:</label><select id="inputDamColourTrait"><option value="">Unknown</option><option>Nakamoto</option><option>Szabo</option><option>Finney</option><option>Buterin</option></select></div>
                            <div class="form-group"><label for="inputDamOverall">Dam Overall:</label><select id="inputDamOverall"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputDamSpeed">Dam Speed:</label><select id="inputDamSpeed"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputDamSprint">Dam Sprint:</label><select id="inputDamSprint"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputDamEndurance">Dam Endurance:</label><select id="inputDamEndurance"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputRaces">Races:</label><input type="number" id="inputRaces" min="0" value="0"></div>
                            <div class="form-group"><label for="inputFirst">1st:</label><input type="number" id="inputFirst" min="0" value="0"></div>
                            <div class="form-group"><label for="inputSecond">2nd:</label><input type="number" id="inputSecond" min="0" value="0"></div>
                            <div class="form-group"><label for="inputThird">3rd:</label><input type="number" id="inputThird" min="0" value="0"></div>
                            <div class="form-group"><label for="inputCPU">CPU:</label><select id="inputCPU"><option>Void C100</option><option>Crimson</option><option>GX-Core C</option><option>Darklight 100C</option><option>Midnight 100C</option></select></div>
                            <div class="form-group"><label for="inputRAM">RAM:</label><select id="inputRAM"><option>Void R100</option><option>Crimson R</option><option>GX-Core R</option><option>Darklight 100R</option><option>Midnight 100R</option></select></div>
                            <div class="form-group"><label for="inputHydraulic">Hydraulic:</label><select id="inputHydraulic"><option>Void H100</option><option>Crimson H</option><option>GX - Core H</option><option>Darklight 100H</option><option>Midnight 100H</option></select></div>
                            <div class="form-group"><label for="inputBreedCost">Cost (Asset - ZED):</label><input type="text" id="inputBreedCost"></div>
                            <div class="form-group hidden" id="inputZedBalanceGroup"><label for="inputZedBalance">Current Horse Balance (ZED):</label><input type="text" id="inputZedBalance"></div>
                            <div class="form-group"><label for="inputSoldBreeds">Add Sale Value (ZED):</label><input type="text" id="inputSoldBreeds" placeholder="Enter value of this sale"></div>
                           </div>
                           <div style="text-align: center; margin-top: 20px;">
                               <button type="submit" id="saveChangesButton" class="btn-primary">Save Changes</button>
                               <button type="submit" id="saveNewButton" class="btn-primary">Save New Item</button>
                               <button type="button" id="cancelButton" class="btn-secondary">Cancel</button>
                           </div>
                       </form>
                   </div>
             </div>
        </div>
        <div id="poolPage" class="page-view hidden">
            <h2>Breeding Pool & Simulator</h2>
            <div id="breedingSimulationSection">
                <h3>Breeding Simulator</h3>
                <div class="simulator-controls">
                    <div class="simulator-select-group">
                        <label for="selectSire">Select Sire:</label>
                        <select id="selectSire"><option value="">-- Select Sire --</option></select>
                    </div>
                    <div class="simulator-select-group">
                        <label for="selectDam">Select Dam:</label>
                        <select id="selectDam"><option value="">-- Select Dam --</option></select>
                    </div>
                    <div class="simulator-button-group">
                        <button id="breedButton" class="btn-primary" disabled>Simulate</button>
                    </div>
                </div>
                <div id="offspringResult" class="hidden">
                    <h4>Simulated Offspring</h4>
                     <div class="form-group"><label for="inputOffspringName">Offspring Name:</label><input type="text" id="inputOffspringName" placeholder="Enter a unique name" required></div>
                     <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px 20px;"><p><strong>Generation:</strong> <span id="offspringGen"></span></p><p><strong>Gender:</strong> <span id="offspringGender"></span></p><p><strong>Breed:</strong> <span id="offspringBreed"></span></p><p><strong>Colour Trait:</strong> <span id="offspringColourTrait"></span></p><p><strong>Overall:</strong> <span id="offspringOverall" class="stars"></span></p><p><strong>Speed:</strong> <span id="offspringSpeed" class="stars"></span></p><p><strong>Sprint:</strong> <span id="offspringSprint" class="stars"></span></p><p><strong>Endurance:</strong> <span id="offspringEndurance" class="stars"></span></p><p><strong>Sire:</strong> <span id="offspringSireName"></span></p><p><strong>Dam:</strong> <span id="offspringDamName"></span></p></div>
                     <div style="text-align: center; margin-top: 20px;"><button id="addOffspringButton" class="btn-success">Add Offspring</button><button type="button" class="btn-secondary" onclick="cancelOffspring()">Cancel</button></div>
                </div>
            </div>
            <section id="siresSection"><h3>Sires in Pool</h3><div id="siresList" class="horse-list"><p class="no-horses"></p></div></section>
            <section id="damsSection"><h3>Dams in Pool</h3><div id="damsList" class="horse-list"><p class="no-horses"></p></div></section>
        </div>
        <div id="breedsPage" class="page-view hidden">
            <h2>Breeding Records</h2>
            <div id="breedingRecordsList"><p class="no-records"></p></div>
        </div>
        <div id="lineagePage" class="page-view hidden">
            <h2>Lineage Viewer</h2><div id="lineageDisplayArea"><p class="no-lineage"></p></div>
        </div>
        <div id="financialsPage" class="page-view hidden">
            <h2>Financials Overview</h2>
             <div style="overflow-x: auto;"><table id="financialsTable"><thead><tr><th>Name</th><th>Cost</th><th>Starting Balance</th><th>Current Balance</th><th>Total Value Sold</th><th>Overall P/L</th></tr></thead><tbody id="financialsTableBody"></tbody><tfoot id="financialsTableFooter"></tfoot></table></div>
        </div>
        <button id="scrollTopBtn" title="Go to top">↑ Top</button>
    </div>

    <!-- START OF MAIN JAVASCRIPT -->
    <script>
        // ========================================================================
        // == GLOBAL VARIABLES & CONSTANTS ==
        // ========================================================================
        let horsesData = [];
        let nextId = 1;
        let currentDetailHorseId = null;
        let race1TimeChartInstance = null;
        let zedBalanceChartInstance = null;
        let tempOffspringData = null;
        const STORAGE_KEY = 'templateDataStorage';
        const defaultHorsesData = [];
        let horsesDataBackupBeforeCsv = null;
        let stagedCsvChanges = [];

        // --- DOM Element References ---
        const overviewPage = document.getElementById('overviewPage');
        const detailPage = document.getElementById('detailPage');
        const poolPage = document.getElementById('poolPage');
        const breedsPage = document.getElementById('breedsPage');
        const lineagePage = document.getElementById('lineagePage');
        const financialsPage = document.getElementById('financialsPage');
        const allPages = [overviewPage, detailPage, poolPage, breedsPage, lineagePage, financialsPage].filter(p => p);
        const navButtons = document.querySelectorAll('.nav-links .button-link[onclick^="showPage"]');
        const horseTableBody = document.getElementById('horseTableBody');
        const horseSelector = document.getElementById('horseSelector');
        const mainActionsDiv = document.getElementById('mainActions');
        const editButton = document.getElementById('editButton');
        const sendToBreedingPoolButton = document.getElementById('sendToBreedingPoolButton');
        const forgeButton = document.getElementById('forgeButton');
        const prevHorseBtn = document.getElementById('prevHorseBtn');
        const nextHorseBtn = document.getElementById('nextHorseBtn');
        const horseProfileDisplayDiv = document.getElementById('horseProfileDisplay');
        const profileName = document.getElementById('profileName');
        const displayGen = document.getElementById('displayGen');
        const displayGender = document.getElementById('displayGender');
        const displayBreed = document.getElementById('displayBreed');
        const displayColourTrait = document.getElementById('displayColourTrait');
        const displaySireName = document.getElementById('displaySireName');
        const displaySireBreed = document.getElementById('displaySireBreed');
        const displaySireColourTrait = document.getElementById('displaySireColourTrait');
        const displayDamName = document.getElementById('displayDamName');
        const displayDamBreed = document.getElementById('displayDamBreed');
        const displayDamColourTrait = document.getElementById('displayDamColourTrait');
        const displayOverall = document.getElementById('displayOverall');
        const displaySpeed = document.getElementById('displaySpeed');
        const displaySprint = document.getElementById('displaySprint');
        const displayEndurance = document.getElementById('displayEndurance');
        const displayRaces = document.getElementById('displayRaces');
        const displayFirst = document.getElementById('displayFirst');
        const displaySecond = document.getElementById('displaySecond');
        const displayThird = document.getElementById('displayThird');
        const displayPlaces = document.getElementById('displayPlaces');
        const displayFastestTime = document.getElementById('displayFastestTime');
        const displaySlowestTime = document.getElementById('displaySlowestTime');
        const displayAvgRaceTime = document.getElementById('displayAvgRaceTime');
        const displayCPU = document.getElementById('displayCPU');
        const displayRAM = document.getElementById('displayRAM');
        const displayHydraulic = document.getElementById('displayHydraulic');
        const displayBreedCost = document.getElementById('displayBreedCost');
        const displayStrtZedBal = document.getElementById('displayStrtZedBal');
        const displayTotalRaceNetPL = document.getElementById('displayTotalRaceNetPL');
        const displayZedBalance = document.getElementById('displayZedBalance');
        const displaySoldBreeds = document.getElementById('displaySoldBreeds');
        const displayROI = document.getElementById('displayROI');
        const horseFormDiv = document.getElementById('horseForm');
        const formTitle = document.getElementById('formTitle');
        const editAddForm = document.getElementById('editAddForm');
        const horseIdInput = document.getElementById('horseIdInput');
        const inputName = document.getElementById('inputName');
        const inputGen = document.getElementById('inputGen');
        const inputGender = document.getElementById('inputGender');
        const inputBreed = document.getElementById('inputBreed');
        const inputColourTrait = document.getElementById('inputColourTrait');
        const inputSireName = document.getElementById('inputSireName');
        const inputSireGen = document.getElementById('inputSireGen');
        const inputSireBreed = document.getElementById('inputSireBreed');
        const inputSireColourTrait = document.getElementById('inputSireColourTrait');
        const inputSireOverall = document.getElementById('inputSireOverall');
        const inputSireSpeed = document.getElementById('inputSireSpeed');
        const inputSireSprint = document.getElementById('inputSireSprint');
        const inputSireEndurance = document.getElementById('inputSireEndurance');
        const inputDamName = document.getElementById('inputDamName');
        const inputDamGen = document.getElementById('inputDamGen');
        const inputDamBreed = document.getElementById('inputDamBreed');
        const inputDamColourTrait = document.getElementById('inputDamColourTrait');
        const inputDamOverall = document.getElementById('inputDamOverall');
        const inputDamSpeed = document.getElementById('inputDamSpeed');
        const inputDamSprint = document.getElementById('inputDamSprint');
        const inputDamEndurance = document.getElementById('inputDamEndurance');
        const inputOverall = document.getElementById('inputOverall');
        const inputSpeed = document.getElementById('inputSpeed');
        const inputSprint = document.getElementById('inputSprint');
        const inputEndurance = document.getElementById('inputEndurance');
        const inputRaces = document.getElementById('inputRaces');
        const inputFirst = document.getElementById('inputFirst');
        const inputSecond = document.getElementById('inputSecond');
        const inputThird = document.getElementById('inputThird');
        const inputCPU = document.getElementById('inputCPU');
        const inputRAM = document.getElementById('inputRAM');
        const inputHydraulic = document.getElementById('inputHydraulic');
        const inputBreedCost = document.getElementById('inputBreedCost');
        const inputZedBalanceGroup = document.getElementById('inputZedBalanceGroup');
        const inputZedBalance = document.getElementById('inputZedBalance');
        const inputSoldBreeds = document.getElementById('inputSoldBreeds');
        const saveChangesButton = document.getElementById('saveChangesButton');
        const saveNewButton = document.getElementById('saveNewButton');
        const cancelButton = document.getElementById('cancelButton');
        const siresListElement = document.getElementById('siresList');
        const damsListElement = document.getElementById('damsList');
        const breedingRecordsList = document.getElementById('breedingRecordsList');
        const lineageDisplayArea = document.getElementById('lineageDisplayArea');
        const financialsTableBody = document.getElementById('financialsTableBody');
        const financialsTableFooter = document.getElementById('financialsTableFooter');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const scrollTopButton = document.getElementById('scrollTopBtn');
        const importFileInput = document.getElementById('importFile');
        const importRaceCsvFileInput = document.getElementById('importRaceCsvFile');
        const race1TimeChartCanvas = document.getElementById('race1TimeChartCanvas');
        const race1ChartNoDataMessage = document.getElementById('race1ChartNoDataMessage');
        const zedBalanceChartCanvas = document.getElementById('zedBalanceChartCanvas');
        const zedBalanceChartNoDataMessage = document.getElementById('zedBalanceChartNoDataMessage');
        const selectSire = document.getElementById('selectSire');
        const selectDam = document.getElementById('selectDam');
        const breedButton = document.getElementById('breedButton');
        const offspringResultDiv = document.getElementById('offspringResult');
        const inputOffspringName = document.getElementById('inputOffspringName');
        const offspringGenSpan = document.getElementById('offspringGen');
        const offspringGenderSpan = document.getElementById('offspringGender');
        const offspringBreedSpan = document.getElementById('offspringBreed');
        const offspringColourTraitSpan = document.getElementById('offspringColourTrait');
        const offspringOverallSpan = document.getElementById('offspringOverall');
        const offspringSpeedSpan = document.getElementById('offspringSpeed');
        const offspringSprintSpan = document.getElementById('offspringSprint');
        const offspringEnduranceSpan = document.getElementById('offspringEndurance');
        const offspringSireNameSpan = document.getElementById('offspringSireName');
        const offspringDamNameSpan = document.getElementById('offspringDamName');
        const addOffspringButton = document.getElementById('addOffspringButton');
        const undoCsvImportBtn = document.getElementById('undoCsvImportBtn');
        const csvPreviewModal = document.getElementById('csvPreviewModal');
        const csvPreviewContent = document.getElementById('csvPreviewContent');
        const confirmCsvImportBtn = document.getElementById('confirmCsvImportBtn');
        const manageRaceIdsBtn = document.getElementById('manageRaceIdsBtn');
        const backfillRaceIdsSection = document.getElementById('backfillRaceIdsSection');
        const backfillHorseName = document.getElementById('backfillHorseName');
        const backfillRaceListContainer = document.getElementById('backfillRaceListContainer');
        const saveBackfilledRaceIdsBtn = document.getElementById('saveBackfilledRaceIdsBtn');
        let draggedRow = null;


        // ========================================================================
        // == FUNCTION DEFINITIONS ==
        // ========================================================================

        function parseNumericValue(valueString) { if (typeof valueString !== 'string' && typeof valueString !== 'number') return 0; const cleanedString = String(valueString).replace(/[^\d.-]/g, '').trim(); const value = parseFloat(cleanedString); return isNaN(value) ? 0 : value; }
        function formatNumericValue(value) { return value.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 }); }

        function calculateROI(item) {
            if (item === null || item === undefined) return "N/A";

            const currentHorseBalance = parseNumericValue(item.zedBalance); // Current Balance
            const initialCost = parseNumericValue(item.breedCost); // Cost
            const totalSaleValue = parseNumericValue(item.soldBreeds); // Total Value Sold

            // New Calculation: (Current Balance + (Total Value Sold * 0.05)) - Cost
            const profitFromSalesComponent = totalSaleValue * 0.05; // 5% of Total Value Sold
            const totalProfitLoss = (currentHorseBalance + profitFromSalesComponent) - initialCost;

            return `${(totalProfitLoss >= 0 ? '+' : '')}${totalProfitLoss.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function calculatePlaces(item) { if (!item) return 0; return (parseInt(item.first) || 0) + (parseInt(item.second) || 0) + (parseInt(item.third) || 0); }
        function formatRaceRecord(item) { if (!item || typeof item.races !== 'number' || item.races <= 0) return ''; const races = item.races ?? 0, first = item.first ?? 0, second = item.second ?? 0, third = item.third ?? 0, winPercent = races > 0 ? Math.round((first / races) * 100) : 0; return `<span class="lineage-race-record">[${races} / ${first} - ${second} - ${third} | ${winPercent}%]</span>`; }
        function parseRaceTime(timeString) { if (!timeString || typeof timeString !== 'string') return null; const parts = timeString.split(':'); let seconds = 0; try { if (parts.length === 2) seconds = parseFloat(parts[0]) * 60 + parseFloat(parts[1]); else if (parts.length === 1) seconds = parseFloat(parts[0]); else return null; return isNaN(seconds) ? null : seconds; } catch (e) { console.error("Error parsing race time:", timeString, e); return null; } }
        function parseGen(genString) { if (!genString || typeof genString !== 'string') return 0; const match = genString.match(/G(\d+)/i); return match ? parseInt(match[1], 10) : 0; }
        const starValues = {'-':0, '': 0, '⭐️': 1, '⭐️⭐️': 2, '⭐️⭐️☀️': 2.5, '⭐️⭐️⭐️': 3, '⭐️⭐️⭐️☀️': 3.5, '⭐️⭐️⭐️⭐️': 4, '⭐️⭐️⭐️⭐️☀️': 4.5, '⭐️⭐️⭐️⭐️⭐️': 5};
        const starKeys = Object.keys(starValues).sort((a, b) => starValues[a] - starValues[b]);
        function getStarNumericValue(starString) { return starValues[starString || '-'] || 0; }
        function mapNumericToStars(numericValue) { if (numericValue <= 0) return '-'; let closestStar = '-'; for (let i = starKeys.length - 1; i >= 0; i--) { const key = starKeys[i]; if (key !== '-' && key !== '' && numericValue >= starValues[key]) { closestStar = key; break; } } const lowerBound = starValues[closestStar]; if(closestStar.includes('⭐️') && !closestStar.includes('☀️') && numericValue >= lowerBound + 0.25 && numericValue < lowerBound + 0.75) { const halfStarKey = closestStar + '☀️'; if(starValues.hasOwnProperty(halfStarKey)) return halfStarKey; } return closestStar; }
        function formatSecondsToTime(totalSeconds) { if (totalSeconds === null || isNaN(totalSeconds) || totalSeconds < 0) return "N/A"; const minutes = Math.floor(totalSeconds / 60), seconds = totalSeconds % 60; if (minutes > 0) return `${minutes}:${seconds.toFixed(2).padStart(5, '0')}`; else return `${seconds.toFixed(2).padStart(5, '0')}`; }

        function getCombinedRaceHistory(horse) {
            if (!horse) return [];
            const combined = [];
            if (Array.isArray(horse.race1TimeHistory)) {
                horse.race1TimeHistory.forEach((entry, index) => {
                    combined.push({ ...entry, originalArrayName: 'race1TimeHistory', originalArrayIndex: index });
                });
            }
            if (Array.isArray(horse.race2TimeHistory)) {
                horse.race2TimeHistory.forEach((entry, index) => {
                    combined.push({ ...entry, originalArrayName: 'race2TimeHistory', originalArrayIndex: index });
                });
            }
            return combined.filter(entry => entry && entry.time && parseRaceTime(entry.time) !== null)
                           .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        }

        function calculateFastestTime(horse) {
            const combinedHistory = getCombinedRaceHistory(horse);
            if (combinedHistory.length === 0) return "N/A";
            let fastestSeconds = Infinity;
            combinedHistory.forEach(entry => {
                const timeInSeconds = parseRaceTime(entry.time);
                if (timeInSeconds !== null && timeInSeconds < fastestSeconds) {
                    fastestSeconds = timeInSeconds;
                }
            });
            return fastestSeconds === Infinity ? "N/A" : formatSecondsToTime(fastestSeconds);
        }

        function calculateSlowestTime(horse) {
            const combinedHistory = getCombinedRaceHistory(horse);
            if (combinedHistory.length === 0) return "N/A";
            let slowestSeconds = 0;
            let hasValidTime = false;
            combinedHistory.forEach(entry => {
                const timeInSeconds = parseRaceTime(entry.time);
                if (timeInSeconds !== null) {
                    hasValidTime = true;
                    if (slowestSeconds === 0 || timeInSeconds > slowestSeconds) {
                        slowestSeconds = timeInSeconds;
                    }
                }
            });
            return !hasValidTime ? "N/A" : formatSecondsToTime(slowestSeconds);
        }


        function calculateAverageRaceTime(horse) {
            const combinedHistory = getCombinedRaceHistory(horse);
            if (combinedHistory.length === 0) return "N/A";
            let totalSecondsSum = 0;
            combinedHistory.forEach(entry => {
                const timeInSeconds = parseRaceTime(entry.time);
                if (timeInSeconds !== null) {
                    totalSecondsSum += timeInSeconds;
                }
            });
            return formatSecondsToTime(totalSecondsSum / combinedHistory.length);
        }

        function findIndexById(itemId) { if (itemId === null || itemId === undefined) return -1; const idToFind = parseInt(itemId); if (isNaN(idToFind)) return -1; return horsesData.findIndex(h => h && h.id === idToFind); }
        function findHorseById(itemId) { if (itemId === null || itemId === undefined) return null; const idToFind = parseInt(itemId); if (isNaN(idToFind)) return null; return horsesData.find(h => h && h.id === idToFind); }
        function findHorseByName(name) { if (!name || typeof name !== 'string') return null; const lowerCaseName = name.toLowerCase().trim(); if (lowerCaseName === '') return null; let foundHorse = horsesData.find(h => h && h.name && h.name.toLowerCase().trim() === lowerCaseName && h.status !== 'forged'); if (!foundHorse) foundHorse = horsesData.find(h => h && h.name && h.name.toLowerCase().trim() === lowerCaseName); return foundHorse; }
        function getNavigableHorses() { return horsesData.filter(h => h && h.status !== 'forged').sort((a, b) => a.name.localeCompare(b.name)); }

        function saveHorsesData() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(horsesData)); } catch (e) { console.error("Save Error:", e); alert("Could not save data."); } }
        function loadHorsesData() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            let dataToUse = defaultHorsesData;
            if (storedData) {
                try {
                    let parsedData = JSON.parse(storedData);
                    if (Array.isArray(parsedData)) dataToUse = parsedData;
                    else { console.warn("Stored data invalid."); dataToUse = []; }
                } catch (e) { console.error("Parse Error:", e); dataToUse = []; }
            } else { console.log("No stored data found."); dataToUse = []; }
            let maxId = 0, updated = false;
            dataToUse = Array.isArray(dataToUse) ? dataToUse.filter(h => h && typeof h === 'object') : [];
            dataToUse.forEach((h, index) => {
                if (h.id && typeof h.id === 'number' && h.id > maxId) maxId = h.id;
                if (!h.hasOwnProperty('status')) { h.status = 'active'; updated = true; }
                if (!h.hasOwnProperty('order') || typeof h.order !== 'number') { h.order = index; updated = true; }
                if (!h.hasOwnProperty('name')) { h.name = 'Unnamed'; updated = true; }
                if (!h.hasOwnProperty('race1TimeHistory') || !Array.isArray(h.race1TimeHistory)) { h.race1TimeHistory = []; updated = true; }
                if (!h.hasOwnProperty('race2TimeHistory') || !Array.isArray(h.race2TimeHistory)) { h.race2TimeHistory = []; updated = true; }
                if (!h.hasOwnProperty('augmentHistory') || !Array.isArray(h.augmentHistory)) { h.augmentHistory = []; updated = true; }
                if (!h.hasOwnProperty('zedBalanceHistory') || !Array.isArray(h.zedBalanceHistory)) { h.zedBalanceHistory = []; updated = true; }
                if (!h.hasOwnProperty('processedCsvRaceEvents') || !Array.isArray(h.processedCsvRaceEvents)) { h.processedCsvRaceEvents = []; updated = true; }
                ['races', 'first', 'second', 'third'].forEach(field => { if (!h.hasOwnProperty(field) || typeof h[field] !== 'number' || isNaN(h[field])) { h[field] = 0; updated = true; } });

                // Financial field initialization and migration
                ['breedCost', 'strtZedBal', 'zedBalance', 'soldBreeds', 'totalRaceNetPL'].forEach(field => {
                    if (!h.hasOwnProperty(field)) {
                        if (field === 'totalRaceNetPL') h[field] = "0";
                        else if (field === 'breedCost' || field === 'soldBreeds') h[field] = ""; // Cost/Sales can be empty
                        else h[field] = "0"; // Balances default to "0" if completely missing
                        updated = true;
                    } else if (typeof h[field] === 'number') { // Ensure stored as string
                        h[field] = String(h[field]);
                        updated = true;
                    }
                });
                // Recalculate strtZedBal based on breedCost if it seems inconsistent or missing (for old data)
                if (h.breedCost) {
                    const expectedStrtZedBal = formatNumericValue(parseNumericValue(h.breedCost) / 2);
                    if (h.strtZedBal !== expectedStrtZedBal) { // Check if it needs update or was never set right
                        h.strtZedBal = expectedStrtZedBal;
                        updated = true;
                    }
                } else { // If no breedCost, strtZedBal should be 0
                    if (h.strtZedBal !== "0") { h.strtZedBal = "0"; updated = true; }
                }
                // Initialize zedBalance based on strtZedBal and totalRaceNetPL if it appears to be from an older format or missing
                if (!h.zedBalance || h.zedBalance.trim() === "") { // If zedBalance is missing or empty
                    h.zedBalance = formatNumericValue(parseNumericValue(h.strtZedBal || "0") + parseNumericValue(h.totalRaceNetPL || "0"));
                    updated = true;
                    console.log(`Horse ${h.name || 'ID ' + h.id}: Initialized/Migrated zedBalance to ${h.zedBalance}`);
                }


                const optionalFields = [
                    'gen', 'gender', 'breed', 'colourTrait',
                    'sireName', 'sireGen', 'sireBreed', 'sireColourTrait', 'sireOverall', 'sireSpeed', 'sireSprint', 'sireEndurance',
                    'damName', 'damGen', 'damBreed', 'damColourTrait', 'damOverall', 'damSpeed', 'damSprint', 'damEndurance',
                    'overall', 'speed', 'sprint', 'endurance', 'race1Time', 'race2Time', 'cpu', 'ram', 'hydraulic'
                ];
                optionalFields.forEach(field => {
                    if (!h.hasOwnProperty(field)) {
                        if (field.includes('Overall') || field.includes('Speed') || field.includes('Sprint') || field.includes('Endurance')) h[field] = "-";
                        else if (field === 'sireGen' || field === 'damGen') h[field] = "";
                        else h[field] = null;
                        updated = true;
                    }
                });
            });
            nextId = maxId + 1;
            dataToUse.forEach(h => { if (!h.id || typeof h.id !== 'number') { h.id = nextId++; updated = true; } });
            horsesData = dataToUse;
            if (updated) { console.log("Saving processed data after load migrations."); saveHorsesData(); }
        }
        function exportData() { try { const dataStr = JSON.stringify(horsesData, null, 2); const blob = new Blob([dataStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; const date = new Date(); link.download = `template_data_${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); alert("Data exported!"); } catch (e) { console.error("Export Error:", e); alert("Error exporting data."); } }
        function importData(event) { const file = event.target.files[0]; if (!file) return; if (!file.name.endsWith('.json')) { alert("Select JSON file."); event.target.value = null; return; } const reader = new FileReader(); reader.onload = function(e) { try { const importedData = JSON.parse(e.target.result); if (!Array.isArray(importedData)) throw new Error("Not a valid array."); if (!importedData.every(item => typeof item === 'object' && item !== null && item.hasOwnProperty('id') && item.hasOwnProperty('name'))) throw new Error("Invalid structure."); if (window.confirm("OVERWRITE current data?")) { horsesData = importedData; saveHorsesData(); loadHorsesData(); alert("Imported! Refreshing."); const currentPage = allPages.find(page => page && !page.classList.contains('hidden')); showPage(currentPage ? currentPage.id : 'overviewPage'); } } catch (error) { console.error("Import Error:", error); alert(`Import Error: ${error.message}`); } finally { event.target.value = null; } }; reader.onerror = function(e) { console.error("File Read Error:", e); alert("Error reading file."); event.target.value = null; }; reader.readAsText(file); }

        function showPage(pageId) {
             if (race1TimeChartInstance && pageId !== 'detailPage') { race1TimeChartInstance.destroy(); race1TimeChartInstance = null; if(document.getElementById('race1TimeChartContainer')) document.getElementById('race1TimeChartContainer').classList.add('hidden'); }
             if (zedBalanceChartInstance && pageId !== 'detailPage') { zedBalanceChartInstance.destroy(); zedBalanceChartInstance = null; if(document.getElementById('zedBalanceChartContainer')) document.getElementById('zedBalanceChartContainer').classList.add('hidden'); }
             allPages.forEach(page => { if(page) page.classList.toggle('hidden', page.id !== pageId); else console.error("Page element null for ID (in showPage allPages loop):", pageId); });

             if(navButtons) {
                navButtons.forEach(button => {
                    if (button.getAttribute('onclick') && button.getAttribute('onclick').includes(`'${pageId}'`)) {
                        button.classList.add('active-tab');
                    } else {
                        button.classList.remove('active-tab');
                    }
                });
             }
            if(backfillRaceIdsSection) backfillRaceIdsSection.classList.add('hidden');

             if (pageId === 'overviewPage') renderOverviewPage();
             else if (pageId === 'poolPage') {
                 renderPoolPage();
                 populateBreedingSelectors();
             } else if (pageId === 'breedsPage') {
                 renderBreedsPage();
             } else if (pageId === 'lineagePage') renderLineagePage();
             else if (pageId === 'financialsPage') renderFinancialsPage();
             window.scrollTo({ top: 0, behavior: 'smooth' });
         }
        function showDetailPage(itemId) {
            if (itemId === null || itemId === undefined || itemId === '') { console.warn("Invalid ID for showDetailPage:", itemId); showPage('overviewPage'); return; }
            if (itemId !== 'ADD_NEW') { const potentialItem = findHorseById(parseInt(itemId)); if (!potentialItem) { alert(`ID ${itemId} not found.`); showPage('overviewPage'); return; } if (potentialItem.status === 'forged') { alert(`"${potentialItem.name}" Removed.`); showPage('overviewPage'); return; } }
            currentDetailHorseId = (itemId !== 'ADD_NEW') ? parseInt(itemId) : null;
            showPage('detailPage');
            if(horseProfileDisplayDiv) horseProfileDisplayDiv.classList.add('hidden');
            if(horseFormDiv) horseFormDiv.classList.add('hidden');
            if(mainActionsDiv) mainActionsDiv.classList.remove('hidden');
            hideDetailActionButtons();
            const rtcContainer = document.getElementById('race1TimeChartContainer');
            const zbcContainer = document.getElementById('zedBalanceChartContainer');
            if(rtcContainer) rtcContainer.classList.add('hidden');
            if(zbcContainer) zbcContainer.classList.add('hidden');
            if(backfillRaceIdsSection) backfillRaceIdsSection.classList.add('hidden');


            populateHorseSelectorForDetail();

            if (itemId === 'ADD_NEW') {
                showAddForm();
                if(navButtons){
                    navButtons.forEach(btn => {
                        if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes("showDetailPage('ADD_NEW')")) { }
                        else if (btn.classList.contains('active-tab') && btn.getAttribute('onclick') && btn.getAttribute('onclick').includes("showPage")) { }
                    });
                }
            } else if (currentDetailHorseId && !isNaN(currentDetailHorseId)) {
                if(horseSelector) horseSelector.value = currentDetailHorseId;
                renderHorseDetail(currentDetailHorseId);
            } else {
                if(horseSelector) horseSelector.value = "";
                hideDetailActionButtons();
                console.error("Unexpected state in showDetailPage:", itemId);
                if(horseProfileDisplayDiv) {
                    horseProfileDisplayDiv.innerHTML = '<p>Error loading details.</p>';
                    horseProfileDisplayDiv.classList.remove('hidden');
                }
            }
        }

        function renderOverviewPage() {
            const h2 = document.querySelector('#overviewPage h2');
            if (h2) h2.textContent = 'Stable Overview'; else console.error("Overview H2 not found");
            if (!horseTableBody) { console.error("horseTableBody not found in renderOverviewPage"); return; }
            horseTableBody.innerHTML = ''; const activeItems = horsesData.filter(h => h && h.status === 'active').sort((a, b) => (a.order ?? Infinity) - (b.order ?? Infinity)); let totalCost = 0, totalBalance = 0, totalOverallPL = 0; if (activeItems.length === 0) { horseTableBody.innerHTML = '<tr><td colspan="15" class="no-horses">No active items found. Add one or adjust filters.</td></tr>'; return; } activeItems.forEach(item => { const places = calculatePlaces(item), roi = calculateROI(item); totalCost += parseNumericValue(item?.breedCost); totalBalance += parseNumericValue(item?.zedBalance); const itemPL = parseNumericValue(calculateROI(item)); totalOverallPL += itemPL; const row = document.createElement('tr'); row.setAttribute('draggable', true); row.setAttribute('data-horse-id', item.id); row.innerHTML = `<td><span class="drag-handle">↕️</span></td> <td>${item.name}</td> <td>${item.gen||'N/A'}</td> <td>${item.gender||'N/A'}</td> <td>${item.breed||'N/A'}</td> <td class="stars">${item.overall||'-'}</td> <td class="stars">${item.speed||'-'}</td> <td class="stars">${item.sprint||'-'}</td> <td class="stars">${item.endurance||'-'}</td> <td>${item.races??'N/A'}</td> <td>${places}</td> <td>${item.breedCost||'N/A'}</td> <td>${item.zedBalance||'N/A'}</td> <td>${roi}</td> <td><span class="action-link" data-id="${item.id}">Details</span></td>`; row.querySelector('.action-link').addEventListener('click', (e) => { e.stopPropagation(); showDetailPage(item.id); }); horseTableBody.appendChild(row); }); if (activeItems.length > 0) { const footerRow = document.createElement('tr'); footerRow.classList.add('table-footer'); footerRow.innerHTML = `<td colspan="11"><strong>Totals (Active Items):</strong></td> <td class="footer-total">${formatNumericValue(totalCost)}</td> <td class="footer-total">${formatNumericValue(totalBalance)}</td> <td class="footer-total">${(totalOverallPL >= 0 ? '+' : '')}${totalOverallPL.toLocaleString(undefined, {minimumFractionDigits:2,maximumFractionDigits:2})}</td><td></td>`; horseTableBody.appendChild(footerRow); } }
        function populateHorseSelectorForDetail() { if(!horseSelector) { console.error("horseSelector not found in populateHorseSelectorForDetail"); return; } const currentSelectedId = horseSelector.value; horseSelector.innerHTML = '<option value="">-- Select an Item --</option>'; getNavigableHorses().forEach(item => { const option = document.createElement('option'); option.value = item.id; option.textContent = item.name; horseSelector.appendChild(option); }); const selectedItem = findHorseById(currentSelectedId); if (selectedItem && selectedItem.status !== 'forged') horseSelector.value = currentSelectedId; else { const currentDetailItem = findHorseById(currentDetailHorseId); if (currentDetailItem && currentDetailItem.status !== 'forged') horseSelector.value = currentDetailHorseId; else horseSelector.value = ""; } }

        function renderHorseDetail(itemId) {
            const item = findHorseById(itemId);
            const localRace1TimeChartContainer = document.getElementById('race1TimeChartContainer');
            const localRace1TimeCanvas = document.getElementById('race1TimeChartCanvas');
            const localRace1NoDataMsg = document.getElementById('race1ChartNoDataMessage');
            const localZedBalanceChartContainer = document.getElementById('zedBalanceChartContainer');
            const localZedBalanceCanvas = document.getElementById('zedBalanceChartCanvas');
            const localZedBalanceNoDataMsg = document.getElementById('zedBalanceChartNoDataMessage');

            if (!item || item.status === 'forged' || !horseProfileDisplayDiv || !formTitle || !horseFormDiv || !mainActionsDiv || !localRace1TimeChartContainer || !localZedBalanceChartContainer || !localRace1TimeCanvas || !localRace1NoDataMsg || !localZedBalanceCanvas || !localZedBalanceNoDataMsg || !displayTotalRaceNetPL) {
                console.error("Cannot render horse detail, essential element(s) missing or item invalid. Item ID:", itemId, "Item:", item);
                if(horseProfileDisplayDiv) horseProfileDisplayDiv.classList.add('hidden');
                if(horseFormDiv) horseFormDiv.classList.add('hidden');
                if(mainActionsDiv) mainActionsDiv.classList.remove('hidden');
                hideDetailActionButtons();
                if(horseSelector) horseSelector.value = "";
                if(localRace1TimeChartContainer) localRace1TimeChartContainer.classList.add('hidden');
                if(localZedBalanceChartContainer) localZedBalanceChartContainer.classList.add('hidden');
                if(backfillRaceIdsSection) backfillRaceIdsSection.classList.add('hidden');
                return;
            }

            profileName.textContent = `${item.name}'s Profile`;
            displayGen.textContent = item.gen || 'N/A'; displayGender.textContent = item.gender || 'N/A'; displayBreed.textContent = item.breed || 'N/A'; displayColourTrait.textContent = item.colourTrait || 'N/A';
            displaySireName.textContent = item.sireName || 'Unknown'; displaySireBreed.textContent = item.sireBreed || 'Unknown'; displaySireColourTrait.textContent = item.sireColourTrait || 'Unknown';
            displayDamName.textContent = item.damName || 'Unknown'; displayDamBreed.textContent = item.damBreed || 'Unknown'; displayDamColourTrait.textContent = item.damColourTrait || 'Unknown';
            displayOverall.textContent = item.overall || '-'; displaySpeed.textContent = item.speed || '-'; displaySprint.textContent = item.sprint || '-'; displayEndurance.textContent = item.endurance || '-';
            displayRaces.textContent = item.races ?? 'N/A'; displayFirst.textContent = item.first ?? 'N/A'; displaySecond.textContent = item.second ?? 'N/A'; displayThird.textContent = item.third ?? 'N/A'; displayPlaces.textContent = calculatePlaces(item);
            if(displayFastestTime) displayFastestTime.textContent = calculateFastestTime(item);
            if(displaySlowestTime) displaySlowestTime.textContent = calculateSlowestTime(item);
            if (displayAvgRaceTime) displayAvgRaceTime.textContent = calculateAverageRaceTime(item);
            displayCPU.textContent = item.cpu || 'N/A'; displayRAM.textContent = item.ram || 'N/A'; displayHydraulic.textContent = item.hydraulic || 'N/A';
            displayBreedCost.textContent = item.breedCost || 'N/A';
            displayStrtZedBal.textContent = item.strtZedBal || '0'; // Should always have a value from load/add
            displayTotalRaceNetPL.textContent = item.totalRaceNetPL || '0'; // Should always have a value
            displayZedBalance.textContent = item.zedBalance || '0'; // Should always have a value
            displaySoldBreeds.textContent = item.soldBreeds || 'N/A';
            displayROI.textContent = calculateROI(item);
            horseProfileDisplayDiv.classList.remove('hidden'); horseFormDiv.classList.add('hidden'); mainActionsDiv.classList.remove('hidden'); showDetailActionButtons();
            if(backfillRaceIdsSection) backfillRaceIdsSection.classList.add('hidden');


            let effectiveChartTextColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-text-color').trim();
            const isDarkMode = document.body.classList.contains('dark-mode');
            if (isDarkMode) {
                effectiveChartTextColor = '#FFFFFF';
            }
            const currentChartGridColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid-color').trim();
            const currentTooltipBgColor = isDarkMode ? 'rgba(30,30,30,0.9)' : 'rgba(250,250,250,0.9)';

            if (race1TimeChartInstance) { race1TimeChartInstance.destroy(); race1TimeChartInstance = null; }
            const allRacesHistory = getCombinedRaceHistory(item);
            const augmentChangesHistory = (item.augmentHistory || []).filter(aug => aug && aug.timestamp).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            let augmentChangeMarkersData = [];

            if (allRacesHistory.length >= 1 || augmentChangesHistory.length > 0) {
                localRace1TimeChartContainer.classList.remove('hidden'); localRace1TimeCanvas.classList.remove('hidden'); localRace1NoDataMsg.classList.add('hidden');

                let overallFastestS = Infinity, overallSlowestS = 0;
                let overallFastestTimeObj = null, overallSlowestTimeObj = null;

                if(allRacesHistory.length > 0) {
                    allRacesHistory.forEach(e => {
                        const ts = parseRaceTime(e.time);
                        if (ts !== null) {
                            if (ts < overallFastestS) { overallFastestS = ts; overallFastestTimeObj = e; }
                            if (overallSlowestS === 0 || ts > overallSlowestS) {
                                overallSlowestS = ts; overallSlowestTimeObj = e;
                            }
                        }
                    });
                    if (overallFastestS === Infinity && allRacesHistory.length > 0 && overallSlowestTimeObj) {
                        overallFastestS = overallSlowestS;
                        overallFastestTimeObj = overallSlowestTimeObj;
                    }
                }


                let augmentMarkerYValue;
                if (allRacesHistory.length > 0 && isFinite(overallFastestS) && isFinite(overallSlowestS) && overallSlowestS !== Infinity ) {
                    augmentMarkerYValue = overallSlowestS + ((overallSlowestS - overallFastestS || 5) * 0.15);
                    if (Math.abs(augmentMarkerYValue - overallSlowestS) < 0.1 && overallSlowestS !== overallFastestS) augmentMarkerYValue = overallSlowestS + 1;
                    else if (overallSlowestS === overallFastestS) augmentMarkerYValue = overallSlowestS + 1;
                } else if (augmentChangesHistory.length > 0) {
                    augmentMarkerYValue = 5;
                } else { augmentMarkerYValue = 0; }
                 if (!isFinite(augmentMarkerYValue) || augmentMarkerYValue <=0 ) augmentMarkerYValue = (isFinite(overallSlowestS) && overallSlowestS > 0) ? overallSlowestS + 2 : 10;


                if (augmentChangesHistory.length > 0) {
                    augmentChangeMarkersData = augmentChangesHistory.map(aug => ({
                        x: aug.timestamp, y: augmentMarkerYValue,
                        cpu: aug.cpu, ram: aug.ram, hydraulic: aug.hydraulic
                    }));
                }

                const datasets = [];
                if (allRacesHistory.length > 0) {
                    datasets.push({
                        type: 'line',
                        label: 'All Race Times (s)',
                        data: allRacesHistory.map(e => ({ x: e.timestamp, y: parseRaceTime(e.time), originalTime: e.time, raceId: e.race_id })),
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        showLine: true,
                        fill: false,
                        tension: 0.1,
                        order: 2
                    });
                }

                if (allRacesHistory.length > 0 && overallFastestTimeObj && overallSlowestTimeObj) {
                    const allTimestamps = allRacesHistory.map(e => e.timestamp);
                    const firstTs = Math.min(...allTimestamps);
                    const lastTs = Math.max(...allTimestamps);

                    if (overallFastestS !== Infinity) {
                        datasets.push({ type: 'line', label: 'Overall Fastest', data: [{x:firstTs,y:overallFastestS, originalTime: overallFastestTimeObj.time},{x:lastTs,y:overallFastestS, originalTime: overallFastestTimeObj.time}], borderColor:'rgb(40,167,69)', borderWidth:2, borderDash:[5,5], pointRadius:0, fill:false, tension:0, order:1 });
                    }
                    if (overallSlowestS > 0 && overallSlowestS !== Infinity && overallSlowestS !== overallFastestS) {
                        datasets.push({ type: 'line', label: 'Overall Slowest', data: [{x:firstTs,y:overallSlowestS, originalTime: overallSlowestTimeObj.time},{x:lastTs,y:overallSlowestS, originalTime: overallSlowestTimeObj.time}], borderColor:'rgb(220,53,69)', borderWidth:2, borderDash:[5,5], pointRadius:0, fill:false, tension:0, order:0 });
                    }
                }


                if (augmentChangeMarkersData.length > 0) {
                    datasets.push({
                        type: 'scatter', label: 'Augment Change', data: augmentChangeMarkersData,
                        pointStyle: 'star', radius: 7, hoverRadius: 9,
                        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--stars-color').trim() || '#ffc107',
                        borderColor: 'rgba(150, 100, 0, 0.8)',
                        showLine: false, order: 0
                    });
                }

                let yOpt = { title: { display: true, text: 'Time (s - Lower is Better)', color: effectiveChartTextColor }, ticks: { color: effectiveChartTextColor }, grid: { color: currentChartGridColor } };
                let minVisibleY = overallFastestS === Infinity ? (augmentChangesHistory.length > 0 ? augmentMarkerYValue : 0) : overallFastestS;
                let maxVisibleY = overallSlowestS === 0 ? (augmentChangesHistory.length > 0 ? augmentMarkerYValue : 10) : overallSlowestS;

                 if (augmentChangeMarkersData.length > 0) {
                    minVisibleY = Math.min(minVisibleY, augmentMarkerYValue);
                    maxVisibleY = Math.max(maxVisibleY, augmentMarkerYValue);
                }

                if (isFinite(minVisibleY) && isFinite(maxVisibleY)) {
                    const yRange = Math.abs(maxVisibleY - minVisibleY);
                    const padding = Math.max(yRange * 0.1, 1) || 1;
                    yOpt.suggestedMin = Math.max(0, minVisibleY - padding);
                    yOpt.suggestedMax = maxVisibleY + padding;
                     if (yOpt.suggestedMin >= yOpt.suggestedMax) {
                        yOpt.suggestedMax = yOpt.suggestedMin + 2;
                    }
                } else { yOpt.beginAtZero = false; }

                race1TimeChartInstance = new Chart(localRace1TimeCanvas.getContext('2d'), {
                    data: { datasets: datasets },
                    options: { responsive: true, maintainAspectRatio: true, scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'PPpp', displayFormats: { day: 'MMM d' }}, title: { display: true, text: 'Date', color: effectiveChartTextColor }, ticks: { color: effectiveChartTextColor }, grid: { color: currentChartGridColor } }, y: yOpt },
                        plugins: { legend: {position:'top', labels:{color: effectiveChartTextColor}},
                            tooltip: { titleColor: effectiveChartTextColor, bodyColor: effectiveChartTextColor, backgroundColor: currentTooltipBgColor,
                                callbacks: {
                                    title: (tooltipItems) => {
                                        const firstItem = tooltipItems[0];
                                        if (firstItem.dataset.label === 'Augment Change') return `Augment Change on ${new Date(firstItem.parsed.x).toLocaleDateString()}`;
                                        if (firstItem.dataset.label.includes('Fastest') || firstItem.dataset.label.includes('Slowest')) return firstItem.dataset.label;
                                        return new Date(firstItem.parsed.x).toLocaleDateString();
                                    },
                                    label: (context) => {
                                        let label = context.dataset.label || '';
                                        if (label === 'Augment Change') {
                                            const dp = context.raw;
                                            return [`CPU: ${dp.cpu || 'N/A'}`, `RAM: ${dp.ram || 'N/A'}`, `Hydraulic: ${dp.hydraulic || 'N/A'}`];
                                        }
                                        let val = context.parsed.y; let originalTime = context.raw?.originalTime; let raceId = context.raw?.raceId;
                                        if (label.includes('Fastest') || label.includes('Slowest')) {
                                            val = context.raw.y; originalTime = context.raw.originalTime;
                                            label = `${label}: ${originalTime || formatSecondsToTime(val)} (${val ? val.toFixed(2) : 'N/A'}s)`;
                                        } else { // Individual race time points
                                            if (label === 'All Race Times (s)') label = 'Race Time: '; else if (label) label += ': ';
                                            if (originalTime) label += `${originalTime} (${val ? val.toFixed(2) : 'N/A'}s)`;
                                            else if (val !== null && !isNaN(val)) label += val.toFixed(2) + 's'; else label += 'N/A';
                                            if(raceId) label += ` (ID: ${raceId})`;
                                        } return label;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                localRace1TimeChartContainer.classList.remove('hidden');
                if(localRace1TimeCanvas) localRace1TimeCanvas.classList.add('hidden');
                if(localRace1NoDataMsg) { localRace1NoDataMsg.textContent = "No race time or augment history to display."; localRace1NoDataMsg.classList.remove('hidden'); }
            }


            if (zedBalanceChartInstance) { zedBalanceChartInstance.destroy(); zedBalanceChartInstance = null; }
            const balHist = (item.zedBalanceHistory || []).filter(e => e && typeof e.balance === 'string' && e.timestamp && e.balance.trim() !== "").map(e => ({ ts: e.timestamp, val: parseNumericValue(e.balance), orig: e.balance })).filter(e => e.val !== null).sort((a,b) => a.ts - b.ts);
            if (balHist.length >= 1) {
                localZedBalanceChartContainer.classList.remove('hidden'); localZedBalanceCanvas.classList.remove('hidden'); localZedBalanceNoDataMsg.classList.add('hidden');
                const chartData = balHist.map(e => ({ x: e.ts, y: e.val }));
                zedBalanceChartInstance = new Chart(localZedBalanceCanvas.getContext('2d'), { type: 'line', data: { datasets: [{ label: 'ZED Balance', data: chartData, borderColor: 'rgb(255,159,64)', backgroundColor: 'rgba(255,159,64,0.2)', tension: 0.1, fill: true, pointRadius: 3, pointHoverRadius: 5 }] },
                    options: { responsive: true, maintainAspectRatio: true, scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'PPpp', displayFormats: { day: 'MMM d' } }, title: { display: true, text: 'Date', color: effectiveChartTextColor }, ticks: { color: effectiveChartTextColor }, grid: { color: currentChartGridColor } }, y: { beginAtZero: false, title: { display: true, text: 'Balance', color: effectiveChartTextColor }, ticks: { callback: (v) => v.toLocaleString(undefined, {minimumFractionDigits:0,maximumFractionDigits:2}), color: effectiveChartTextColor }, grid: { color: currentChartGridColor } } }, plugins: { legend: { position:'top', labels:{color: effectiveChartTextColor} }, tooltip: { titleColor: effectiveChartTextColor, bodyColor: effectiveChartTextColor, backgroundColor: currentTooltipBgColor, callbacks: { title: (i) => new Date(i[0].parsed.x).toLocaleDateString(), label: (c) => { let l = c.dataset.label || ''; if(l) l+=': '; const origE = balHist.find(bh => bh.ts === c.parsed.x); if (origE && origE.orig) l += origE.orig; else if (c.parsed.y !== null) l += c.parsed.y.toLocaleString(undefined, {minimumFractionDigits:2,maximumFractionDigits:2}); return l; } } } } } });
            } else {
                localZedBalanceChartContainer.classList.remove('hidden'); if(localZedBalanceCanvas) localZedBalanceCanvas.classList.add('hidden'); if(localZedBalanceNoDataMsg) { localZedBalanceNoDataMsg.textContent = "No ZED Balance history."; localZedBalanceNoDataMsg.classList.remove('hidden');}
            }
            if(prevHorseBtn && nextHorseBtn) {
                const navigableItems = getNavigableHorses(), curIdx = navigableItems.findIndex(h => h.id === itemId);
                prevHorseBtn.disabled = (curIdx <= 0);
                nextHorseBtn.disabled = (curIdx < 0 || curIdx >= navigableItems.length - 1);
            }
        }
        function renderPoolPage() {
            const poolH2 = document.querySelector('#poolPage h2'); if(poolH2) poolH2.textContent = 'Breeding Pool & Simulator';
            const siresH3 = document.querySelector('#siresSection h3'); if(siresH3) siresH3.textContent = 'Sires in Pool';
            const damsH3 = document.querySelector('#damsSection h3'); if(damsH3) damsH3.textContent = 'Dams in Pool';
            if(!siresListElement || !damsListElement) { console.error("Sire/Dam list elements not found in renderPoolPage"); return; }
            const items = horsesData.filter(h => h && h.status === 'breeding'); renderPoolList(items.filter(h => h.gender === 'M'), siresListElement, "Sires"); renderPoolList(items.filter(h => h.gender === 'F'), damsListElement, "Dams"); }
        function renderPoolList(items, target, type) {
            if(!target) { console.error("Target element for pool list is null for type:", type); return; }
            target.innerHTML = ''; if (items.length === 0) { target.innerHTML = `<p class="no-horses">No ${type} in Pool.</p>`; return; }
            items.sort((a, b) => a.name.localeCompare(b.name));
            items.forEach(item => {
                const card = document.createElement('div'); card.className = 'horse-card';
                let finHTML = ''; if (type === "Sires") finHTML = `<div class="financials-pool"><h4>Financials</h4> <p><strong>Cost:</strong> <span>${item.breedCost||'N/A'}</span></p> <p><strong>Starting Bal:</strong> <span>${item.strtZedBal||'N/A'}</span></p><p><strong>Race P/L:</strong> <span>${item.totalRaceNetPL||'0'}</span></p> <p><strong>Current Bal:</strong> <span>${item.zedBalance||'N/A'}</span></p> <p><strong>Total Value Sold:</strong> <span>${item.soldBreeds||'N/A'}</span></p> </div>`;
                card.innerHTML = `<h3>${item.name}</h3> <h4>Basic</h4> <p><strong>Gen:</strong> <span>${item.gen||'N/A'}</span></p> <p><strong>Breed:</strong> <span>${item.breed||'N/A'}</span></p> <p><strong>Colour:</strong> <span>${item.colourTrait||'N/A'}</span></p> <h4>Stats</h4> <p><strong>Overall:</strong> <span class="stars">${item.overall||'-'}</span></p> <p><strong>Speed:</strong> <span class="stars">${item.speed||'-'}</span></p> <p><strong>Sprint:</strong> <span class="stars">${item.sprint||'-'}</span></p> <p><strong>Endurance:</strong> <span class="stars">${item.endurance||'-'}</span></p> <h4>Record</h4> <p><strong>Races:</strong> <span>${item.races??'N/A'}</span></p> <p><strong>1st:</strong> <span>${item.first??'N/A'}</span></p> <p><strong>2nd:</strong> <span>${item.second??'N/A'}</span></p> <p><strong>3rd:</strong> <span>${item.third??'N/A'}</span></p> <p><strong>Places:</strong> <span>${calculatePlaces(item)}</span></p> <p><strong>Avg Race Time:</strong> <span>${calculateAverageRaceTime(item)}</span></p> ${finHTML} <a href="#" class="view-details-link" data-id="${item.id}">Details</a>`;
                card.querySelector('.view-details-link').addEventListener('click', (e) => { e.preventDefault(); showDetailPage(item.id); });
                target.appendChild(card);
            });
        }
        function renderBreedsPage() {
            const breedsH2 = document.querySelector('#breedsPage h2'); if(breedsH2) breedsH2.textContent = 'Breeding Records';
            if(!breedingRecordsList) { console.error("breedingRecordsList not found in renderBreedsPage"); return; }
            breedingRecordsList.innerHTML = '';
            const offspring = horsesData.filter(h => h && h.status !== 'forged' && (h.sireName || h.damName));
            if (offspring.length === 0) {
                breedingRecordsList.innerHTML = '<p class="no-records">No records found.</p>';
            } else {
                offspring.sort((a, b) => a.name.localeCompare(b.name));
                const starOpts = ` <option value="-">-</option> <option>⭐️</option> <option>⭐️⭐️</option> <option>⭐️⭐️☀️</option> <option>⭐️⭐️⭐️</option> <option>⭐️⭐️⭐️☀️</option> <option>⭐️⭐️⭐️⭐️</option> <option>⭐️⭐️⭐️⭐️☀️</option> <option>⭐️⭐️⭐️⭐️⭐️</option> `;
                const breedOpts = `<option value="">Unknown</option><option>Nakamoto</option><option>Szabo</option><option>Finney</option><option>Buterin</option>`;
                const genOpts = `<option value="">Unknown</option><option>G0</option><option>G1</option><option>G2</option><option>G3</option><option>G4</option><option>G5</option>`;
                const createNameEl = (name, obj) => { if (obj && obj.status !== 'forged') return `<span class="clickable-horse-name" onclick="showDetailPage(${obj.id})">${name}</span>`; else if (name) { let suffix = (obj && obj.status === 'forged') ? ' <span class="forged-label">(Removed)</span>' : ' <em style="font-size:0.8em; color:var(--text-color); opacity: 0.7;">(Not found)</em>'; return `<span class="non-clickable-name">${name}</span>${suffix}`; } else return 'Unknown'; };
                offspring.forEach(child => {
                    const sire = findHorseByName(child.sireName), dam = findHorseByName(child.damName);
                    const sireP = calculatePlaces(sire), damP = calculatePlaces(dam), childP = calculatePlaces(child);
                    const canEditS = sire && sire.status !== 'forged', canEditD = dam && dam.status !== 'forged';
                    const sireO = child.sireOverall || (sire ? sire.overall : '-') || '-', sireSp = child.sireSpeed || (sire ? sire.speed : '-') || '-', sireSr = child.sireSprint || (sire ? sire.sprint : '-') || '-', sireE = child.sireEndurance || (sire ? sire.endurance : '-') || '-';
                    const damO = child.damOverall || (dam ? dam.overall : '-') || '-', damSp = child.damSpeed || (dam ? dam.speed : '-') || '-', damSr = child.damSprint || (dam ? dam.sprint : '-') || '-', damE = child.damEndurance || (dam ? dam.endurance : '-') || '-';
                    const childO = child.overall || '-', childSp = child.speed || '-', childSr = child.sprint || '-', childE = child.endurance || '-';
                    const card = document.createElement('div'); card.className = 'breeding-record-card'; card.setAttribute('data-offspring-id', child.id);
                    const sireName = createNameEl(child.sireName, sire), damName = createNameEl(child.damName, dam), childName = createNameEl(child.name, child);
                    let sireHTML = `<div class="parent-section" data-parent-id="${sire?.id || ''}"><h3>Sire</h3><div class="horse-details display-details"><p><strong>Name:</strong> ${sireName}</p><p><strong>Breed:</strong> <span>${sire?.breed || child.sireBreed || 'N/A'}</span></p><p><strong>Colour:</strong> <span>${sire?.colourTrait || child.sireColourTrait || 'N/A'}</span></p><p><strong>Gen:</strong> <span>${sire?.gen || child.sireGen || 'N/A'}</span></p><p><strong>Overall:</strong> <span class="stars">${sireO}</span></p><p><strong>Speed:</strong> <span class="stars">${sireSp}</span></p><p><strong>Sprint:</strong> <span class="stars">${sireSr}</span></p><p><strong>Endurance:</strong> <span class="stars">${sireE}</span></p><p><strong>Races:</strong> <span>${sire?.races ?? 'N/A'}</span></p><p><strong>Places:</strong> <span>${sire ? sireP : 'N/A'}</span></p></div><div class="inline-edit-form hidden"><label>Breed:</label> <select class="inline-breed">${breedOpts}</select> <label>Colour:</label> <select class="inline-colour">${breedOpts}</select><label>Gen:</label> <select class="inline-gen">${genOpts}</select> <label>Overall:</label> <select class="inline-overall">${starOpts}</select><label>Speed:</label> <select class="inline-speed">${starOpts}</select> <label>Sprint:</label> <select class="inline-sprint">${starOpts}</select><label>Endurance:</label> <select class="inline-endurance">${starOpts}</select> <label>Races:</label> <input type="number" class="inline-races" min="0"> <div class="inline-edit-buttons"><button class="button-link btn-primary btn-sm save-parent-edit">Save</button> <button type="button" class="button-link btn-secondary btn-sm cancel-parent-edit">Cancel</button></div></div>${canEditS ? `<button class="button-link btn-warning btn-sm edit-parent-button">Edit Sire</button>` : ''}</div>`;
                    let damHTML = `<div class="parent-section" data-parent-id="${dam?.id || ''}"><h3>Dam</h3><div class="horse-details display-details"><p><strong>Name:</strong> ${damName}</p><p><strong>Breed:</strong> <span>${dam?.breed || child.damBreed || 'N/A'}</span></p><p><strong>Colour:</strong> <span>${dam?.colourTrait || child.damColourTrait || 'N/A'}</span></p><p><strong>Gen:</strong> <span>${dam?.gen || child.damGen || 'N/A'}</span></p><p><strong>Overall:</strong> <span class="stars">${damO}</span></p><p><strong>Speed:</strong> <span class="stars">${damSp}</span></p><p><strong>Sprint:</strong> <span class="stars">${damSr}</span></p><p><strong>Endurance:</strong> <span class="stars">${damE}</span></p><p><strong>Races:</strong> <span>${dam?.races ?? 'N/A'}</span></p><p><strong>Places:</strong> <span>${dam ? damP : 'N/A'}</span></p></div><div class="inline-edit-form hidden"><label>Breed:</label> <select class="inline-breed">${breedOpts}</select> <label>Colour:</label> <select class="inline-colour">${breedOpts}</select><label>Gen:</label> <select class="inline-gen">${genOpts}</select> <label>Overall:</label> <select class="inline-overall">${starOpts}</select><label>Speed:</label> <select class="inline-speed">${starOpts}</select> <label>Sprint:</label> <select class="inline-sprint">${starOpts}</select><label>Endurance:</label> <select class="inline-endurance">${starOpts}</select> <label>Races:</label> <input type="number" class="inline-races" min="0"> <div class="inline-edit-buttons"><button class="button-link btn-primary btn-sm save-parent-edit">Save</button> <button type="button" class="button-link btn-secondary btn-sm cancel-parent-edit">Cancel</button></div></div>${canEditD ? `<button class="button-link btn-warning btn-sm edit-parent-button">Edit Dam</button>` : ''}</div>`;
                    let offspringHTML = `<div class="offspring-section"><h3>Offspring</h3><div class="horse-details"><p><strong>Name:</strong> ${childName}</p><p><strong>Breed:</strong> <span>${child.breed||'N/A'}</span></p><p><strong>Colour:</strong> <span>${child.colourTrait||'N/A'}</span></p><p><strong>Gen:</strong> <span>${child.gen||'N/A'}</span></p><p><strong>Overall:</strong> <span class="stars">${childO}</span></p><p><strong>Speed:</strong> <span class="stars">${childSp}</span></p><p><strong>Sprint:</strong> <span class="stars">${childSr}</span></p><p><strong>Endurance:</strong> <span class="stars">${childE}</span></p><p><strong>Races:</strong> <span>${child.races??'N/A'}</span></p><p><strong>Places:</strong> <span>${childP}</span></p><p><strong>Cost:</strong> <span>${child.breedCost||'N/A'}</span></p></div><button class="button-link btn-warning btn-sm edit-offspring-button" data-id="${child.id}">Edit Offspring</button></div>`;
                    card.innerHTML = `<div class="record-details">${sireHTML}${damHTML}${offspringHTML}</div>`;
                    breedingRecordsList.appendChild(card);
                });
            }
            if (offspringResultDiv) offspringResultDiv.classList.add('hidden');
        }
        function renderLineagePage() {
            const lineageH2 = document.querySelector('#lineagePage h2'); if(lineageH2) lineageH2.textContent = 'Lineage Viewer';
            if(!lineageDisplayArea) { console.error("lineageDisplayArea not found in renderLineagePage"); return; }
            lineageDisplayArea.innerHTML = '<p class="no-lineage">Generating lineage...</p>';
            const allItems = [...horsesData];
            if (allItems.length === 0) { lineageDisplayArea.innerHTML = '<p class="no-lineage">No items found.</p>'; return; }
            const families = {};
            allItems.forEach(item => {
                if (item.sireName && item.damName) {
                    const key = `${item.sireName.toLowerCase().trim()} & ${item.damName.toLowerCase().trim()}`;
                    if (!families[key]) {
                        families[key] = {
                            sire: findHorseByName(item.sireName),
                            dam: findHorseByName(item.damName),
                            sireNameDisplay: item.sireName,
                            damNameDisplay: item.damName,
                            sireGenFallback: item.sireGen,
                            sireBreedFallback: item.sireBreed,
                            sireOverallFallback: item.sireOverall,
                            damGenFallback: item.damGen,
                            damBreedFallback: item.damBreed,
                            damOverallFallback: item.damOverall,
                            offspring: []
                        };
                    }
                    families[key].offspring.push(item);
                }
            });

            if (Object.keys(families).length === 0) { lineageDisplayArea.innerHTML = '<p class="no-lineage">No items with known parents.</p>'; return; }
            let finalHTML = '';
            for (const key in families) {
                const family = families[key];
                family.offspring.sort((a,b) => a.name.localeCompare(b.name));

                finalHTML += `<div class="lineage-family-card">`;

                finalHTML += `<div class="lineage-parent">`;
                finalHTML += `  <strong>Sire:</strong> <span>${family.sire ? family.sire.name : family.sireNameDisplay}</span>`;
                if (family.sire && family.sire.status === 'forged') finalHTML += ` <span class="forged-label">(Forged)</span>`;
                finalHTML += `  <div class="lineage-parent-extra-details">`;
                let sireGen = family.sire ? (family.sire.gen || 'N/A') : (family.sireGenFallback || 'N/A');
                let sireBreed = family.sire ? (family.sire.breed || 'N/A') : (family.sireBreedFallback || 'N/A');
                let sireOverall = family.sire ? (family.sire.overall || '-') : (family.sireOverallFallback || '-');
                finalHTML += `    <span>Gen: ${sireGen}</span>`;
                finalHTML += `    <span>Breed: ${sireBreed}</span>`;
                if (sireOverall && sireOverall !== '-') finalHTML += `    <span>Overall: <span class="stars">${sireOverall}</span></span>`;
                finalHTML += `  </div>`;
                finalHTML += `</div>`;

                finalHTML += `<div class="lineage-parent">`;
                finalHTML += `  <strong>Dam:</strong> <span>${family.dam ? family.dam.name : family.damNameDisplay}</span>`;
                if (family.dam && family.dam.status === 'forged') finalHTML += ` <span class="forged-label">(Forged)</span>`;
                finalHTML += `  <div class="lineage-parent-extra-details">`;
                let damGen = family.dam ? (family.dam.gen || 'N/A') : (family.damGenFallback || 'N/A');
                let damBreed = family.dam ? (family.dam.breed || 'N/A') : (family.damBreedFallback || 'N/A');
                let damOverall = family.dam ? (family.dam.overall || '-') : (family.damOverallFallback || '-');
                finalHTML += `    <span>Gen: ${damGen}</span>`;
                finalHTML += `    <span>Breed: ${damBreed}</span>`;
                if (damOverall && damOverall !== '-') finalHTML += `    <span>Overall: <span class="stars">${damOverall}</span></span>`;
                finalHTML += `  </div>`;
                finalHTML += `</div>`;

                finalHTML += `<div style="margin-left: 20px; margin-top: 10px;">`;
                family.offspring.forEach(child => {
                    finalHTML += `<div class="lineage-offspring">↳ <span>${child.name}</span>`;
                    if (child.gen) finalHTML += ` <span class="lineage-offspring-details">(Gen: ${child.gen || 'N/A'})</span>`;
                    if (child.breed) finalHTML += ` <span class="lineage-offspring-details">(Breed: ${child.breed || 'N/A'})</span>`;
                    if (child.overall && child.overall !== '-') finalHTML += ` <span class="stars">${child.overall}</span>`;
                    if (child.status === 'forged') finalHTML += ` <span class="forged-label">(Forged)</span>`;
                    finalHTML += `</div>`;
                });
                finalHTML += `</div></div>`;
            }
            lineageDisplayArea.innerHTML = finalHTML || '<p class="no-lineage">No lineages found.</p>';
        }
        function renderFinancialsPage() {
            const finH2 = document.querySelector('#financialsPage h2'); if(finH2) finH2.textContent = 'Financials Overview';
            if(!financialsTableBody || !financialsTableFooter) { console.error("Financials table elements not found."); return; }
            financialsTableBody.innerHTML = ''; financialsTableFooter.innerHTML = '';
            const items = horsesData.filter(h => h);
            if (items.length === 0) { financialsTableBody.innerHTML = '<tr><td colspan="6" class="no-horses">No items found.</td></tr>'; return; }

            let grandTotalCost = 0, grandTotalStartBal = 0, grandTotalCurrentBal = 0, grandTotalSold = 0, grandTotalOverallPL = 0;
            items.sort((a,b) => a.name.localeCompare(b.name));
            items.forEach(item => {
                const row = document.createElement('tr');
                const costNum = parseNumericValue(item.breedCost);
                const startBalNum = parseNumericValue(item.strtZedBal);
                const currentBalNum = parseNumericValue(item.zedBalance);
                const soldNum = parseNumericValue(item.soldBreeds);
                const overallPLStr = calculateROI(item);

                let displayName = item.name;
                if (item.status === 'forged') {
                    displayName += ' <span class="forged-label" style="font-weight:normal;">(Forged)</span>';
                    row.style.opacity = '0.6';
                }

                grandTotalCost += costNum;
                grandTotalStartBal += startBalNum;
                grandTotalCurrentBal += currentBalNum;
                grandTotalSold += soldNum;
                grandTotalOverallPL += parseNumericValue(overallPLStr);

                row.innerHTML = `
                    <td>${item.status !== 'forged' ? `<span class="action-link" onclick="showDetailPage(${item.id})">${displayName}</span>` : displayName}</td>
                    <td>${item.breedCost||'N/A'}</td>
                    <td>${item.strtZedBal||'N/A'}</td>
                    <td>${item.zedBalance||'N/A'}</td>
                    <td>${item.soldBreeds||'N/A'}</td>
                    <td>${overallPLStr}</td>`;
                financialsTableBody.appendChild(row);
            });

            const footRow = document.createElement('tr');
            footRow.classList.add('table-footer');
            footRow.innerHTML = `
                <td><strong>Totals:</strong></td>
                <td class="footer-total">${formatNumericValue(grandTotalCost)}</td>
                <td class="footer-total">${formatNumericValue(grandTotalStartBal)}</td>
                <td class="footer-total">${formatNumericValue(grandTotalCurrentBal)}</td>
                <td class="footer-total">${formatNumericValue(grandTotalSold)}</td>
                <td class="footer-total">${(grandTotalOverallPL >= 0 ? '+' : '')}${grandTotalOverallPL.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>`;
            financialsTableFooter.appendChild(footRow);
        }


        function hideDetailActionButtons() { if(editButton) editButton.classList.add('hidden'); if(sendToBreedingPoolButton) sendToBreedingPoolButton.classList.add('hidden'); if(forgeButton) forgeButton.classList.add('hidden'); if(prevHorseBtn) prevHorseBtn.classList.add('hidden'); if(nextHorseBtn) nextHorseBtn.classList.add('hidden'); }
        function showDetailActionButtons() { const item = findHorseById(currentDetailHorseId); if (item && item.status !== 'forged') { if(editButton) editButton.classList.remove('hidden'); if(sendToBreedingPoolButton) sendToBreedingPoolButton.classList.remove('hidden'); if(forgeButton) forgeButton.classList.remove('hidden'); if(prevHorseBtn) prevHorseBtn.classList.remove('hidden'); if(nextHorseBtn) nextHorseBtn.classList.remove('hidden'); } else hideDetailActionButtons(); }
        function clearDetailForm() { if(editAddForm) editAddForm.reset(); if(horseIdInput) horseIdInput.value = ""; }

        function populateFormForEdit(itemId) {
            const item = findHorseById(itemId); if (!item || item.status === 'forged' || !horseIdInput) return;
            horseIdInput.value = item.id; inputName.value = item.name || ""; inputGen.value = item.gen || ""; inputGender.value = item.gender || "M"; inputBreed.value = item.breed || ""; inputColourTrait.value = item.colourTrait || "";
            inputSireName.value = item.sireName || ""; inputSireGen.value = item.sireGen || ""; inputSireBreed.value = item.sireBreed || ""; inputSireColourTrait.value = item.sireColourTrait || ""; inputSireOverall.value = item.sireOverall || "-"; inputSireSpeed.value = item.sireSpeed || "-"; inputSireSprint.value = item.sireSprint || "-"; inputSireEndurance.value = item.sireEndurance || "-";
            inputDamName.value = item.damName || ""; inputDamGen.value = item.damGen || ""; inputDamBreed.value = item.damBreed || ""; inputDamColourTrait.value = item.damColourTrait || ""; inputDamOverall.value = item.damOverall || "-"; inputDamSpeed.value = item.damSpeed || "-"; inputDamSprint.value = item.damSprint || "-"; inputDamEndurance.value = item.damEndurance || "-";
            inputOverall.value = item.overall || "-"; inputSpeed.value = item.speed || "-"; inputSprint.value = item.sprint || "-"; inputEndurance.value = item.endurance || "-";
            inputRaces.value = item.races ?? 0; inputFirst.value = item.first ?? 0; inputSecond.value = item.second ?? 0; inputThird.value = item.third ?? 0;
            inputCPU.value = item.cpu || ""; inputRAM.value = item.ram || ""; inputHydraulic.value = item.hydraulic || "";
            inputBreedCost.value = item.breedCost || "";
            inputZedBalance.value = item.zedBalance || "";
            inputSoldBreeds.value = "";
        }
        function showEditForm() {
            if (!currentDetailHorseId) return;
            const item = findHorseById(currentDetailHorseId);
            if (!item || item.status === 'forged') { alert("Cannot edit removed item."); return; }
            if(!formTitle || !horseFormDiv || !horseProfileDisplayDiv || !mainActionsDiv || !saveChangesButton || !saveNewButton || !inputZedBalanceGroup) return;

            formTitle.textContent = `Edit ${item.name}`;
            clearDetailForm();
            populateFormForEdit(currentDetailHorseId);

            inputZedBalanceGroup.classList.remove('hidden');
            inputSoldBreeds.value = "";
            horseFormDiv.classList.remove('hidden');
            horseProfileDisplayDiv.classList.add('hidden');
            mainActionsDiv.classList.add('hidden'); // Hide main actions when form is shown
            if (backfillRaceIdsSection) backfillRaceIdsSection.classList.add('hidden'); // Hide backfill if open
            saveChangesButton.classList.remove('hidden');
            saveNewButton.classList.add('hidden');
            document.getElementById('race1TimeChartContainer')?.classList.add('hidden');
            document.getElementById('zedBalanceChartContainer')?.classList.add('hidden');
        }
        function showAddForm() {
            if(!formTitle || !horseFormDiv || !horseProfileDisplayDiv || !mainActionsDiv || !saveChangesButton || !saveNewButton || !inputSireGen || !inputDamGen || !inputZedBalanceGroup) return;
            currentDetailHorseId = null; formTitle.textContent = "Add New Item"; clearDetailForm();
            inputSireGen.value = ""; inputDamGen.value = "";
            inputOverall.value = "-"; inputSpeed.value = "-"; inputSprint.value = "-"; inputEndurance.value = "-";
            inputSireOverall.value = "-"; inputSireSpeed.value = "-"; inputSireSprint.value = "-"; inputSireEndurance.value = "-";
            inputDamOverall.value = "-"; inputDamSpeed.value = "-"; inputDamSprint.value = "-"; inputDamEndurance.value = "-";
            inputSoldBreeds.value = "";

            inputZedBalanceGroup.classList.add('hidden');


            horseFormDiv.classList.remove('hidden');
            horseProfileDisplayDiv.classList.add('hidden');
            mainActionsDiv.classList.add('hidden'); // Hide main actions when form is shown
            if (backfillRaceIdsSection) backfillRaceIdsSection.classList.add('hidden'); // Hide backfill if open

            saveChangesButton.classList.add('hidden');
            saveNewButton.classList.remove('hidden');
            document.getElementById('race1TimeChartContainer')?.classList.add('hidden');
            document.getElementById('zedBalanceChartContainer')?.classList.add('hidden');
        }
        function readFormData() { // Only reads from form; calculations/derivations happen in handleFormSubmit
            if(!horseIdInput || !inputName || !inputSireGen || !inputDamGen) { console.error("Critical form elements missing in readFormData"); return {};}
            const getStarValue = (selectElement) => { if (!selectElement) return ""; return selectElement.value === "-" ? "" : selectElement.value; };
            const formData = {
                id: parseInt(horseIdInput.value) || null, name: inputName.value.trim(), gen: inputGen.value, gender: inputGender.value, breed: inputBreed.value, colourTrait: inputColourTrait.value,
                sireName: inputSireName.value.trim(), sireGen: inputSireGen.value, sireBreed: inputSireBreed.value, sireColourTrait: inputSireColourTrait.value, sireOverall: getStarValue(inputSireOverall), sireSpeed: getStarValue(inputSireSpeed), sireSprint: getStarValue(inputSireSprint), sireEndurance: getStarValue(inputSireEndurance),
                damName: inputDamName.value.trim(), damGen: inputDamGen.value, damBreed: inputDamBreed.value, damColourTrait: inputDamColourTrait.value, damOverall: getStarValue(inputDamOverall), damSpeed: getStarValue(inputDamSpeed), damSprint: getStarValue(inputDamSprint), damEndurance: getStarValue(inputDamEndurance),
                overall: getStarValue(inputOverall), speed: getStarValue(inputSpeed), sprint: getStarValue(inputSprint), endurance: getStarValue(inputEndurance),
                races: parseInt(inputRaces.value) || 0, first: parseInt(inputFirst.value) || 0, second: parseInt(inputSecond.value) || 0, third: parseInt(inputThird.value) || 0,
                cpu: inputCPU.value, ram: inputRAM.value, hydraulic: inputHydraulic.value,
                breedCost: inputBreedCost.value.trim(),
                zedBalance: inputZedBalance.value.trim(), // Read for edit, ignored for new
                soldBreeds: inputSoldBreeds.value.trim(),
                status: 'active', order: null,
                // strtZedBal and totalRaceNetPL are not read from form, they are set/preserved in handleFormSubmit
            };
            const sireInDb = findHorseByName(formData.sireName);
            if(sireInDb) {
                if (!formData.sireGen && sireInDb.gen) formData.sireGen = sireInDb.gen;
                if (!formData.sireBreed && sireInDb.breed) formData.sireBreed = sireInDb.breed;
                if ((!formData.sireOverall || formData.sireOverall === '-') && sireInDb.overall) formData.sireOverall = sireInDb.overall;
                if ((!formData.sireSpeed || formData.sireSpeed === '-') && sireInDb.speed) formData.sireSpeed = sireInDb.speed;
                if ((!formData.sireSprint || formData.sireSprint === '-') && sireInDb.sprint) formData.sireSprint = sireInDb.sprint;
                if ((!formData.sireEndurance || formData.sireEndurance === '-') && sireInDb.endurance) formData.sireEndurance = sireInDb.endurance;
                if (!formData.sireColourTrait && sireInDb.colourTrait) formData.sireColourTrait = sireInDb.colourTrait;
            }
            const damInDb = findHorseByName(formData.damName);
            if(damInDb) {
                if (!formData.damGen && damInDb.gen) formData.damGen = damInDb.gen;
                if (!formData.damBreed && damInDb.breed) formData.damBreed = damInDb.breed;
                if ((!formData.damOverall || formData.damOverall === '-') && damInDb.overall) formData.damOverall = damInDb.overall;
                if ((!formData.damSpeed || formData.damSpeed === '-') && damInDb.speed) formData.damSpeed = damInDb.speed;
                if ((!formData.damSprint || formData.damSprint === '-') && damInDb.sprint) formData.damSprint = damInDb.sprint;
                if ((!formData.damEndurance || formData.damEndurance === '-') && damInDb.endurance) formData.damEndurance = damInDb.endurance;
                if (!formData.damColourTrait && damInDb.colourTrait) formData.damColourTrait = damInDb.colourTrait;
            }
            if (formData.id) { // If editing an existing item
                const originalItem = findHorseById(formData.id);
                if (originalItem) {
                    formData.status = originalItem.status;
                    formData.order = originalItem.order;
                    formData.totalRaceNetPL = originalItem.totalRaceNetPL || "0"; // Preserve existing totalRaceNetPL
                    formData.race1Time = originalItem.race1Time; // Preserve these
                    formData.race2Time = originalItem.race2Time;
                 }
            }
            return formData;
        }
        function cancelDetailForm() { if(!horseFormDiv || !mainActionsDiv) return; horseFormDiv.classList.add('hidden'); mainActionsDiv.classList.remove('hidden'); if (currentDetailHorseId) renderHorseDetail(currentDetailHorseId); else showPage('overviewPage'); }
        function handleSendToBreedingPool() { if (!currentDetailHorseId) { alert("No item selected."); return; } const index = findIndexById(currentDetailHorseId); if (index === -1) { alert("Item not found."); return; } if (horsesData[index].status === 'forged') { alert("Cannot send removed item."); return; } if (window.confirm(`Send "${horsesData[index].name}" to Pool?`)) { horsesData[index].status = 'breeding'; saveHorsesData(); alert(`"${horsesData[index].name}" sent to Pool.`); renderHorseDetail(currentDetailHorseId); populateHorseSelectorForDetail(); } }
        function handleForgeHorse() { if (!currentDetailHorseId) { alert("No item selected."); return; } const index = findIndexById(currentDetailHorseId); if (index === -1) { alert("Item not found."); return; } if (horsesData[index].status === 'forged') { alert("Already removed."); return; } if (window.confirm(`Forge "${horsesData[index].name}"? Kept for records, cannot be undone easily.`)) { horsesData[index].status = 'forged'; horsesData[index].order = null; saveHorsesData(); alert(`"${horsesData[index].name}" Forged.`); currentDetailHorseId = null; showPage('overviewPage'); } }

        function handleFormSubmit(event) {
             event.preventDefault();
             const formData = readFormData();
             if (!formData.name) { alert("Item Name is required!"); if(inputName) inputName.focus(); return; }
             const editingItemId = formData.id;

             if (editingItemId === null) { // Adding new item
                 formData.id = nextId++;
                 formData.order = horsesData.filter(h => h.status === 'active').reduce((max, h) => Math.max(max, h.order ?? -1), -1) + 1;
                 formData.status = 'active';
                 formData.soldBreeds = String(parseNumericValue(formData.soldBreeds));

                 const breedCostNum = parseNumericValue(formData.breedCost);
                 formData.strtZedBal = formatNumericValue(breedCostNum / 2);
                 formData.totalRaceNetPL = "0";
                 formData.zedBalance = formData.strtZedBal; // Initial zedBalance = strtZedBal

                 formData.race1TimeHistory = []; formData.race2TimeHistory = [];
                 formData.augmentHistory = []; formData.zedBalanceHistory = [];
                 formData.processedCsvRaceEvents = [];
                 formData.race1Time = null; formData.race2Time = null;

                 // Add initial balance to history
                 if (String(formData.zedBalance).trim() !== "" && (parseNumericValue(formData.zedBalance) !== 0 || String(formData.zedBalance) === "0") ) {
                    formData.zedBalanceHistory.push({ timestamp: Date.now(), balance: formData.zedBalance });
                 }

                 horsesData.push(formData); currentDetailHorseId = formData.id; alert(`${formData.name} added successfully!`);
             } else { // Editing existing item
                 const index = findIndexById(editingItemId);
                 if (index !== -1) {
                     const originalItem = { ...horsesData[index] };
                     if (originalItem.status === 'forged') { alert("Cannot save changes to a removed item."); cancelDetailForm(); return; }

                     // Update breedCost and re-calculate strtZedBal based on form data
                     formData.breedCost = inputBreedCost.value.trim(); // Already set by readFormData if field exists
                     const newBreedCostNum = parseNumericValue(formData.breedCost);
                     formData.strtZedBal = formatNumericValue(newBreedCostNum / 2);

                     // totalRaceNetPL is preserved from original item (read by readFormData)
                     // zedBalance is directly from form input (read by readFormData)

                     formData.soldBreeds = String(parseNumericValue(originalItem.soldBreeds) + parseNumericValue(formData.soldBreeds));

                     if (!Array.isArray(originalItem.augmentHistory)) originalItem.augmentHistory = [];
                     if (originalItem.cpu !== formData.cpu || originalItem.ram !== formData.ram || originalItem.hydraulic !== formData.hydraulic) {
                         originalItem.augmentHistory.push({ timestamp: Date.now(), cpu: formData.cpu, ram: formData.ram, hydraulic: formData.hydraulic });
                     }
                     formData.augmentHistory = originalItem.augmentHistory;

                     if (!Array.isArray(originalItem.zedBalanceHistory)) originalItem.zedBalanceHistory = [];
                     const lastZedBalanceEntry = originalItem.zedBalanceHistory.length > 0 ? originalItem.zedBalanceHistory[originalItem.zedBalanceHistory.length - 1] : null;
                     if (formData.zedBalance && typeof formData.zedBalance === 'string' && formData.zedBalance.trim() !== "" &&
                         (!lastZedBalanceEntry || lastZedBalanceEntry.balance !== formData.zedBalance || (lastZedBalanceEntry && lastZedBalanceEntry.timestamp === Date.now()))) {
                        let newHistTimestamp = Date.now();
                        if (lastZedBalanceEntry && lastZedBalanceEntry.timestamp >= newHistTimestamp) {
                            newHistTimestamp = lastZedBalanceEntry.timestamp + 1;
                        }
                        originalItem.zedBalanceHistory.push({ timestamp: newHistTimestamp, balance: formData.zedBalance });
                     }
                     formData.zedBalanceHistory = originalItem.zedBalanceHistory;

                     formData.race1TimeHistory = originalItem.race1TimeHistory || [];
                     formData.race2TimeHistory = originalItem.race2TimeHistory || [];
                     formData.processedCsvRaceEvents = originalItem.processedCsvRaceEvents || [];
                     formData.race1Time = originalItem.race1Time;
                     formData.race2Time = originalItem.race2Time;

                     horsesData[index] = { ...originalItem, ...formData };
                     currentDetailHorseId = editingItemId;
                     alert(`${formData.name} updated successfully!`);
                 } else { console.error("Update Error: Could not find item with ID", editingItemId); alert("Error updating item data. Item not found."); cancelDetailForm(); return; }
             }
             saveHorsesData(); if(horseFormDiv) horseFormDiv.classList.add('hidden'); if(mainActionsDiv) mainActionsDiv.classList.remove('hidden'); populateHorseSelectorForDetail(); renderHorseDetail(currentDetailHorseId);
         }

        function populateBreedingSelectors() { if(!selectSire || !selectDam || !breedButton || !offspringResultDiv) return; selectSire.innerHTML = '<option value="">-- Select Sire --</option>'; selectDam.innerHTML = '<option value="">-- Select Dam --</option>'; breedButton.disabled = true; offspringResultDiv.classList.add('hidden'); const sires = horsesData.filter(h => h.gender === 'M' && h.status !== 'forged').sort((a, b) => a.name.localeCompare(b.name)); const dams = horsesData.filter(h => h.gender === 'F' && h.status !== 'forged').sort((a, b) => a.name.localeCompare(b.name)); sires.forEach(s => { const o=document.createElement('option'); o.value=s.id; o.textContent=`${s.name} (${s.gen})`; selectSire.appendChild(o); }); dams.forEach(d => { const o=document.createElement('option'); o.value=d.id; o.textContent=`${d.name} (${d.gen})`; selectDam.appendChild(o); }); }
        function checkBreedButtonState() { if(breedButton) breedButton.disabled = !(selectSire.value && selectDam.value); }
        function handleBreedClick() { const sire = findHorseById(parseInt(selectSire.value)), dam = findHorseById(parseInt(selectDam.value)); if (!sire || !dam) { alert("Select Sire & Dam."); return; } tempOffspringData = generateOffspring(sire, dam); displayOffspringResult(tempOffspringData); }
        function generateOffspring(sire, dam) {
            const offGen=`G${Math.max(parseGen(sire.gen),parseGen(dam.gen))+1}`, offGender=Math.random()<0.5?'M':'F', offBreed=Math.random()<0.5?sire.breed:dam.breed, offColour=Math.random()<0.5?sire.colourTrait:dam.colourTrait;
            const calcStat=(sStat,dStat,breed,statName)=>{let sVal=getStarNumericValue(sStat),dVal=getStarNumericValue(dStat),avg=(sVal+dVal)/2,adj=0,rand=(Math.random()*0.5)-0.25;switch(breed){case 'Nakamoto':if(statName==='sprint')adj=0.25;if(statName==='endurance')adj=-0.15;break;case 'Szabo':if(statName==='endurance')adj=0.2;if(statName==='sprint')adj=-0.1;if(statName==='speed')adj=0.1;break;case 'Finney':if(statName==='endurance')adj=0.25;if(statName==='sprint')adj=-0.15;break;case 'Buterin':rand+=(Math.random()*1.0)-0.5;break;} return mapNumericToStars(Math.max(1,Math.min(5,avg+adj+rand)));};
            const simulatedBreedCost = "0";
            const simulatedStrtZedBal = formatNumericValue(parseNumericValue(simulatedBreedCost) / 2);
            return {
                name:"", gen:offGen, gender:offGender, breed:offBreed, colourTrait:offColour,
                sireName:sire.name, sireGen: sire.gen || null, sireBreed:sire.breed, sireColourTrait:sire.colourTrait, sireOverall:sire.overall||"-", sireSpeed:sire.speed||"-", sireSprint:sire.sprint||"-", sireEndurance:sire.endurance||"-",
                damName:dam.name, damGen: dam.gen || null, damBreed:dam.breed, damColourTrait:dam.colourTrait, damOverall:dam.overall||"-", damSpeed:dam.speed||"-", damSprint:dam.sprint||"-", damEndurance:dam.endurance||"-",
                overall:calcStat(sire.overall,dam.overall,offBreed,'overall'), speed:calcStat(sire.speed,dam.speed,offBreed,'speed'), sprint:calcStat(sire.sprint,dam.sprint,offBreed,'sprint'), endurance:calcStat(sire.endurance,dam.endurance,offBreed,'endurance'),
                races:0, first:0, second:0, third:0,
                race1Time:null, race2Time:null,
                cpu:null, ram:null, hydraulic:null,
                breedCost: simulatedBreedCost, strtZedBal: simulatedStrtZedBal, totalRaceNetPL: "0", zedBalance: simulatedStrtZedBal, soldBreeds:"0",
                race1TimeHistory:[], race2TimeHistory:[], augmentHistory:[], zedBalanceHistory:[{timestamp: Date.now(), balance: simulatedStrtZedBal}], processedCsvRaceEvents:[], status:'active', order:null
            };
        }
        function displayOffspringResult(data) { if (!data || !offspringResultDiv || !inputOffspringName) return; inputOffspringName.value = ""; offspringGenSpan.textContent = data.gen||'N/A'; offspringGenderSpan.textContent = data.gender||'N/A'; offspringBreedSpan.textContent = data.breed||'N/A'; offspringColourTraitSpan.textContent = data.colourTrait||'N/A'; offspringOverallSpan.textContent = data.overall||'-'; offspringSpeedSpan.textContent = data.speed||'-'; offspringSprintSpan.textContent = data.sprint||'-'; offspringEnduranceSpan.textContent = data.endurance||'-'; offspringSireNameSpan.textContent = data.sireName||'N/A'; offspringDamNameSpan.textContent = data.damName||'N/A'; offspringResultDiv.classList.remove('hidden'); }
        function handleAddOffspring() {
            if (!tempOffspringData || !inputOffspringName) { alert("No offspring generated or name input missing."); return; }
            const name = inputOffspringName.value.trim(); if (!name) { alert("Enter unique name."); inputOffspringName.focus(); return; }
            if (findHorseByName(name)) { alert(`"${name}" exists.`); inputOffspringName.focus(); return; }
            tempOffspringData.name=name; tempOffspringData.id=nextId++; tempOffspringData.order=horsesData.filter(h => h.status === 'active').reduce((max, h) => Math.max(max, h.order ?? -1), -1) + 1;
            if (!Array.isArray(tempOffspringData.zedBalanceHistory) || tempOffspringData.zedBalanceHistory.length === 0) { // Ensure history for new if somehow cleared
                tempOffspringData.zedBalanceHistory = [{timestamp: Date.now(), balance: tempOffspringData.zedBalance}];
            }
            if (!Array.isArray(tempOffspringData.race1TimeHistory)) tempOffspringData.race1TimeHistory = [];
            if (!Array.isArray(tempOffspringData.race2TimeHistory)) tempOffspringData.race2TimeHistory = [];
            if (!Array.isArray(tempOffspringData.processedCsvRaceEvents)) tempOffspringData.processedCsvRaceEvents = [];
            horsesData.push(tempOffspringData); saveHorsesData(); alert(`"${name}" added!`);
            populateBreedingSelectors();
            cancelOffspring();
        }
        function cancelOffspring() { if(offspringResultDiv) offspringResultDiv.classList.add('hidden'); tempOffspringData = null; if(inputOffspringName) inputOffspringName.value = ""; }

        function toggleParentEditMode(btn) { const sect=btn.closest('.parent-section'); if(!sect)return; const disp=sect.querySelector('.display-details'), edit=sect.querySelector('.inline-edit-form'), parent=findHorseById(sect.getAttribute('data-parent-id')); if(!disp||!edit||!parent||parent.status==='forged'){alert("Cannot edit not found/removed.");return;} const hidden=edit.classList.contains('hidden'); disp.classList.toggle('hidden',hidden); edit.classList.toggle('hidden',!hidden); btn.classList.toggle('hidden',hidden); if(hidden){ edit.querySelector('.inline-breed').value=parent.breed||""; edit.querySelector('.inline-colour').value=parent.colourTrait||""; edit.querySelector('.inline-gen').value=parent.gen||""; edit.querySelector('.inline-overall').value=parent.overall||"-"; edit.querySelector('.inline-speed').value=parent.speed||"-"; edit.querySelector('.inline-sprint').value=parent.sprint||"-"; edit.querySelector('.inline-endurance').value=parent.endurance||"-"; edit.querySelector('.inline-races').value=parent.races??0; } }
        function cancelParentEdit(btn) { const sect=btn.closest('.parent-section'); if(!sect)return; sect.querySelector('.display-details').classList.remove('hidden'); sect.querySelector('.inline-edit-form').classList.add('hidden'); const editBtn=sect.querySelector('.edit-parent-button'); if(editBtn)editBtn.classList.remove('hidden'); }
        function saveParentEdit(btn) { const sect=btn.closest('.parent-section'); if(!sect)return; const pId=parseInt(sect.getAttribute('data-parent-id')), idx=findIndexById(pId); if(isNaN(pId)||idx===-1||horsesData[idx].status==='forged'){alert("Error saving parent.");cancelParentEdit(btn);return;} const editDiv=sect.querySelector('.inline-edit-form'),getStar=(sel)=>editDiv.querySelector(sel).value==='-'?"":editDiv.querySelector(sel).value; Object.assign(horsesData[idx],{breed:editDiv.querySelector('.inline-breed').value,colourTrait:editDiv.querySelector('.inline-colour').value,gen:editDiv.querySelector('.inline-gen').value,overall:getStar('.inline-overall'),speed:getStar('.inline-speed'),sprint:getStar('.inline-sprint'),endurance:getStar('.inline-endurance'),races:parseInt(editDiv.querySelector('.inline-races').value)||0}); saveHorsesData(); alert(`Details for ${horsesData[idx].name} updated.`); renderBreedsPage(); renderLineagePage(); }

        function applyTheme(dark) {
            document.body.classList.toggle('dark-mode', dark);
            if(darkModeToggle) darkModeToggle.checked = dark;
        }
        function toggleTheme() {
            const newIsDark = !document.body.classList.contains('dark-mode');
            applyTheme(newIsDark);
            localStorage.setItem('darkMode', newIsDark ? 'true' : 'false');
            if (detailPage && !detailPage.classList.contains('hidden') && currentDetailHorseId !== null) {
                renderHorseDetail(currentDetailHorseId);
            }
        }
        window.onscroll = function() { scrollTrigger(); }; function scrollTrigger() { if (scrollTopButton) scrollTopButton.style.display = (document.documentElement.scrollTop || document.body.scrollTop) > 200 ? "block" : "none"; }
        function backToTop() { window.scrollTo({top: 0, behavior: 'smooth'}); }

        function showBackfillRaceIdsUI() {
            console.log('showBackfillRaceIdsUI START. currentDetailHorseId:', currentDetailHorseId);
            if (!currentDetailHorseId || !backfillRaceIdsSection || !backfillHorseName || !backfillRaceListContainer ) {
                console.error("Cannot show backfill UI: missing current horse ID or DOM elements for backfillRaceListContainer."); return;
            }
            const horse = findHorseById(currentDetailHorseId);
            console.log('Horse for backfill:', horse);
            if (!horse) { alert("Horse not found for backfilling Race IDs."); return; }

            backfillHorseName.textContent = horse.name;
            const allHistoricalRaces = getCombinedRaceHistory(horse);
            console.log('Historical races to populate:', allHistoricalRaces);

            populateBackfillList(allHistoricalRaces, horse.id);

            if(horseProfileDisplayDiv) horseProfileDisplayDiv.classList.add('hidden');
            if(mainActionsDiv) mainActionsDiv.classList.add('hidden'); // Also hide main actions
            if(horseFormDiv) horseFormDiv.classList.add('hidden'); // Ensure edit form is hidden

            backfillRaceIdsSection.classList.remove('hidden');
            console.log('showBackfillRaceIdsUI END. backfillRaceIdsSection hidden:', backfillRaceIdsSection.classList.contains('hidden'));
        }

        function populateBackfillList(historicalEntries, horseId) {
            if (!backfillRaceListContainer) {
                console.error("populateBackfillList: backfillRaceListContainer is missing.");
                return;
            }
            backfillRaceListContainer.innerHTML = '';
            console.log(`populateBackfillList: Starting. Found ${historicalEntries.length} entries for horse ID ${horseId}.`);

            if (historicalEntries.length === 0) {
                backfillRaceListContainer.innerHTML = '<p><em>No historical race entries found for this item.</em></p>';
                console.log("populateBackfillList: No entries to display.");
                return;
            }

            historicalEntries.forEach((entry, index) => { // Added index for logging
                console.log(`populateBackfillList: Processing entry ${index + 1}/${historicalEntries.length}`, entry);

                const entryDiv = document.createElement('div');
                entryDiv.className = 'race-entry-backfill';
                entryDiv.setAttribute('data-history-array-name', entry.originalArrayName);
                entryDiv.setAttribute('data-original-index', entry.originalArrayIndex);

                const originalDateObj = new Date(entry.timestamp);
                let displayDate = 'N/A', displayTime = 'N/A';

                console.log(`populateBackfillList: Entry ${index + 1} - Original timestamp: ${entry.timestamp}, Parsed Date Obj:`, originalDateObj, `Is NaN: ${isNaN(originalDateObj.valueOf())}`);


                if (originalDateObj && !isNaN(originalDateObj.valueOf())) {
                    try {
                        const month = (originalDateObj.getMonth() + 1).toString().padStart(2, '0');
                        const day = originalDateObj.getDate().toString().padStart(2, '0');
                        const year = originalDateObj.getFullYear();
                        displayDate = `${month}/${day}/${year}`;

                        const hours = originalDateObj.getHours().toString().padStart(2, '0');
                        const minutes = originalDateObj.getMinutes().toString().padStart(2, '0');
                        displayTime = `${hours}:${minutes}`;
                        console.log(`populateBackfillList: Entry ${index + 1} - Formatted displayDate: ${displayDate}, displayTime: ${displayTime}`);
                    } catch (e) {
                        console.warn(`populateBackfillList: Entry ${index + 1} - Error formatting date:`, e, "Timestamp was:", entry.timestamp);
                    }
                } else {
                    console.warn(`populateBackfillList: Entry ${index + 1} - Invalid timestamp or Date object. Timestamp:`, entry.timestamp, "Parsed Date:", originalDateObj);
                }

                entryDiv.innerHTML = `
                    <div class="form-group-inline">
                        <label for="backfill-date-${horseId}-${entry.originalArrayName}-${entry.originalArrayIndex}">Date (MM/DD/YYYY):</label>
                        <input type="text" class="backfill-date" id="backfill-date-${horseId}-${entry.originalArrayName}-${entry.originalArrayIndex}" value="${displayDate}" placeholder="MM/DD/YYYY">
                        <label for="backfill-timeofday-${horseId}-${entry.originalArrayName}-${entry.originalArrayIndex}" style="margin-left:10px;">Time (HH:MM):</label>
                        <input type="text" class="backfill-timeofday" id="backfill-timeofday-${horseId}-${entry.originalArrayName}-${entry.originalArrayIndex}" value="${displayTime}" placeholder="HH:MM">
                    </div>
                    <div class="form-group-inline">
                        <label for="backfill-finishtime-${horseId}-${entry.originalArrayName}-${entry.originalArrayIndex}">Finish Time:</label>
                        <input type="text" class="backfill-finishtime" id="backfill-finishtime-${horseId}-${entry.originalArrayName}-${entry.originalArrayIndex}" value="${entry.time || ''}" placeholder="e.g., 1:23.45 or 83.45">
                    </div>
                    <div class="form-group-inline">
                        <label for="backfill-raceid-${horseId}-${entry.originalArrayName}-${entry.originalArrayIndex}">Race ID:</label>
                        <input type="text" class="backfill-raceid" id="backfill-raceid-${horseId}-${entry.originalArrayName}-${entry.originalArrayIndex}" value="${entry.race_id || ''}" placeholder="Enter Race ID">
                    </div>
                `;
                try {
                    backfillRaceListContainer.appendChild(entryDiv);
                    console.log(`populateBackfillList: Entry ${index + 1} - Appended to container.`);
                } catch (e) {
                    console.error(`populateBackfillList: Entry ${index + 1} - Error appending entryDiv:`, e, entryDiv);
                }
            });
            console.log("populateBackfillList: Finished processing all entries.");
        }


        function closeBackfillSection() {
            if(backfillRaceIdsSection) backfillRaceIdsSection.classList.add('hidden');
            if(mainActionsDiv) mainActionsDiv.classList.remove('hidden'); // Show main actions again
            if(horseProfileDisplayDiv && currentDetailHorseId) {
                 horseProfileDisplayDiv.classList.remove('hidden');
                 renderHorseDetail(currentDetailHorseId); // Re-render the profile which also handles charts
            }
        }

        function handleSaveBackfilledRaceIds() {
            if (!currentDetailHorseId) { alert("No horse selected."); return; }
            const horseIndex = findIndexById(currentDetailHorseId);
            if (horseIndex === -1) { alert("Horse not found."); return; }

            let horse = horsesData[horseIndex];
            let changesMade = false;

            document.querySelectorAll('#backfillRaceListContainer .race-entry-backfill').forEach(entryDiv => {
                const historyArrayName = entryDiv.dataset.historyArrayName;
                const originalIndex = parseInt(entryDiv.dataset.originalIndex);

                if (!historyArrayName || isNaN(originalIndex) || !horse[historyArrayName] || !horse[historyArrayName][originalIndex]) {
                    console.warn("Could not find original entry for backfill item:", entryDiv);
                    return;
                }
                const raceEntry = horse[historyArrayName][originalIndex];
                const originalTimestamp = raceEntry.timestamp;
                const originalFinishTime = raceEntry.time;
                const originalRaceId = raceEntry.race_id;

                let newTimestamp = originalTimestamp;
                const newDateStr = entryDiv.querySelector('.backfill-date').value.trim();
                const newTimeOfDayStr = entryDiv.querySelector('.backfill-timeofday').value.trim();

                if (newDateStr && newTimeOfDayStr) {
                    const dateParts = newDateStr.split('/');
                    const timeParts = newTimeOfDayStr.split(':');

                    if (dateParts.length === 3 && timeParts.length === 2) {
                        const month = parseInt(dateParts[0], 10) - 1; // JS months are 0-indexed
                        const day = parseInt(dateParts[1], 10);
                        const year = parseInt(dateParts[2], 10);
                        const hours = parseInt(timeParts[0], 10);
                        const minutes = parseInt(timeParts[1], 10);

                        if (!isNaN(month) && !isNaN(day) && !isNaN(year) && !isNaN(hours) && !isNaN(minutes)) {
                            const parsedDateObj = new Date(year, month, day, hours, minutes);
                            if (parsedDateObj && !isNaN(parsedDateObj.valueOf()) &&
                                parsedDateObj.getFullYear() === year &&
                                parsedDateObj.getMonth() === month &&
                                parsedDateObj.getDate() === day &&
                                parsedDateObj.getHours() === hours &&
                                parsedDateObj.getMinutes() === minutes) {
                                newTimestamp = parsedDateObj.getTime();
                            } else {
                                console.warn(`  Invalid date/time value for backfill: Date='${newDateStr}', Time='${newTimeOfDayStr}'. Resulted in invalid Date object or mismatch.`);
                            }
                        } else {
                             console.warn(`  Non-numeric parts in date/time for backfill: Date='${newDateStr}', Time='${newTimeOfDayStr}'.`);
                        }
                    } else {
                        console.warn(`  Incorrect date/time string structure for backfill: Date='${newDateStr}', Time='${newTimeOfDayStr}'. Expected MM/DD/YYYY and HH:MM.`);
                    }
                }
                if (raceEntry.timestamp !== newTimestamp) { raceEntry.timestamp = newTimestamp; changesMade = true; }

                let newFormattedFinishTime = originalFinishTime;
                const newFinishTimeStr = entryDiv.querySelector('.backfill-finishtime').value.trim();
                if (newFinishTimeStr) {
                    const parsedNewTime = parseRaceTime(newFinishTimeStr);
                    if (parsedNewTime !== null) { newFormattedFinishTime = formatSecondsToTime(parsedNewTime); }
                    else { console.warn(`Invalid finish time format: ${newFinishTimeStr}.`); newFormattedFinishTime = originalFinishTime; }
                }
                if (raceEntry.time !== newFormattedFinishTime) { raceEntry.time = newFormattedFinishTime; changesMade = true; }

                const newRaceId = entryDiv.querySelector('.backfill-raceid').value.trim() || null;
                if (originalRaceId !== newRaceId) {
                    if (originalRaceId) {
                        const oldKey = `${horse.id}_${originalRaceId}`;
                        if (Array.isArray(horse.processedCsvRaceEvents)) {
                            const idx = horse.processedCsvRaceEvents.indexOf(oldKey);
                            if (idx > -1) horse.processedCsvRaceEvents.splice(idx, 1);
                        }
                    }
                    if (newRaceId) {
                        const newKey = `${horse.id}_${newRaceId}`;
                        if (!Array.isArray(horse.processedCsvRaceEvents)) horse.processedCsvRaceEvents = [];
                        if (!horse.processedCsvRaceEvents.includes(newKey)) horse.processedCsvRaceEvents.push(newKey);
                    }
                    raceEntry.race_id = newRaceId;
                    changesMade = true;
                }
            });

            if (changesMade) {
                saveHorsesData();
                alert("Historical race data updated successfully!");
                closeBackfillSection(); // This will re-render the detail page, including charts
            } else {
                alert("No changes were made to the historical race data.");
            }
        }


        function renderCsvPreview() {
            if (!csvPreviewContent || !confirmCsvImportBtn) return;
            csvPreviewContent.innerHTML = '';
            const actualChangesToApply = stagedCsvChanges.filter(c => !c.isNew && !c.isDuplicate && c.updates.length > 0);

            if (stagedCsvChanges.length === 0) {
                csvPreviewContent.innerHTML = '<p>No records found for the selected stable in the CSV.</p>';
                confirmCsvImportBtn.disabled = true; return;
            }
            if (actualChangesToApply.length === 0 && stagedCsvChanges.some(c => c.isDuplicate || c.isNew || c.updates.length === 0)) {
                 csvPreviewContent.innerHTML = '<p>All relevant CSV records for existing horses have already been processed or would result in no change.</p>';
                 stagedCsvChanges.forEach(horseChange => {
                    const horseDiv = document.createElement('div');
                    horseDiv.className = 'horse-changes';
                     let html = `<h4>${horseChange.horseName} `;
                    if(horseChange.isNew) html += `<span style="color: orange; font-style: italic;"> (Not in manager - will be skipped)</span>`;
                    else if(horseChange.isDuplicate) html += `<span class="duplicate-notice"> (Race ID: ${horseChange.csvRaceId} - Already processed, will be skipped)</span>`;
                    else html += `<span style="color: grey; font-style: italic;"> (No new updates from CSV for Race ID: ${horseChange.csvRaceId})</span>`;
                    html += `</h4>`;
                    horseDiv.innerHTML = html;
                    csvPreviewContent.appendChild(horseDiv);
                 });
                confirmCsvImportBtn.disabled = true; return;
            }

            confirmCsvImportBtn.disabled = false;
            stagedCsvChanges.forEach(horseChange => {
                const horseDiv = document.createElement('div');
                horseDiv.className = 'horse-changes';
                let html = `<h4>${horseChange.horseName} `;
                if (horseChange.isNew) {
                    html += `<span style="color: orange; font-style: italic;"> (Not in manager - will be skipped)</span></h4>`;
                    html += `<p><em>Data for this horse will not be imported as it's not in your current list.</em></p>`;
                } else if (horseChange.isDuplicate) {
                    html += `<span class="duplicate-notice"> (Race ID: ${horseChange.csvRaceId} - Already processed, will be skipped)</span></h4>`;
                } else if (horseChange.updates.length === 0) {
                     html += `<span style="color: grey; font-style: italic;"> (No new updates from CSV for Race ID: ${horseChange.csvRaceId})</span></h4>`;
                }
                else {
                    html += `(Race ID: ${horseChange.csvRaceId})</h4>`;
                    horseChange.updates.forEach(update => { html += `<p><strong>${update.field}:</strong> ${update.oldVal} <span class="value-arrow">→</span> <span class="change-highlight">${update.newVal}</span></p>`; });
                }
                horseDiv.innerHTML = html; csvPreviewContent.appendChild(horseDiv);
            });
        }
        function closeCsvPreviewModal() { if(csvPreviewModal) csvPreviewModal.classList.add('hidden'); stagedCsvChanges = []; }

        function applyStagedCsvChanges() {
            console.log("--- applyStagedCsvChanges START ---");
            console.log("Staged CSV Changes (at start of apply):", JSON.parse(JSON.stringify(stagedCsvChanges)));

            const changesToApply = stagedCsvChanges.filter(c => !c.isNew && !c.isDuplicate && c.updates.length > 0);
            console.log("Filtered 'changesToApply':", JSON.parse(JSON.stringify(changesToApply)));

            if (changesToApply.length === 0) {
                alert("No actual new changes to apply from this CSV import (all might be new horses, duplicates, or no effective updates).");
                console.log("No changes to apply, exiting applyStagedCsvChanges.");
                closeCsvPreviewModal();
                return;
            }

            console.log("Proceeding with applying changes...");
            try {
                horsesDataBackupBeforeCsv = JSON.parse(JSON.stringify(horsesData));
                console.log("Data backup created.");
            } catch (e) {
                console.error("Error creating backup for CSV undo:", e);
                alert("Critical error: Could not create data backup. CSV import aborted.");
                closeCsvPreviewModal();
                return;
            }
            if(undoCsvImportBtn) undoCsvImportBtn.classList.remove('hidden');

            let horsesUpdatedCount = 0;
            const updatedHorseIds = new Set();
            const COL_CSV = { RACE_ID: 'race_id', RACE_DATE: 'race_date', HORSE_NAME: 'horse_name', FINISH_TIME: 'finish_time', STABLE_NAME: 'stable_name', FINISH_POSITION: 'finish_position', PROFIT_LOSS: 'profit_loss', CPU_AUGMENT: 'cpu_augment', RAM_AUGMENT: 'ram_augment', HYDRAULIC_AUGMENT: 'hydraulic_augment', BLOODLINE: 'bloodline', GENERATION: 'generation' };


            changesToApply.forEach(change => {
                const horseIndex = findIndexById(change.horseId);
                if (horseIndex === -1) {
                    console.warn(`Horse "${change.horseName}" with ID ${change.horseId} not found during apply. Skipping.`);
                    return;
                }

                let horse = horsesData[horseIndex];
                const rec = change.originalRecord;

                console.log(`Processing horse: ${horse.name} (ID: ${horse.id}) for CSV Race ID: ${change.csvRaceId}`);

                if (Array.isArray(horse.processedCsvRaceEvents) && horse.processedCsvRaceEvents.includes(change.uniqueRaceEventKey)) {
                    console.warn(`Skipping already processed event during apply: ${change.uniqueRaceEventKey} for horse ${horse.name}`);
                    return;
                }

                let modifiedInThisRecord = false;

                const originalRaces = horse.races;
                horse.races = (parseInt(horse.races) || 0) + 1;
                if(originalRaces !== horse.races) {
                    console.log(`  Races updated: ${originalRaces} -> ${horse.races}`);
                    modifiedInThisRecord = true;
                }

                const pos = parseInt(rec[COL_CSV.FINISH_POSITION]);
                if (!isNaN(pos)) {
                    if (pos === 1) { horse.first = (parseInt(horse.first) || 0) + 1; console.log(`  1st places updated.`); modifiedInThisRecord = true; }
                    else if (pos === 2) { horse.second = (parseInt(horse.second) || 0) + 1; console.log(`  2nd places updated.`); modifiedInThisRecord = true; }
                    else if (pos === 3) { horse.third = (parseInt(horse.third) || 0) + 1; console.log(`  3rd places updated.`); modifiedInThisRecord = true; }
                }

                const newRaceTime = String(rec[COL_CSV.FINISH_TIME] || '').trim();
                const raceDateStr = String(rec[COL_CSV.RACE_DATE] || '').trim();
                let raceTimestamp = Date.now(); // Default to now if date is invalid/missing
                if (raceDateStr) {
                    const dateParts = raceDateStr.split('/'); // Assuming MM/DD/YYYY from CSV
                    if (dateParts.length === 3) {
                        const month = parseInt(dateParts[0], 10) - 1;
                        const day = parseInt(dateParts[1], 10);
                        const year = parseInt(dateParts[2], 10);
                        if (!isNaN(month) && !isNaN(day) && !isNaN(year)) {
                             const parsedDateObj = new Date(year, month, day);
                             // Basic validation: check if date construction was valid and matches input parts
                             if (parsedDateObj && !isNaN(parsedDateObj.valueOf()) &&
                                parsedDateObj.getFullYear() === year &&
                                parsedDateObj.getMonth() === month &&
                                parsedDateObj.getDate() === day) {
                                raceTimestamp = parsedDateObj.getTime();
                            } else {
                                console.warn(`  Invalid race_date in CSV: "${raceDateStr}". Using current timestamp for event.`);
                            }
                        } else {
                             console.warn(`  Non-numeric parts in race_date in CSV: "${raceDateStr}". Using current timestamp.`);
                        }
                    } else {
                         console.warn(`  Incorrect race_date structure in CSV: "${raceDateStr}". Expected MM/DD/YYYY. Using current timestamp.`);
                    }
                }


                const raceIdFromCsv = String(rec[COL_CSV.RACE_ID] || '').trim();
                if (newRaceTime && parseRaceTime(newRaceTime) !== null) {
                    if (!Array.isArray(horse.race1TimeHistory)) horse.race1TimeHistory = [];
                    horse.race1TimeHistory.push({ timestamp: raceTimestamp, time: newRaceTime, race_id: raceIdFromCsv });
                    console.log(`  Added to race1TimeHistory: ${newRaceTime}, ID: ${raceIdFromCsv}`);
                    modifiedInThisRecord = true;

                    const currentHorseRace1TimeSec = parseRaceTime(horse.race1Time);
                    const newCsvRaceTimeSec = parseRaceTime(newRaceTime);
                     if (horse.race1Time === null || horse.race1Time === "N/A" || (currentHorseRace1TimeSec !== null && newCsvRaceTimeSec < currentHorseRace1TimeSec) ) {
                         horse.race1Time = newRaceTime;
                         console.log(`  Updated horse.race1Time to: ${newRaceTime}`);
                    }
                }

                const profitLossStr = String(rec[COL_CSV.PROFIT_LOSS] || '0').trim();
                const profitLossNum = parseNumericValue(profitLossStr);
                if (!isNaN(profitLossNum)) {
                    const currentTotalRaceNetPL = parseNumericValue(horse.totalRaceNetPL || "0");
                    horse.totalRaceNetPL = formatNumericValue(currentTotalRaceNetPL + profitLossNum);
                    console.log(`  totalRaceNetPL updated: ${formatNumericValue(currentTotalRaceNetPL)} + ${profitLossNum} -> ${horse.totalRaceNetPL}`);

                    const currentHorseZedBalance = parseNumericValue(horse.zedBalance || "0");
                    const newHorseZedBalance = currentHorseZedBalance + profitLossNum;
                    horse.zedBalance = formatNumericValue(newHorseZedBalance);
                    console.log(`  zedBalance updated: ${formatNumericValue(currentHorseZedBalance)} + ${profitLossNum} -> ${horse.zedBalance}`);

                    if (!Array.isArray(horse.zedBalanceHistory)) horse.zedBalanceHistory = [];
                    const lastBalEntry = horse.zedBalanceHistory.length > 0 ? horse.zedBalanceHistory[horse.zedBalanceHistory.length - 1] : null;
                    if (!lastBalEntry || lastBalEntry.balance !== horse.zedBalance || (profitLossNum === 0 && (!lastBalEntry || lastBalEntry.timestamp !== raceTimestamp))) {
                        horse.zedBalanceHistory.push({ timestamp: raceTimestamp, balance: horse.zedBalance });
                        console.log(`  Added to zedBalanceHistory: ${horse.zedBalance}`);
                    }
                    modifiedInThisRecord = true;
                }

                const cpu = String(rec[COL_CSV.CPU_AUGMENT] || '').trim(), ram = String(rec[COL_CSV.RAM_AUGMENT] || '').trim(), hyd = String(rec[COL_CSV.HYDRAULIC_AUGMENT] || '').trim();
                let augChanged = false;
                if (cpu && horse.cpu !== cpu) { horse.cpu = cpu; augChanged = true; console.log(`  CPU updated to: ${cpu}`);}
                if (ram && horse.ram !== ram) { horse.ram = ram; augChanged = true; console.log(`  RAM updated to: ${ram}`);}
                if (hyd && horse.hydraulic !== hyd) { horse.hydraulic = hyd; augChanged = true; console.log(`  Hydraulic updated to: ${hyd}`);}
                if (augChanged) {
                    if (!Array.isArray(horse.augmentHistory)) horse.augmentHistory = [];
                    horse.augmentHistory.push({ timestamp: raceTimestamp, cpu: horse.cpu, ram: horse.ram, hydraulic: horse.hydraulic });
                    console.log(`  Added to augmentHistory.`);
                    modifiedInThisRecord = true;
                }

                const csvBreed = rec[COL_CSV.BLOODLINE] ? mapBloodlineToBreed(String(rec[COL_CSV.BLOODLINE])) : null;
                if ((!horse.breed || horse.breed === "Unknown") && csvBreed) { horse.breed = csvBreed; modifiedInThisRecord = true; console.log(`  Breed updated to: ${csvBreed}`);}
                const csvGen = rec[COL_CSV.GENERATION] ? formatGeneration(String(rec[COL_CSV.GENERATION])) : null;
                if (!horse.gen && csvGen) { horse.gen = csvGen; modifiedInThisRecord = true; console.log(`  Generation updated to: ${csvGen}`);}


                if (modifiedInThisRecord) {
                    console.log(`  Horse ${horse.name} marked as modified for this record. Unique key: ${change.uniqueRaceEventKey}`);
                    if (!Array.isArray(horse.processedCsvRaceEvents)) horse.processedCsvRaceEvents = [];
                    horse.processedCsvRaceEvents.push(change.uniqueRaceEventKey);
                    updatedHorseIds.add(horse.id);
                } else {
                    console.log(`  Horse ${horse.name} NOT marked as modified for this record (CSV Race ID: ${change.csvRaceId}).`);
                }
            });

            horsesUpdatedCount = updatedHorseIds.size;
            console.log(`Total horses updated: ${horsesUpdatedCount}`);

            if (horsesUpdatedCount > 0) {
                saveHorsesData();
                alert(`${horsesUpdatedCount} item(s) updated with new race data from the CSV. Views will be refreshed.`);
                const currentPage = allPages.find(p => p && !p.classList.contains('hidden'));
                if (currentPage) {
                    showPage(currentPage.id);
                    if (currentPage.id === 'detailPage' && currentDetailHorseId && updatedHorseIds.has(currentDetailHorseId)) {
                        renderHorseDetail(currentDetailHorseId);
                    }
                } else { showPage('overviewPage'); }
                populateHorseSelectorForDetail();
            } else {
                alert("No new race data was effectively applied to existing items (possibly all duplicates or no actual changes needed).");
                if(undoCsvImportBtn) undoCsvImportBtn.classList.add('hidden');
                horsesDataBackupBeforeCsv = null;
            }
            closeCsvPreviewModal();
            console.log("--- applyStagedCsvChanges END ---");
        }
        function undoLastCsvImport() {
            if (horsesDataBackupBeforeCsv) {
                if (window.confirm("Are you sure you want to undo the last confirmed CSV import? This action cannot be undone.")) {
                    horsesData = JSON.parse(JSON.stringify(horsesDataBackupBeforeCsv));
                    saveHorsesData();
                    alert("Last CSV import has been undone. Refreshing views.");
                    const currentPage = allPages.find(page => page && !page.classList.contains('hidden'));
                    if (currentPage) {
                        showPage(currentPage.id);
                        if (currentPage.id === 'detailPage' && currentDetailHorseId && findHorseById(currentDetailHorseId)) { renderHorseDetail(currentDetailHorseId); }
                        else if (currentPage.id === 'detailPage') { showPage('overviewPage'); }
                    } else { showPage('overviewPage'); }
                    horsesDataBackupBeforeCsv = null;
                    if(undoCsvImportBtn) undoCsvImportBtn.classList.add('hidden');
                }
            } else { alert("No CSV import to undo or it has already been undone."); }
        }

        function importRaceDataFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.name.endsWith('.csv')) { alert("Please select a CSV file."); event.target.value = null; return; }
            if (!window.Papa) { alert("CSV parsing library (PapaParse) not loaded."); event.target.value = null; return; }

            Papa.parse(file, {
                header: true, skipEmptyLines: true, dynamicTyping: false,
                complete: function(results) {
                    if (results.errors.length > 0) { console.error("CSV Errors:", results.errors); alert("Errors found while parsing CSV."); event.target.value = null; return; }
                    const raceData = results.data;
                    if (!raceData.length) { alert("No data found in CSV."); event.target.value = null; return; }

                    const COL = { RACE_ID: 'race_id', RACE_DATE: 'race_date', HORSE_NAME: 'horse_name', FINISH_TIME: 'finish_time', STABLE_NAME: 'stable_name', FINISH_POSITION: 'finish_position', PROFIT_LOSS: 'profit_loss', CPU_AUGMENT: 'cpu_augment', RAM_AUGMENT: 'ram_augment', HYDRAULIC_AUGMENT: 'hydraulic_augment', BLOODLINE: 'bloodline', GENERATION: 'generation' };
                    const firstRecordKeys = Object.keys(raceData[0]).map(k => k.toLowerCase());
                    const requiredHeaders = [COL.RACE_ID, COL.HORSE_NAME, COL.FINISH_TIME, COL.STABLE_NAME].map(h => h.toLowerCase());

                    if (!requiredHeaders.every(reqHdr => firstRecordKeys.includes(reqHdr))) {
                        alert(`CSV must contain at least headers (case-insensitive): '${COL.RACE_ID}', '${COL.HORSE_NAME}', '${COL.FINISH_TIME}', and '${COL.STABLE_NAME}'.\nFound: ${Object.keys(raceData[0]).join(', ')}`);
                        event.target.value = null; return;
                    }


                    const userStableNameInput = prompt("Enter YOUR ZED Stable Name (as it appears in the CSV):");
                    if (!userStableNameInput || userStableNameInput.trim() === "") { alert("Stable Name is required to filter records. Import cancelled."); if(event.target) event.target.value = null; return; }
                    const userStableNameLower = userStableNameInput.toLowerCase().trim();

                    stagedCsvChanges = [];
                    let recordsToPreviewCount = 0;

                    raceData.forEach(rawRec => {
                        const rec = {};
                        for (const key in rawRec) { rec[key.toLowerCase()] = rawRec[key]; }


                        const stableNameFromCSV = String(rec[COL.STABLE_NAME.toLowerCase()] || '').toLowerCase().trim();
                        if (stableNameFromCSV !== userStableNameLower) return;

                        recordsToPreviewCount++;
                        const horseNameFromCSV = String(rec[COL.HORSE_NAME.toLowerCase()] || '').trim();
                        if (!horseNameFromCSV) { console.warn("Skipping CSV: missing horse name", rec); return; }

                        const csvRaceId = String(rec[COL.RACE_ID.toLowerCase()] || '').trim();
                        if (!csvRaceId) { console.warn("Skipping CSV: missing RACE_ID", rec); return; }

                        const horseIndex = horsesData.findIndex(h => h.name.toLowerCase() === horseNameFromCSV.toLowerCase() && h.status !== 'forged');
                        let existingHorseDataForPreview = null;
                        if (horseIndex !== -1) {
                            existingHorseDataForPreview = { ...horsesData[horseIndex] };
                            if (!Array.isArray(existingHorseDataForPreview.processedCsvRaceEvents)) {
                                existingHorseDataForPreview.processedCsvRaceEvents = [];
                            }
                        } else {
                            stagedCsvChanges.push({ horseName: horseNameFromCSV, isNew: true, csvRaceId: csvRaceId, originalRecord: rec, updates: [{field: "Status", oldVal: "N/A", newVal: "Not in manager - will be skipped"}] });
                            return;
                        }

                        const uniqueRaceEventKey = `${existingHorseDataForPreview.id}_${csvRaceId}`;
                        const isDuplicate = existingHorseDataForPreview.processedCsvRaceEvents.includes(uniqueRaceEventKey);

                        const changes = {
                            horseName: existingHorseDataForPreview.name,
                            horseId: existingHorseDataForPreview.id,
                            csvRaceId: csvRaceId,
                            uniqueRaceEventKey: uniqueRaceEventKey,
                            updates: [],
                            isDuplicate: isDuplicate,
                            isNew: false,
                            originalRecord: rec
                        };

                        if (isDuplicate) {
                            changes.updates.push({ field: "Race Event", oldVal: `ID: ${csvRaceId}`, newVal: "Already processed - will be skipped." });
                        } else {
                            const newRaceCount = (parseInt(existingHorseDataForPreview.races) || 0) + 1;
                            changes.updates.push({ field: "Races", oldVal: existingHorseDataForPreview.races || 0, newVal: newRaceCount });
                            const pos = parseInt(rec[COL.FINISH_POSITION.toLowerCase()]);
                            if (!isNaN(pos)) {
                                if (pos === 1) changes.updates.push({ field: "1st Places", oldVal: existingHorseDataForPreview.first || 0, newVal: (existingHorseDataForPreview.first || 0) + 1 });
                                else if (pos === 2) changes.updates.push({ field: "2nd Places", oldVal: existingHorseDataForPreview.second || 0, newVal: (existingHorseDataForPreview.second || 0) + 1 });
                                else if (pos === 3) changes.updates.push({ field: "3rd Places", oldVal: existingHorseDataForPreview.third || 0, newVal: (existingHorseDataForPreview.third || 0) + 1 });
                            }
                            const newRaceTimeVal = String(rec[COL.FINISH_TIME.toLowerCase()] || '').trim();
                            if (newRaceTimeVal && parseRaceTime(newRaceTimeVal) !== null) changes.updates.push({ field: "Race Time Added to History", oldVal: "N/A", newVal: `Add: ${newRaceTimeVal} (ID: ${csvRaceId}) to history` });

                            const profitLossNum = parseNumericValue(String(rec[COL.PROFIT_LOSS.toLowerCase()] || '0').trim());
                            const currentTotalRaceNetPL = parseNumericValue(existingHorseDataForPreview.totalRaceNetPL || "0");
                            const newTotalRaceNetPL = currentTotalRaceNetPL + profitLossNum;
                            changes.updates.push({ field: "Total Race Net P/L", oldVal: formatNumericValue(currentTotalRaceNetPL), newVal: formatNumericValue(newTotalRaceNetPL) });

                            const currentBal = parseNumericValue(existingHorseDataForPreview.zedBalance || "0");
                            const newBal = currentBal + profitLossNum;
                            changes.updates.push({ field: "Current ZED Balance", oldVal: formatNumericValue(currentBal), newVal: formatNumericValue(newBal) });
                            changes.updates.push({ field: "ZED Balance History Updated", oldVal: "N/A", newVal: formatNumericValue(newBal) });


                            const cpu = String(rec[COL.CPU_AUGMENT.toLowerCase()] || '').trim(), ram = String(rec[COL.RAM_AUGMENT.toLowerCase()] || '').trim(), hyd = String(rec[COL.HYDRAULIC_AUGMENT.toLowerCase()] || '').trim();
                            if (cpu && existingHorseDataForPreview.cpu !== cpu) changes.updates.push({ field: "CPU Augment", oldVal: existingHorseDataForPreview.cpu || 'N/A', newVal: cpu });
                            if (ram && existingHorseDataForPreview.ram !== ram) changes.updates.push({ field: "RAM Augment", oldVal: existingHorseDataForPreview.ram || 'N/A', newVal: ram });
                            if (hyd && existingHorseDataForPreview.hydraulic !== hyd) changes.updates.push({ field: "Hydraulic Augment", oldVal: existingHorseDataForPreview.hydraulic || 'N/A', newVal: hyd });
                             if( (cpu && existingHorseDataForPreview.cpu !== cpu) || (ram && existingHorseDataForPreview.ram !== ram) || (hyd && existingHorseDataForPreview.hydraulic !== hyd)) {
                                changes.updates.push({ field: "Augment History Updated", oldVal: "N/A", newVal: `CPU:${cpu||'N/A'}, RAM:${ram||'N/A'}, HYD:${hyd||'N/A'}` });
                            }
                            const csvBreed = rec[COL.BLOODLINE.toLowerCase()] ? mapBloodlineToBreed(String(rec[COL.BLOODLINE.toLowerCase()])) : null;
                            if ((!existingHorseDataForPreview.breed || existingHorseDataForPreview.breed === "Unknown") && csvBreed) changes.updates.push({ field: "Breed", oldVal: existingHorseDataForPreview.breed || 'Unknown', newVal: csvBreed });
                            const csvGen = rec[COL.GENERATION.toLowerCase()] ? formatGeneration(String(rec[COL.GENERATION.toLowerCase()])) : null;
                            if (!existingHorseDataForPreview.gen && csvGen) changes.updates.push({ field: "Generation", oldVal: existingHorseDataForPreview.gen || 'N/A', newVal: csvGen });
                        }
                        if(changes.updates.length > 0 || changes.isNew || changes.isDuplicate) {
                            stagedCsvChanges.push(changes);
                        }
                    });

                    if (recordsToPreviewCount === 0 && raceData.length > 0) alert(`No records found for stable "${userStableNameInput}" in the CSV to preview.`);
                    else if (stagedCsvChanges.length > 0) { renderCsvPreview(); if(csvPreviewModal) csvPreviewModal.classList.remove('hidden'); }
                    else if (recordsToPreviewCount > 0 && stagedCsvChanges.length === 0 ) alert(`Processed ${recordsToPreviewCount} records for stable "${userStableNameInput}", but no changes or only duplicate races found.`);
                    else alert("No data processed from CSV or no matching horses found for preview.");
                }, error:(err)=>{console.error("CSV Parse Error:",err);alert("Error parsing CSV."); event.target.value = null;}
            });
            if(event.target) event.target.value = null;
        }
        function mapBloodlineToBreed(bloodline) { if (!bloodline) return ""; const upperBloodline = bloodline.toUpperCase(); switch (upperBloodline) { case 'NAKAMOTO': return 'Nakamoto'; case 'SZABO': return 'Szabo'; case 'FINNEY': return 'Finney'; case 'BUTERIN': return 'Buterin'; default: return bloodline; } }
        function formatGeneration(generation) { if (!generation) return ""; return generation; }

        function getDragAfterElement(container, y) { const els=[...container.querySelectorAll('tr[draggable="true"]:not(.dragging)')]; return els.reduce((closest, child)=>{const box=child.getBoundingClientRect(),offset=y-box.top-box.height/2; return (offset<0&&offset>closest.offset)?{offset:offset,element:child}:closest;},{offset:Number.NEGATIVE_INFINITY}).element; }


        document.addEventListener('DOMContentLoaded', () => {
            if(horseSelector) horseSelector.addEventListener('change', (e) => { const id = e.target.value; if (id && id !== "") showDetailPage(id); else { currentDetailHorseId = null; if(horseProfileDisplayDiv) horseProfileDisplayDiv.classList.add('hidden'); if(horseFormDiv) horseFormDiv.classList.add('hidden'); if(mainActionsDiv) mainActionsDiv.classList.remove('hidden'); hideDetailActionButtons(); if(horseProfileDisplayDiv) horseProfileDisplayDiv.innerHTML = '<p>Select item.</p>'; if(horseProfileDisplayDiv) horseProfileDisplayDiv.classList.remove('hidden'); const rtcCont = document.getElementById('race1TimeChartContainer'); if(rtcCont) rtcCont.classList.add('hidden'); const zbcCont = document.getElementById('zedBalanceChartContainer'); if(zbcCont) zbcCont.classList.add('hidden'); if(backfillRaceIdsSection) backfillRaceIdsSection.classList.add('hidden'); } });
            if(editButton) editButton.addEventListener('click', showEditForm);
            if(sendToBreedingPoolButton) sendToBreedingPoolButton.addEventListener('click', handleSendToBreedingPool);
            if(forgeButton) forgeButton.addEventListener('click', handleForgeHorse);
            if(cancelButton) cancelButton.addEventListener('click', cancelDetailForm);
            if(editAddForm) editAddForm.addEventListener('submit', handleFormSubmit);
            if(prevHorseBtn) prevHorseBtn.addEventListener('click', () => { if (!currentDetailHorseId) return; const items = getNavigableHorses(), index = items.findIndex(h => h.id === currentDetailHorseId); if (index > 0) showDetailPage(items[index - 1].id); });
            if(nextHorseBtn) nextHorseBtn.addEventListener('click', () => { if (!currentDetailHorseId) return; const items = getNavigableHorses(), index = items.findIndex(h => h.id === currentDetailHorseId); if (index !== -1 && index < items.length - 1) showDetailPage(items[index + 1].id); });
            if(breedingRecordsList) breedingRecordsList.addEventListener('click', (e) => { const btn = e.target.closest('button'); if (btn) { if (btn.classList.contains('edit-offspring-button')) { const id=btn.getAttribute('data-id'); if(id) showDetailPage(id); } else if (btn.classList.contains('edit-parent-button')) toggleParentEditMode(btn); else if (btn.classList.contains('save-parent-edit')) saveParentEdit(btn); else if (btn.classList.contains('cancel-parent-edit')) cancelParentEdit(btn); } });
            if(selectSire && selectDam && breedButton) { selectSire.addEventListener('change', checkBreedButtonState); selectDam.addEventListener('change', checkBreedButtonState); breedButton.addEventListener('click', handleBreedClick); }
            if(addOffspringButton) addOffspringButton.addEventListener('click', handleAddOffspring);
            if(importFileInput) importFileInput.addEventListener('change', importData);
            if (importRaceCsvFileInput) importRaceCsvFileInput.addEventListener('change', importRaceDataFromCSV);
            if(darkModeToggle) darkModeToggle.addEventListener('change', toggleTheme);
            if (scrollTopButton) scrollTopButton.addEventListener('click', backToTop);
            if(confirmCsvImportBtn) confirmCsvImportBtn.addEventListener('click', applyStagedCsvChanges);
            if(undoCsvImportBtn) undoCsvImportBtn.addEventListener('click', undoLastCsvImport);
            if(manageRaceIdsBtn) manageRaceIdsBtn.addEventListener('click', showBackfillRaceIdsUI);
            if(saveBackfilledRaceIdsBtn) saveBackfilledRaceIdsBtn.addEventListener('click', handleSaveBackfilledRaceIds);


            if(horseTableBody) {
                horseTableBody.addEventListener('dragstart', (e) => { if (e.target.tagName==='TR'&&e.target.hasAttribute('draggable')) { draggedRow=e.target; draggedRow.classList.add('dragging'); e.dataTransfer.setData('text/plain', draggedRow.dataset.horseId); e.dataTransfer.effectAllowed='move'; } else e.preventDefault(); });
                horseTableBody.addEventListener('dragend', () => { if(draggedRow) draggedRow.classList.remove('dragging'); horseTableBody.querySelectorAll('.drag-over').forEach(row => row.classList.remove('drag-over')); draggedRow=null; });
                horseTableBody.addEventListener('dragover', (e) => { e.preventDefault(); const after=getDragAfterElement(horseTableBody, e.clientY); const current=horseTableBody.querySelector('.drag-over'); if (current&&current!==after&&current!==after?.previousElementSibling) current.classList.remove('drag-over'); if (after&&after!==draggedRow) after.classList.add('drag-over'); e.dataTransfer.dropEffect='move'; });
                horseTableBody.addEventListener('dragleave', (e) => { if (e.relatedTarget && e.relatedTarget.closest('tbody') !== horseTableBody) horseTableBody.querySelectorAll('.drag-over').forEach(row => row.classList.remove('drag-over')); });
                horseTableBody.addEventListener('drop', (e) => { e.preventDefault(); horseTableBody.querySelectorAll('.drag-over').forEach(row => row.classList.remove('drag-over')); if (!draggedRow) return; const after=getDragAfterElement(horseTableBody, e.clientY), droppedId=parseInt(draggedRow.dataset.horseId); let orderedIds=horsesData.filter(h => h.status === 'active').sort((a, b) => (a.order ?? Infinity) - (b.order ?? Infinity)).map(h => h.id); const oldIdx=orderedIds.indexOf(droppedId); if (oldIdx > -1) orderedIds.splice(oldIdx, 1); let insertIdx=orderedIds.length; if (after) { const targetId=parseInt(after.dataset.horseId), targetIdx=orderedIds.indexOf(targetId); if (targetIdx > -1) insertIdx=targetIdx; } orderedIds.splice(insertIdx, 0, droppedId); let currentOrder=0; orderedIds.forEach(id => { const idx=findIndexById(id); if (idx !== -1) horsesData[idx].order=currentOrder++; }); saveHorsesData(); renderOverviewPage(); draggedRow=null; });
            }

            loadHorsesData();
            applyTheme(localStorage.getItem('darkMode') === 'true');
            showPage('overviewPage');
            scrollTrigger();

            const overviewH2 = document.querySelector('#overviewPage h2'); if(overviewH2) overviewH2.textContent = 'Stable Overview';
            const lineageH2 = document.querySelector('#lineagePage h2'); if(lineageH2) lineageH2.textContent = 'Lineage Viewer';
            const financialsH2 = document.querySelector('#financialsPage h2'); if(financialsH2) financialsH2.textContent = 'Financials Overview';

            const basicInfoH3 = document.querySelector('#basicInfo h3'); if (basicInfoH3) basicInfoH3.textContent = 'Basic Info';
            const statsH3 = document.querySelector('#stats h3'); if (statsH3) statsH3.textContent = 'Stats';
            const raceRecordH3 = document.querySelector('#raceRecord h3'); if (raceRecordH3) raceRecordH3.textContent = 'Race Record';
            const pedigreeH3 = document.querySelector('#pedigree h3'); if (pedigreeH3) pedigreeH3.textContent = 'Pedigree';
            const augmentsH3 = document.querySelector('#augments h3'); if (augmentsH3) augmentsH3.textContent = 'Augments';
            const financialsSecH3 = document.querySelector('#financials h3'); if (financialsSecH3) financialsSecH3.textContent = 'Financials';
        });
    </script>
    <!-- END OF MAIN JAVASCRIPT -->

    <div style="text-align: center; padding: 20px; font-size: 0.9em; color: var(--text-color); line-height: 1.5;">
        <p>Consider supporting development:</p>
        <p style="font-family: monospace; word-break: break-all; margin-top: 0.5em;">0xfAa9eC2Eab2A441709538A80AD12fbeF686B7032 (ZED/ERC-20)</p>
        <p style="margin-top: 1.5em;">© 2025 AI Liberating Games. All Rights Reserved.</p>
    </div>

</body>
</html>
