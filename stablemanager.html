<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stable Manager</title>
    <style>
        /* --- Global Styles --- */
        :root { /* Define light mode colors */
            --body-bg: #dcdcdc;
            --container-bg: #f8f9fa;
            --text-color: #212529; /* General text for light mode */
            --heading-color: #1a1a1a; /* Titles, including chart titles if not overridden by JS */
            --border-color: #dee2e6;
            --border-color-light: #e9ecef;
            --border-color-dark: #cccccc;
            --card-bg: #ffffff;
            --card-shadow: rgba(0,0,0,0.06);
            --table-header-bg: #e9ecef;
            --table-header-color: #495057;
            --table-hover-bg: #f1f1f1;
            --table-footer-bg: #e2e6ea;
            --input-bg: #fff;
            --input-color: #495057;
            --input-border: #ced4da;
            --link-color: #0069d9;
            --link-hover-color: #004085;
            --inline-form-bg: #f8f9fa;
            --scroll-btn-bg: #5a6268;
            --scroll-btn-hover-bg: #343a40;
            --nav-btn-color: #6c757d;
            --nav-btn-hover-color: #545b62;
            --nav-btn-disabled-bg: #e9ecef;
            --nav-btn-disabled-color: #adb5bd;
            --nav-btn-disabled-border: #ced4da;
            --chart-grid-color: rgba(0, 0, 0, 0.1); /* Grid line color for light mode */
        }

        body.dark-mode { /* Define dark mode colors */
            --body-bg: #212529;
            --container-bg: #343a40;
            --text-color: #f0f0f0; /* Lighter text for dark mode, will be used by charts */
            --heading-color: #f8f9fa; /* Lighter headings for dark mode */
            --border-color: #495057;
            --border-color-light: #495057;
            --border-color-dark: #5a6268;
            --card-bg: #454c52;
            --card-shadow: rgba(0,0,0,0.3);
            --table-header-bg: #495057;
            --table-header-color: #f8f9fa;
            --table-hover-bg: #5a6268;
            --table-footer-bg: #3e444a;
            --input-bg: #495057;
            --input-color: #f8f9fa;
            --input-border: #6c757d;
            --link-color: #58a6ff;
            --link-hover-color: #80bfff;
            --inline-form-bg: #495057;
            --scroll-btn-bg: #6c757d;
            --scroll-btn-hover-bg: #adb5bd;
            --nav-btn-color: #adb5bd;
            --nav-btn-hover-color: #ced4da;
            --nav-btn-disabled-bg: #495057;
            --nav-btn-disabled-color: #6c757d;
            --nav-btn-disabled-border: #6c757d;
            --chart-grid-color: rgba(255, 255, 255, 0.15); /* Grid line color for dark mode */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6; margin: 0; padding: 0; background-color: var(--body-bg); color: var(--text-color); transition: background-color 0.3s ease, color 0.3s ease;
        }
        .page-container { max-width: 1400px; margin: 40px auto 25px; background: var(--container-bg); padding: 25px 30px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); color: var(--text-color); position: relative; transition: background-color 0.3s ease, color 0.3s ease; }
        .app-title { font-size: 1rem; font-style: italic; text-align: left; color: var(--text-color); margin-bottom: 15px; margin-top: 0; padding-top: 5px; border-bottom: 1px solid var(--border-color-light); padding-bottom: 10px; }
        h1, h2 { color: var(--heading-color); text-align: center; margin-top: 0; margin-bottom: 25px; transition: color 0.3s ease; }
        h1 { border-bottom: 2px solid var(--border-color-dark); padding-bottom: 15px; font-size: 2.3em; font-weight: 600; margin-top: 0; }
        h2 { border-bottom: 1px solid var(--border-color); padding-bottom: 12px; margin-top: 40px; font-size: 1.9em; font-weight: 500; }
        /* h3 is used for chart titles AND general section titles */
        h3 { font-size: 1.4em; font-weight: 600; color: var(--heading-color); }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95em; color: var(--text-color); opacity: 0.9; }
        select, input[type="text"], input[type="number"], input[type="url"] { width: 100%; padding: 10px 12px; margin-bottom: 18px; border: 1px solid var(--input-border); border-radius: 4px; box-sizing: border-box; font-size: 1em; background-color: var(--input-bg); color: var(--input-color); transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease; }
        select:focus, input:focus { border-color: #80bdff; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); }
        button, .button-link { padding: 10px 18px; margin: 5px; border: 1px solid transparent; border-radius: 4px; cursor: pointer; font-size: 0.95em; font-weight: 500; text-decoration: none; display: inline-block; text-align: center; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease, box-shadow 0.15s ease-in-out; line-height: 1.5; }
        .btn-primary { background-color: #007bff; color: white; border-color: #007bff;} .btn-primary:hover { background-color: #0056b3; border-color: #0056b3;}
        .btn-secondary { background-color: #6c757d; color: white; border-color: #6c757d;} .btn-secondary:hover { background-color: #545b62; border-color: #545b62;}
        .btn-success { background-color: #28a745; color: white; border-color: #28a745;} .btn-success:hover { background-color: #1e7e34; border-color: #1e7e34;}
        .btn-info { background-color: #17a2b8; color: white; border-color: #17a2b8;} .btn-info:hover { background-color: #117a8b; border-color: #117a8b;}
        .btn-danger { background-color: #dc3745; color: white; border-color: #dc3745;} .btn-danger:hover { background-color: #bd2130; border-color: #bd2130;}
        .btn-warning { background-color: #ffc107; color: black; border-color: #ffc107;} .btn-warning:hover { background-color: #d39e00; border-color: #d39e00;}
        .btn-sm { padding: 4px 8px; font-size: 0.85em; line-height: 1.4; }
        button:disabled, .button-link:disabled { background-color: var(--nav-btn-disabled-bg); border-color: var(--nav-btn-disabled-border); color: var(--nav-btn-disabled-color); cursor: not-allowed; opacity: 0.65; box-shadow: none; }
        .hidden { display: none !important; }
        .nav-links { margin-bottom: 30px; text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 20px;}
        .nav-links .button-link { margin: 0 8px; background-color: transparent; border-color: transparent; color: var(--link-color); font-weight: 500; padding: 8px 12px; }
        .nav-links .button-link:hover { background-color: transparent; color: var(--link-hover-color); text-decoration: underline; }
        .nav-links .btn-success { background-color: #28a745; border-color: #28a745; color: white; }
        .nav-links .btn-success:hover { background-color: #1e7e34; border-color: #1e7e34; text-decoration: none; }
        .nav-links .btn-io { background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color-dark); }
        .nav-links .btn-io:hover { background-color: var(--table-hover-bg); border-color: var(--border-color-dark); }
        .theme-switch-wrapper { position: absolute; top: 20px; right: 30px; display: flex; align-items: center; z-index: 1001;}
        .theme-switch-wrapper em { margin-right: 10px; font-size: 0.9rem; color: var(--text-color); }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: #fff; bottom: 3px; content: ""; height: 18px; left: 3px; position: absolute; transition: .4s; width: 18px; border-radius: 50%; }
        input:checked + .slider { background-color: #007bff; }
        input:checked + .slider:before { transform: translateX(24px); }
        body.dark-mode .slider { background-color: #555; }
        body.dark-mode .slider:before { background-color: #ccc; }
        #overviewPage table, #financialsPage table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; background-color: var(--card-bg); border-radius: 4px; overflow: hidden; }
        #overviewPage th, #overviewPage td, #financialsPage th, #financialsPage td { border: 1px solid var(--border-color); padding: 9px 12px; text-align: left; white-space: nowrap; vertical-align: middle;}
        #overviewPage th, #financialsPage th { background-color: var(--table-header-bg); font-weight: 600; color: var(--table-header-color); border-bottom: 2px solid var(--border-color); }
        #overviewPage tbody tr, #financialsPage tbody tr { cursor: default; transition: background-color 0.15s ease; }
        #overviewPage tbody tr.dragging { opacity: 0.5; background: #cce1ff; }
        #overviewPage tbody tr.drag-over { border-top: 2px solid #007bff; }
        #overviewPage .action-link, #financialsPage .action-link { color: var(--link-color); text-decoration: none; font-weight: bold; cursor: pointer; }
        #overviewPage .action-link:hover, #financialsPage .action-link:hover { text-decoration: underline; color: var(--link-hover-color); }
        #overviewPage .no-horses, #financialsPage .no-horses { text-align: center; color: var(--text-color); opacity: 0.7; font-style: italic; white-space: normal; padding: 20px; background-color: transparent; }
        #overviewPage .drag-handle { cursor: grab; user-select: none; text-align: center; width: 30px; }
        #overviewPage .drag-handle:active { cursor: grabbing; }
        #overviewPage .table-footer td, #financialsPage .table-footer td { font-weight: bold; background-color: var(--table-footer-bg); color: var(--table-header-color); border-top: 2px solid var(--border-color-dark); }
        #overviewPage .table-footer td.footer-total, #financialsPage .table-footer td.footer-total { text-align: right; }
        #financialsPage th:nth-child(n+2), #financialsPage td:nth-child(n+2) { text-align: right; }
        #financialsPage .table-footer td { text-align: right; }
        #financialsPage .table-footer td:first-child { text-align: left;}
        #financialsPage .forged-label { font-size:0.8em; color:#dc3745; font-style: italic; margin-left: 5px;}
        #detailPage .page-container-inner { max-width: 950px; margin: 0 auto; }
        #detailPage #mainActions { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        #detailPage #horseProfileDisplay { border: 1px solid var(--border-color); padding: 25px; margin-top: 15px; background-color: var(--card-bg); border-radius: 6px; box-shadow: 0 1px 4px var(--card-shadow); }
        #detailPage #horseProfileDisplay h2 { text-align: left; border-bottom: none; font-size: 1.7em; margin-bottom: 20px; color: var(--heading-color); }
        #detailPage .profile-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        #detailPage .profile-section { background-color: var(--card-bg); padding: 20px; border: 1px solid var(--border-color-light); border-radius: 5px; box-shadow: 0 1px 2px var(--card-shadow); }
        /* Chart titles (H3) color is handled via general h3 and body.dark-mode h3 */
        body.dark-mode #detailPage .profile-section h3 { border-bottom-color: var(--border-color-dark); }
        #detailPage #horseProfileDisplay p { margin: 7px 0; color: var(--text-color); font-size: 0.95em; }
        #detailPage #horseProfileDisplay strong { color: var(--heading-color); opacity: 0.9; display: inline-block; font-weight: 600; }
        #detailPage #basicInfo strong, #detailPage #raceRecord strong, #detailPage #pedigree strong, #detailPage #financials strong { min-width: 145px; }
        #detailPage #pedigree p strong { min-width: 110px; }
        #detailPage #stats p span.stars, #detailPage #augments p span { display: block; margin-top: 4px; }
        #detailPage #horseForm { border: 1px solid var(--border-color); padding: 30px; margin-top: 25px; background-color: var(--card-bg); border-radius: 6px; }
        #detailPage #horseForm h2 { text-align: left; font-size: 1.7em; border-bottom: 1px solid var(--border-color); color: var(--heading-color); }
        #detailPage .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px 25px; }
        #prevHorseBtn, #nextHorseBtn { background-color: var(--nav-btn-color); color: white; border-color: var(--nav-btn-color); }
        #prevHorseBtn:hover:not(:disabled), #nextHorseBtn:hover:not(:disabled) { background-color: var(--nav-btn-hover-color); border-color: var(--nav-btn-hover-color); }
        #race1TimeChartContainer, #zedBalanceChartContainer { margin-top: 20px; padding: 15px; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 5px; box-shadow: 0 1px 3px var(--card-shadow); }
        #race1TimeChartContainer h3, #zedBalanceChartContainer h3 { text-align: center; margin-top: 0; margin-bottom: 15px; color: var(--heading-color) !important; border-bottom: 1px solid var(--border-color-light); padding-bottom: 10px; }
        #race1TimeChartContainer p, #zedBalanceChartContainer p { text-align: center; font-style: italic; opacity: 0.7; }
        #poolPage .horse-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; margin-top: 20px; }
        #poolPage .horse-card { border: 1px solid var(--border-color); border-radius: 6px; padding: 20px; background-color: var(--card-bg); box-shadow: 0 2px 5px var(--card-shadow); transition: box-shadow 0.2s ease; }
        #poolPage .horse-card:hover { box-shadow: 0 5px 12px var(--card-shadow); }
        #poolPage .horse-card h3 { margin-top: 0; margin-bottom: 18px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color-light); text-align: center; color: var(--link-color); font-size: 1.35em; font-weight: 600; }
        #poolPage .horse-card h4 { margin-top: 18px; margin-bottom: 10px; color: var(--heading-color); opacity: 0.8; font-size: 1.0em; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px dotted var(--border-color); padding-bottom: 5px;}
        #poolPage .horse-card p { margin: 6px 0; font-size: 0.9em; color: var(--text-color); }
        #poolPage .horse-card strong { display: inline-block; min-width: 85px; color: var(--heading-color); opacity: 0.9; margin-right: 5px; font-weight: 600; }
        #poolPage .view-details-link { display: block; margin-top: 20px; text-align: center; color: var(--link-color); text-decoration: none; font-weight: 600; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--container-bg); transition: background-color 0.2s, border-color 0.2s; }
        #poolPage .view-details-link:hover { background-color: var(--table-hover-bg); border-color: var(--border-color-dark); color: var(--link-hover-color); }
        #poolPage .no-horses { text-align: center; color: var(--text-color); opacity: 0.7; margin-top: 25px; font-style: italic; padding: 20px; }
        #poolPage .horse-card .financials-pool strong { min-width: 115px; }
        #breedsPage .breeding-record-card { border: 1px solid var(--border-color-dark); border-radius: 6px; margin-bottom: 25px; padding: 25px; background-color: var(--card-bg); box-shadow: 0 2px 8px var(--card-shadow); }
        #breedsPage .record-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(290px, 1fr)); gap: 30px; }
        #breedsPage .parent-section, #breedsPage .offspring-section { border: 1px solid var(--border-color); padding: 20px; border-radius: 5px; background-color: var(--card-bg); display: flex; flex-direction: column; box-shadow: inset 0 1px 2px var(--card-shadow); }
        #breedsPage .parent-section h3, #breedsPage .offspring-section h3 { margin-top: 0; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color-light); text-align: left; font-size: 1.25em; color: #007bff; font-weight: 600;}
        body.dark-mode #breedsPage .parent-section h3, body.dark-mode #breedsPage .offspring-section h3 { color: #58a6ff; }
        #breedsPage .horse-details { flex-grow: 1; margin-bottom: 15px; }
        #breedsPage p { margin: 6px 0; font-size: 0.9em; color: var(--text-color); }
        #breedsPage strong { display: inline-block; min-width: 95px; font-weight: 600; color: var(--heading-color); opacity: 0.9; margin-right: 5px; }
        #breedsPage .no-records { text-align: center; color: var(--text-color); opacity: 0.7; margin-top: 25px; font-style: italic; padding: 20px; }
        #breedsPage .edit-parent-button, #breedsPage .edit-offspring-button { align-self: center; margin-top: auto; }
        #breedsPage .inline-edit-form { margin-top: 15px; border-top: 1px dashed var(--border-color); padding-top: 15px; background-color: var(--inline-form-bg); padding: 15px; border-radius: 4px; margin-bottom: 15px;}
        #breedsPage .inline-edit-form label { font-size: 0.9em; font-weight: 500; margin-bottom: 4px; color: var(--text-color); }
        #breedsPage .inline-edit-form select, #breedsPage .inline-edit-form input { font-size: 0.9em; padding: 7px 9px; margin-bottom: 12px; background-color: var(--input-bg); color: var(--input-color); border-color: var(--input-border); }
        #breedsPage .inline-edit-buttons { text-align: center; margin-top: 10px; }
        #breedsPage .forged-label { font-size:0.8em; color:#dc3745; font-style: italic; font-weight: bold; margin-left: 5px;}
        #breedsPage .clickable-horse-name { color: var(--link-color); cursor: pointer; text-decoration: underline; font-weight: bold; }
        #breedsPage .clickable-horse-name:hover { color: var(--link-hover-color); }
        #breedsPage .non-clickable-name { font-style: italic; opacity: 0.8; }
        #lineagePage #lineageDisplayArea { margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        #lineagePage .no-lineage { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; white-space: normal; text-align: center; color: var(--text-color); opacity: 0.7; padding: 20px; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 5px; grid-column: 1 / -1; }
        #lineagePage .lineage-family-card { background-color: var(--card-bg); border: 1px solid var(--border-color-dark); border-radius: 6px; padding: 15px; margin-bottom: 0; box-shadow: 0 1px 3px var(--card-shadow); font-size: 0.9em; }
        #lineagePage .lineage-family-card h4 { margin-top: 0; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color-light); color: var(--heading-color); font-size: 1.1em; }
        #lineagePage .lineage-parent, #lineagePage .lineage-offspring { margin-bottom: 5px; line-height: 1.4; }
        #lineagePage .lineage-parent span, #lineagePage .lineage-offspring span { font-weight: bold; }
        #lineagePage .lineage-parent-stats .stars, #lineagePage .lineage-offspring .stars { margin-left: 2px; font-size: 0.9em; margin-right: 4px; }
        #lineagePage .lineage-offspring { padding-left: 15px; }
        #lineagePage .lineage-offspring .forged-label, #lineagePage .lineage-parent .forged-label { font-size: 0.75em; }
        #lineagePage .lineage-parent-stats { font-size: 0.9em; opacity: 0.85; margin-left: 5px; font-weight: normal; }
        .stars { white-space: nowrap; color: #ffc107; }
        #scrollTopBtn { display: none; position: fixed; bottom: 25px; right: 30px; z-index: 1000; border: none; outline: none; background-color: var(--scroll-btn-bg); color: white; cursor: pointer; padding: 12px 15px; border-radius: 5px; font-size: 0.95em; opacity: 0.8; transition: background-color 0.3s ease, opacity 0.3s ease; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3); }
        #scrollTopBtn:hover { background-color: var(--scroll-btn-hover-bg); opacity: 1; }

        /* Chart.js Tooltip specific styling for Dark Mode */
        body.dark-mode .chartjs-tooltip { background: rgba(30, 30, 30, 0.9); }
        body.dark-mode .chartjs-tooltip .chartjs-tooltip-title,
        body.dark-mode .chartjs-tooltip .chartjs-tooltip-body,
        body.dark-mode .chartjs-tooltip .chartjs-tooltip-body li span {
             color: var(--text-color) !important; /* Use theme's main text color for tooltips in dark mode */
        }
        /* Ensure chart titles (H3 within chart containers) use the theme's heading color */
        #race1TimeChartContainer h3,
        #zedBalanceChartContainer h3 {
            color: var(--heading-color);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>
    <div class="page-container">
        <div class="theme-switch-wrapper">
            <em>Dark Mode:</em>
            <label class="theme-switch" for="darkModeToggle"><input type="checkbox" id="darkModeToggle" /><div class="slider round"></div></label>
        </div>
        <p class="app-title">Stable Manager</p>
        <h1></h1>
        <div class="nav-links">
            <button class="button-link" onclick="showPage('overviewPage')">Overview</button>
            <button class="button-link" onclick="showPage('poolPage')">Pool</button>
            <button class="button-link" onclick="showPage('breedsPage')">Records</button>
            <button class="button-link" onclick="showPage('lineagePage')">Lineage</button>
            <button class="button-link" onclick="showPage('financialsPage')">Financials</button>
            <input type="file" id="importFile" accept=".json" style="display: none;">
            <button class="button-link btn-io" onclick="document.getElementById('importFile').click();">Import Data (JSON)</button>
            <button class="button-link btn-io" onclick="exportData()">Export Data</button>
            <input type="file" id="importRaceCsvFile" accept=".csv" style="display: none;">
            <button class="button-link btn-io" onclick="document.getElementById('importRaceCsvFile').click();">Import Race Data (CSV)</button>
            <button class="button-link btn-success" onclick="showDetailPage('ADD_NEW')">Add New Item</button>
        </div>
        <div id="overviewPage" class="page-view">
            <h2></h2>
            <div style="overflow-x: auto;"><table id="horseTable"><thead><tr><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody id="horseTableBody"></tbody></table></div>
        </div>
        <div id="detailPage" class="page-view hidden">
             <div class="page-container-inner">
                 <button class="button-link btn-secondary" style="margin-bottom:15px;" onclick="showPage('overviewPage')">← Back to Overview</button>
                 <label for="horseSelector">Select Item:</label>
                 <select id="horseSelector"><option value="">-- Select an Item --</option></select>
                 <div id="mainActions">
                     <button id="prevHorseBtn" class="hidden">← Previous</button>
                     <button id="editButton" class="btn-warning hidden">Edit Selected</button>
                     <button id="sendToBreedingPoolButton" class="btn-info hidden">Send to Pool</button>
                     <button id="forgeButton" class="btn-danger hidden">Forge</button>
                     <button id="nextHorseBtn" class="hidden">Next →</button>
                 </div>
                 <div id="horseProfileDisplay" class="hidden">
                     <h2 id="profileName"></h2>
                     <div class="profile-grid">
                         <div class="profile-section" id="basicInfo"><h3></h3><p><strong>Generation:</strong> <span id="displayGen"></span></p><p><strong>Gender:</strong> <span id="displayGender"></span></p><p><strong>Breed:</strong> <span id="displayBreed"></span></p><p><strong>Colour Trait:</strong> <span id="displayColourTrait"></span></p></div>
                         <div class="profile-section" id="stats"><h3></h3><p><strong>Overall:</strong><br><span id="displayOverall" class="stars"></span></p><p><strong>Speed:</strong><br><span id="displaySpeed" class="stars"></span></p><p><strong>Sprint:</strong><br><span id="displaySprint" class="stars"></span></p><p><strong>Endurance:</strong><br><span id="displayEndurance" class="stars"></span></p></div>
                         <div class="profile-section" id="raceRecord">
                             <h3></h3>
                             <p><strong>Races:</strong> <span id="displayRaces"></span></p>
                             <p><strong>1st:</strong> <span id="displayFirst"></span></p>
                             <p><strong>2nd:</strong> <span id="displaySecond"></span></p>
                             <p><strong>3rd:</strong> <span id="displayThird"></span></p>
                             <p><strong>Places:</strong> <span id="displayPlaces"></span></p>
                             <p><strong>Race 1 Time:</strong> <span id="displayRace1Time"></span></p>
                             <p><strong>Race 2 Time:</strong> <span id="displayRace2Time"></span></p>
                             <p><strong>Avg Race Time:</strong> <span id="displayAvgRaceTime"></span></p>
                         </div>
                         <div class="profile-section" id="pedigree"><h3></h3><p><strong>Sire Name:</strong> <span id="displaySireName"></span></p><p><strong>Sire Breed:</strong> <span id="displaySireBreed"></span></p><p><strong>Sire Colour:</strong> <span id="displaySireColourTrait"></span></p><p><strong>Dam Name:</strong> <span id="displayDamName"></span></p><p><strong>Dam Breed:</strong> <span id="displayDamBreed"></span></p><p><strong>Dam Colour:</strong> <span id="displayDamColourTrait"></span></p></div>
                         <div class="profile-section" id="augments"><h3></h3><p><strong>CPU:</strong><br><span id="displayCPU"></span></p><p><strong>RAM:</strong><br><span id="displayRAM"></span></p><p><strong>Hydraulic:</strong><br><span id="displayHydraulic"></span></p></div>
                         <div class="profile-section" id="financials"><h3></h3><p><strong>Cost:</strong> <span id="displayBreedCost"></span></p><p><strong>Start Bal:</strong> <span id="displayStrtZedBal"></span></p><p><strong>Balance:</strong> <span id="displayZedBalance"></span></p><p><strong>Total Value Sold:</strong> <span id="displaySoldBreeds"></span></p><p><strong>Profit/Loss:</strong> <span id="displayROI"></span></p></div>
                     </div>
                     <div id="race1TimeChartContainer" class="profile-section hidden" style="grid-column: 1 / -1;">
                        <h3>Race Times History</h3>
                        <canvas id="race1TimeChartCanvas"></canvas>
                        <p id="race1ChartNoDataMessage" class="hidden"></p>
                     </div>
                     <div id="zedBalanceChartContainer" class="profile-section hidden" style="grid-column: 1 / -1;">
                        <h3>ZED Balance History</h3>
                        <canvas id="zedBalanceChartCanvas"></canvas>
                        <p id="zedBalanceChartNoDataMessage" class="hidden">No ZED Balance history to display.</p>
                     </div>
                 </div>
                 <div id="horseForm" class="hidden">
                     <h2 id="formTitle"></h2>
                     <form id="editAddForm">
                         <input type="hidden" id="horseIdInput">
                         <div class="form-grid">
                            <div class="form-group"><label for="inputName">Name:</label><input type="text" id="inputName" required></div>
                            <div class="form-group"><label for="inputGen">Generation:</label><select id="inputGen"><option>G0</option><option>G1</option><option>G2</option><option>G3</option><option>G4</option><option>G5</option></select></div>
                            <div class="form-group"><label for="inputGender">Gender:</label><select id="inputGender"><option>M</option><option>F</option></select></div>
                            <div class="form-group"><label for="inputBreed">Breed:</label><select id="inputBreed"><option>Nakamoto</option><option>Szabo</option><option>Finney</option><option>Buterin</option></select></div>
                            <div class="form-group"><label for="inputColourTrait">Colour Trait:</label><select id="inputColourTrait"><option>Nakamoto</option><option>Szabo</option><option>Finney</option><option>Buterin</option></select></div>
                            <div class="form-group"><label for="inputOverall">Overall:</label><select id="inputOverall"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputSpeed">Speed:</label><select id="inputSpeed"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputSprint">Sprint:</label><select id="inputSprint"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputEndurance">Endurance:</label><select id="inputEndurance"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputSireName">Sire Name:</label><input type="text" id="inputSireName"></div>
                            <div class="form-group"><label for="inputSireBreed">Sire Breed:</label><select id="inputSireBreed"><option value="">Unknown</option><option>Nakamoto</option><option>Szabo</option><option>Finney</option><option>Buterin</option></select></div>
                            <div class="form-group"><label for="inputSireColourTrait">Sire Colour Trait:</label><select id="inputSireColourTrait"><option value="">Unknown</option><option>Nakamoto</option><option>Szabo</option><option>Finney</option><option>Buterin</option></select></div>
                            <div class="form-group"><label for="inputSireOverall">Sire Overall:</label><select id="inputSireOverall"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputSireSpeed">Sire Speed:</label><select id="inputSireSpeed"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputSireSprint">Sire Sprint:</label><select id="inputSireSprint"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputSireEndurance">Sire Endurance:</label><select id="inputSireEndurance"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputDamName">Dam Name:</label><input type="text" id="inputDamName"></div>
                            <div class="form-group"><label for="inputDamBreed">Dam Breed:</label><select id="inputDamBreed"><option value="">Unknown</option><option>Nakamoto</option><option>Szabo</option><option>Finney</option><option>Buterin</option></select></div>
                            <div class="form-group"><label for="inputDamColourTrait">Dam Colour Trait:</label><select id="inputDamColourTrait"><option value="">Unknown</option><option>Nakamoto</option><option>Szabo</option><option>Finney</option><option>Buterin</option></select></div>
                            <div class="form-group"><label for="inputDamOverall">Dam Overall:</label><select id="inputDamOverall"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputDamSpeed">Dam Speed:</label><select id="inputDamSpeed"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputDamSprint">Dam Sprint:</label><select id="inputDamSprint"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputDamEndurance">Dam Endurance:</label><select id="inputDamEndurance"><option value="-">-</option><option>⭐️</option><option>⭐️⭐️</option><option>⭐️⭐️☀️</option><option>⭐️⭐️⭐️</option><option>⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️</option><option>⭐️⭐️⭐️⭐️☀️</option><option>⭐️⭐️⭐️⭐️⭐️</option></select></div>
                            <div class="form-group"><label for="inputRaces">Races:</label><input type="number" id="inputRaces" min="0" value="0"></div>
                            <div class="form-group"><label for="inputFirst">1st:</label><input type="number" id="inputFirst" min="0" value="0"></div>
                            <div class="form-group"><label for="inputSecond">2nd:</label><input type="number" id="inputSecond" min="0" value="0"></div>
                            <div class="form-group"><label for="inputThird">3rd:</label><input type="number" id="inputThird" min="0" value="0"></div>
                            <div class="form-group"><label for="inputRace1Time">Race 1 Time:</label><input type="text" id="inputRace1Time"></div>
                            <div class="form-group"><label for="inputRace2Time">Race 2 Time:</label><input type="text" id="inputRace2Time"></div>
                            <div class="form-group"><label for="inputCPU">CPU:</label><select id="inputCPU"><option>Void C100</option><option>Crimson</option><option>GX-Core C</option><option>Darklight 100C</option><option>Midnight 100C</option></select></div>
                            <div class="form-group"><label for="inputRAM">RAM:</label><select id="inputRAM"><option>Void R100</option><option>Crimson R</option><option>GX-Core R</option><option>Darklight 100R</option><option>Midnight 100R</option></select></div>
                            <div class="form-group"><label for="inputHydraulic">Hydraulic:</label><select id="inputHydraulic"><option>Void H100</option><option>Crimson H</option><option>GX - Core H</option><option>Darklight 100H</option><option>Midnight 100H</option></select></div>
                            <div class="form-group"><label for="inputBreedCost">Cost:</label><input type="text" id="inputBreedCost"></div>
                            <div class="form-group"><label for="inputStrtZedBal">Start Bal:</label><input type="text" id="inputStrtZedBal"></div>
                            <div class="form-group"><label for="inputZedBalance">Balance:</label><input type="text" id="inputZedBalance"></div>
                            <div class="form-group"><label for="inputSoldBreeds">Add Sale Value:</label><input type="text" id="inputSoldBreeds" placeholder="Enter value of this sale"></div>
                           </div>
                           <div style="text-align: center; margin-top: 20px;">
                               <button type="submit" id="saveChangesButton" class="btn-primary">Save Changes</button>
                               <button type="submit" id="saveNewButton" class="btn-primary">Save New Item</button>
                               <button type="button" id="cancelButton" class="btn-secondary">Cancel</button>
                           </div>
                       </form>
                   </div>
             </div>
        </div>
        <div id="poolPage" class="page-view hidden">
            <h2></h2>
            <section id="siresSection"><h3></h3><div id="siresList" class="horse-list"><p class="no-horses"></p></div></section>
            <section id="damsSection"><h3></h3><div id="damsList" class="horse-list"><p class="no-horses"></p></div></section>
        </div>
        <div id="breedsPage" class="page-view hidden">
            <h2></h2>
            <div id="breedingSimulationSection" style="margin-bottom: 40px; padding: 25px; border: 1px solid var(--border-color-dark); border-radius: 6px; background-color: var(--card-bg);">
                <h3></h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; align-items: end; margin-bottom: 20px;">
                    <div><label for="selectSire">Select Sire:</label><select id="selectSire"><option value="">-- Select Sire --</option></select></div>
                    <div><label for="selectDam">Select Dam:</label><select id="selectDam"><option value="">-- Select Dam --</option></select></div>
                    <div><button id="breedButton" class="btn-primary" disabled>Simulate</button></div>
                </div>
                <div id="offspringResult" class="hidden" style="margin-top: 25px; padding: 20px; border: 1px dashed var(--border-color); border-radius: 5px; background-color: var(--inline-form-bg);">
                    <h4></h4>
                     <div class="form-group"><label for="inputOffspringName">Offspring Name:</label><input type="text" id="inputOffspringName" placeholder="Enter a unique name" required></div>
                     <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px 20px;"><p><strong>Generation:</strong> <span id="offspringGen"></span></p><p><strong>Gender:</strong> <span id="offspringGender"></span></p><p><strong>Breed:</strong> <span id="offspringBreed"></span></p><p><strong>Colour Trait:</strong> <span id="offspringColourTrait"></span></p><p><strong>Overall:</strong> <span id="offspringOverall" class="stars"></span></p><p><strong>Speed:</strong> <span id="offspringSpeed" class="stars"></span></p><p><strong>Sprint:</strong> <span id="offspringSprint" class="stars"></span></p><p><strong>Endurance:</strong> <span id="offspringEndurance" class="stars"></span></p><p><strong>Sire:</strong> <span id="offspringSireName"></span></p><p><strong>Dam:</strong> <span id="offspringDamName"></span></p></div>
                     <div style="text-align: center; margin-top: 20px;"><button id="addOffspringButton" class="btn-success">Add Offspring</button><button type="button" class="btn-secondary" onclick="cancelOffspring()">Cancel</button></div>
                </div>
            </div>
            <h3></h3><div id="breedingRecordsList"><p class="no-records"></p></div>
        </div>
        <div id="lineagePage" class="page-view hidden">
            <h2></h2><div id="lineageDisplayArea"><p class="no-lineage"></p></div>
        </div>
        <div id="financialsPage" class="page-view hidden">
            <h2></h2>
             <div style="overflow-x: auto;"><table id="financialsTable"><thead><tr><th>Name</th><th>Cost</th><th>Balance</th><th>Total Value Sold</th><th>Profit / Loss</th></tr></thead><tbody id="financialsTableBody"></tbody><tfoot id="financialsTableFooter"></tfoot></table></div>
        </div>
        <button id="scrollTopBtn" title="Go to top">↑ Top</button>
    </div>

    <script>
        // ========================================================================
        // == GLOBAL VARIABLES & CONSTANTS ==
        // ========================================================================
        const STORAGE_KEY = 'templateDataStorage';
        let horsesData = [];
        let nextId = 1;
        let currentDetailHorseId = null;
        let race1TimeChartInstance = null;
        let zedBalanceChartInstance = null;
        let tempOffspringData = null;
        const defaultHorsesData = [];

        // --- DOM Element References ---
        const overviewPage = document.getElementById('overviewPage'); const detailPage = document.getElementById('detailPage'); const poolPage = document.getElementById('poolPage'); const breedsPage = document.getElementById('breedsPage'); const lineagePage = document.getElementById('lineagePage'); const financialsPage = document.getElementById('financialsPage');
        const allPages = [overviewPage, detailPage, poolPage, breedsPage, lineagePage, financialsPage];
        const horseTableBody = document.getElementById('horseTableBody');
        const detailContent = document.getElementById('detailContent'); const horseSelector = document.getElementById('horseSelector'); const mainActionsDiv = document.getElementById('mainActions'); const editButton = document.getElementById('editButton'); const sendToBreedingPoolButton = document.getElementById('sendToBreedingPoolButton'); const forgeButton = document.getElementById('forgeButton'); const prevHorseBtn = document.getElementById('prevHorseBtn'); const nextHorseBtn = document.getElementById('nextHorseBtn');
        const horseProfileDisplayDiv = document.getElementById('horseProfileDisplay'); const profileName = document.getElementById('profileName'); const displayGen = document.getElementById('displayGen'); const displayGender = document.getElementById('displayGender'); const displayBreed = document.getElementById('displayBreed'); const displayColourTrait = document.getElementById('displayColourTrait'); const displaySireName = document.getElementById('displaySireName'); const displaySireBreed = document.getElementById('displaySireBreed'); const displaySireColourTrait = document.getElementById('displaySireColourTrait'); const displayDamName = document.getElementById('displayDamName'); const displayDamBreed = document.getElementById('displayDamBreed'); const displayDamColourTrait = document.getElementById('displayDamColourTrait'); const displayOverall = document.getElementById('displayOverall'); const displaySpeed = document.getElementById('displaySpeed'); const displaySprint = document.getElementById('displaySprint'); const displayEndurance = document.getElementById('displayEndurance'); const displayRaces = document.getElementById('displayRaces'); const displayFirst = document.getElementById('displayFirst'); const displaySecond = document.getElementById('displaySecond'); const displayThird = document.getElementById('displayThird'); const displayPlaces = document.getElementById('displayPlaces');
        const displayRace1Time = document.getElementById('displayRace1Time'); const displayRace2Time = document.getElementById('displayRace2Time'); const displayAvgRaceTime = document.getElementById('displayAvgRaceTime');
        const displayCPU = document.getElementById('displayCPU'); const displayRAM = document.getElementById('displayRAM'); const displayHydraulic = document.getElementById('displayHydraulic'); const displayBreedCost = document.getElementById('displayBreedCost'); const displayStrtZedBal = document.getElementById('displayStrtZedBal'); const displayZedBalance = document.getElementById('displayZedBalance'); const displaySoldBreeds = document.getElementById('displaySoldBreeds'); const displayROI = document.getElementById('displayROI');
        const horseFormDiv = document.getElementById('horseForm'); const formTitle = document.getElementById('formTitle'); const editAddForm = document.getElementById('editAddForm'); const horseIdInput = document.getElementById('horseIdInput'); const inputName = document.getElementById('inputName'); const inputGen = document.getElementById('inputGen'); const inputGender = document.getElementById('inputGender'); const inputBreed = document.getElementById('inputBreed'); const inputColourTrait = document.getElementById('inputColourTrait'); const inputSireName = document.getElementById('inputSireName'); const inputSireBreed = document.getElementById('inputSireBreed'); const inputSireColourTrait = document.getElementById('inputSireColourTrait');
        const inputSireOverall = document.getElementById('inputSireOverall'); const inputSireSpeed = document.getElementById('inputSireSpeed'); const inputSireSprint = document.getElementById('inputSireSprint'); const inputSireEndurance = document.getElementById('inputSireEndurance');
        const inputDamName = document.getElementById('inputDamName'); const inputDamBreed = document.getElementById('inputDamBreed'); const inputDamColourTrait = document.getElementById('inputDamColourTrait');
        const inputDamOverall = document.getElementById('inputDamOverall'); const inputDamSpeed = document.getElementById('inputDamSpeed'); const inputDamSprint = document.getElementById('inputDamSprint'); const inputDamEndurance = document.getElementById('inputDamEndurance');
        const inputOverall = document.getElementById('inputOverall'); const inputSpeed = document.getElementById('inputSpeed'); const inputSprint = document.getElementById('inputSprint'); const inputEndurance = document.getElementById('inputEndurance'); const inputRaces = document.getElementById('inputRaces'); const inputFirst = document.getElementById('inputFirst'); const inputSecond = document.getElementById('inputSecond'); const inputThird = document.getElementById('inputThird');
        const inputRace1Time = document.getElementById('inputRace1Time'); const inputRace2Time = document.getElementById('inputRace2Time');
        const inputCPU = document.getElementById('inputCPU'); const inputRAM = document.getElementById('inputRAM'); const inputHydraulic = document.getElementById('inputHydraulic'); const inputBreedCost = document.getElementById('inputBreedCost'); const inputStrtZedBal = document.getElementById('inputStrtZedBal'); const inputZedBalance = document.getElementById('inputZedBalance'); const inputSoldBreeds = document.getElementById('inputSoldBreeds'); const saveChangesButton = document.getElementById('saveChangesButton'); const saveNewButton = document.getElementById('saveNewButton'); const cancelButton = document.getElementById('cancelButton');
        const siresListElement = document.getElementById('siresList'); const damsListElement = document.getElementById('damsList');
        const breedingRecordsList = document.getElementById('breedingRecordsList');
        const lineageDisplayArea = document.getElementById('lineageDisplayArea');
        const financialsTableBody = document.getElementById('financialsTableBody');
        const financialsTableFooter = document.getElementById('financialsTableFooter');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const scrollTopButton = document.getElementById('scrollTopBtn');
        const importFileInput = document.getElementById('importFile');
        const importRaceCsvFileInput = document.getElementById('importRaceCsvFile');
        const race1TimeChartCanvas = document.getElementById('race1TimeChartCanvas'); const race1ChartNoDataMessage = document.getElementById('race1ChartNoDataMessage');
        const zedBalanceChartCanvas = document.getElementById('zedBalanceChartCanvas'); const zedBalanceChartNoDataMessage = document.getElementById('zedBalanceChartNoDataMessage');
        const selectSire = document.getElementById('selectSire'); const selectDam = document.getElementById('selectDam'); const breedButton = document.getElementById('breedButton');
        const offspringResultDiv = document.getElementById('offspringResult'); const inputOffspringName = document.getElementById('inputOffspringName'); const offspringGenSpan = document.getElementById('offspringGen'); const offspringGenderSpan = document.getElementById('offspringGender'); const offspringBreedSpan = document.getElementById('offspringBreed'); const offspringColourTraitSpan = document.getElementById('offspringColourTrait'); const offspringOverallSpan = document.getElementById('offspringOverall'); const offspringSpeedSpan = document.getElementById('offspringSpeed'); const offspringSprintSpan = document.getElementById('offspringSprint'); const offspringEnduranceSpan = document.getElementById('offspringEndurance'); const offspringSireNameSpan = document.getElementById('offspringSireName'); const offspringDamNameSpan = document.getElementById('offspringDamName'); const addOffspringButton = document.getElementById('addOffspringButton');
        let draggedRow = null;

        // ========================================================================
        // == HELPER FUNCTIONS ==
        // ========================================================================
        function parseNumericValue(valueString) { if (typeof valueString !== 'string' && typeof valueString !== 'number') return 0; const cleanedString = String(valueString).replace(/[^\d.-]/g, '').trim(); const value = parseFloat(cleanedString); return isNaN(value) ? 0 : value; }
        function formatNumericValue(value) { return value.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 }); }
        function calculateROI(item) { if (item === null || item === undefined) return "N/A"; const currentBalance = parseNumericValue(item.zedBalance); const cost = parseNumericValue(item.breedCost); const totalSaleValue = parseNumericValue(item.soldBreeds); const profitFromSales = totalSaleValue * 0.05; const totalProfitLoss = currentBalance - cost + profitFromSales; return `${(totalProfitLoss >= 0 ? '+' : '')}${totalProfitLoss.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`; }
        function calculatePlaces(item) { if (!item) return 0; return (parseInt(item.first) || 0) + (parseInt(item.second) || 0) + (parseInt(item.third) || 0); }
        function formatRaceRecord(item) { if (!item || typeof item.races !== 'number' || item.races <= 0) return ''; const races = item.races ?? 0, first = item.first ?? 0, second = item.second ?? 0, third = item.third ?? 0, winPercent = races > 0 ? Math.round((first / races) * 100) : 0; return `<span class="lineage-race-record">[${races} / ${first} - ${second} - ${third} | ${winPercent}%]</span>`; }
        function parseRaceTime(timeString) { if (!timeString || typeof timeString !== 'string') return null; const parts = timeString.split(':'); let seconds = 0; try { if (parts.length === 2) seconds = parseFloat(parts[0]) * 60 + parseFloat(parts[1]); else if (parts.length === 1) seconds = parseFloat(parts[0]); else return null; return isNaN(seconds) ? null : seconds; } catch (e) { console.error("Error parsing race time:", timeString, e); return null; } }
        function parseGen(genString) { if (!genString || typeof genString !== 'string') return 0; const match = genString.match(/G(\d+)/i); return match ? parseInt(match[1], 10) : 0; }
        const starValues = {'-':0, '': 0, '⭐️': 1, '⭐️⭐️': 2, '⭐️⭐️☀️': 2.5, '⭐️⭐️⭐️': 3, '⭐️⭐️⭐️☀️': 3.5, '⭐️⭐️⭐️⭐️': 4, '⭐️⭐️⭐️⭐️☀️': 4.5, '⭐️⭐️⭐️⭐️⭐️': 5};
        const starKeys = Object.keys(starValues).sort((a, b) => starValues[a] - starValues[b]);
        function getStarNumericValue(starString) { return starValues[starString || '-'] || 0; }
        function mapNumericToStars(numericValue) { if (numericValue <= 0) return '-'; let closestStar = '-'; for (let i = starKeys.length - 1; i >= 0; i--) { const key = starKeys[i]; if (key !== '-' && key !== '' && numericValue >= starValues[key]) { closestStar = key; break; } } const lowerBound = starValues[closestStar]; if(closestStar.includes('⭐️') && !closestStar.includes('☀️') && numericValue >= lowerBound + 0.25 && numericValue < lowerBound + 0.75) { const halfStarKey = closestStar + '☀️'; if(starValues.hasOwnProperty(halfStarKey)) return halfStarKey; } return closestStar; }
        function formatSecondsToTime(totalSeconds) { if (totalSeconds === null || isNaN(totalSeconds) || totalSeconds < 0) return "N/A"; const minutes = Math.floor(totalSeconds / 60), seconds = totalSeconds % 60; if (minutes > 0) return `${minutes}:${seconds.toFixed(2).padStart(5, '0')}`; else return `${seconds.toFixed(2).padStart(5, '0')}`; }
        function calculateAverageRaceTime(horse) {
            if (!horse) return "N/A";
            const combinedHistory = [];
            if (Array.isArray(horse.race1TimeHistory)) combinedHistory.push(...horse.race1TimeHistory);
            if (Array.isArray(horse.race2TimeHistory)) combinedHistory.push(...horse.race2TimeHistory);
            if (combinedHistory.length === 0) return "N/A";
            let totalSecondsSum = 0, validRaceCount = 0;
            combinedHistory.forEach(entry => { if (entry && entry.time) { const timeInSeconds = parseRaceTime(entry.time); if (timeInSeconds !== null && timeInSeconds >= 0) { totalSecondsSum += timeInSeconds; validRaceCount++; } } });
            if (validRaceCount === 0) return "N/A";
            return formatSecondsToTime(totalSecondsSum / validRaceCount);
        }
        function findIndexById(itemId) { if (itemId === null || itemId === undefined) return -1; const idToFind = parseInt(itemId); if (isNaN(idToFind)) return -1; return horsesData.findIndex(h => h && h.id === idToFind); }
        function findHorseById(itemId) { if (itemId === null || itemId === undefined) return null; const idToFind = parseInt(itemId); if (isNaN(idToFind)) return null; return horsesData.find(h => h && h.id === idToFind); }
        function findHorseByName(name) { if (!name || typeof name !== 'string') return null; const lowerCaseName = name.toLowerCase().trim(); if (lowerCaseName === '') return null; let foundHorse = horsesData.find(h => h && h.name && h.name.toLowerCase().trim() === lowerCaseName && h.status !== 'forged'); if (!foundHorse) foundHorse = horsesData.find(h => h && h.name && h.name.toLowerCase().trim() === lowerCaseName); return foundHorse; }
        function getNavigableHorses() { return horsesData.filter(h => h && h.status !== 'forged').sort((a, b) => a.name.localeCompare(b.name)); }

        // ========================================================================
        // == DATA HANDLING ==
        // ========================================================================
        function saveHorsesData() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(horsesData)); } catch (e) { console.error("Save Error:", e); alert("Could not save data."); } }
        function loadHorsesData() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            let dataToUse = defaultHorsesData;
            if (storedData) {
                try {
                    let parsedData = JSON.parse(storedData);
                    if (Array.isArray(parsedData)) dataToUse = parsedData;
                    else { console.warn("Stored data invalid."); dataToUse = []; }
                } catch (e) { console.error("Parse Error:", e); dataToUse = []; }
            } else { console.log("No stored data found."); dataToUse = []; }
            let maxId = 0, updated = false;
            dataToUse = Array.isArray(dataToUse) ? dataToUse.filter(h => h && typeof h === 'object') : [];
            dataToUse.forEach((h, index) => {
                if (h.id && typeof h.id === 'number' && h.id > maxId) maxId = h.id;
                if (!h.hasOwnProperty('status')) { h.status = 'active'; updated = true; }
                if (!h.hasOwnProperty('order') || typeof h.order !== 'number') { h.order = index; updated = true; }
                if (!h.hasOwnProperty('name')) { h.name = 'Unnamed'; updated = true; }
                if (h.hasOwnProperty('raceTime') && !h.hasOwnProperty('race1Time')) { h.race1Time = h.raceTime; delete h.raceTime; updated = true; }
                if (h.hasOwnProperty('raceTimeHistory') && !h.hasOwnProperty('race1TimeHistory')) { h.race1TimeHistory = h.raceTimeHistory; delete h.raceTimeHistory; updated = true; }
                if (!h.hasOwnProperty('race1TimeHistory') || !Array.isArray(h.race1TimeHistory)) { h.race1TimeHistory = []; updated = true; }
                if (!h.hasOwnProperty('race2TimeHistory') || !Array.isArray(h.race2TimeHistory)) { h.race2TimeHistory = []; updated = true; }
                if (!h.hasOwnProperty('augmentHistory') || !Array.isArray(h.augmentHistory)) { h.augmentHistory = []; updated = true; }
                if (!h.hasOwnProperty('zedBalanceHistory') || !Array.isArray(h.zedBalanceHistory)) { h.zedBalanceHistory = []; updated = true; }
                ['races', 'first', 'second', 'third'].forEach(field => { if (!h.hasOwnProperty(field) || typeof h[field] !== 'number' || isNaN(h[field])) { h[field] = 0; updated = true; } });
                ['breedCost', 'strtZedBal', 'zedBalance', 'soldBreeds'].forEach(field => { if (!h.hasOwnProperty(field) || (typeof h[field] !== 'string' && typeof h[field] !== 'number')) { h[field] = ""; updated = true; } else if (typeof h[field] === 'number') { h[field] = String(h[field]); updated = true; } });
                const optionalFields = [ 'gen', 'gender', 'breed', 'colourTrait', 'sireName', 'sireBreed', 'sireColourTrait', 'sireOverall', 'sireSpeed', 'sireSprint', 'sireEndurance', 'damName', 'damBreed', 'damColourTrait', 'damOverall', 'damSpeed', 'damSprint', 'damEndurance', 'overall', 'speed', 'sprint', 'endurance', 'race1Time', 'race2Time', 'cpu', 'ram', 'hydraulic' ];
                optionalFields.forEach(field => { if (!h.hasOwnProperty(field)) { if (['overall', 'speed', 'sprint', 'endurance', 'sireOverall', 'sireSpeed', 'sireSprint', 'sireEndurance', 'damOverall', 'damSpeed', 'damSprint', 'damEndurance'].includes(field)) h[field] = "-"; else h[field] = null; updated = true; } });
            });
            nextId = maxId + 1;
            dataToUse.forEach(h => { if (!h.id || typeof h.id !== 'number') { h.id = nextId++; updated = true; } });
            horsesData = dataToUse;
            if (updated) { console.log("Saving processed data."); saveHorsesData(); }
        }
        function exportData() { try { const dataStr = JSON.stringify(horsesData, null, 2); const blob = new Blob([dataStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; const date = new Date(); link.download = `template_data_${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); alert("Data exported!"); } catch (e) { console.error("Export Error:", e); alert("Error exporting data."); } }
        function importData(event) { const file = event.target.files[0]; if (!file) return; if (!file.name.endsWith('.json')) { alert("Select JSON file."); event.target.value = null; return; } const reader = new FileReader(); reader.onload = function(e) { try { const importedData = JSON.parse(e.target.result); if (!Array.isArray(importedData)) throw new Error("Not a valid array."); if (!importedData.every(item => typeof item === 'object' && item !== null && item.hasOwnProperty('id') && item.hasOwnProperty('name'))) throw new Error("Invalid structure."); if (window.confirm("OVERWRITE current data?")) { horsesData = importedData; saveHorsesData(); loadHorsesData(); alert("Imported! Refreshing."); const currentPage = allPages.find(page => !page.classList.contains('hidden')); showPage(currentPage ? currentPage.id : 'overviewPage'); } } catch (error) { console.error("Import Error:", error); alert(`Import Error: ${error.message}`); } finally { event.target.value = null; } }; reader.onerror = function(e) { console.error("File Read Error:", e); alert("Error reading file."); event.target.value = null; }; reader.readAsText(file); }

        // ========================================================================
        // == PAGE/VIEW MANAGEMENT ==
        // ========================================================================
        function showPage(pageId) {
             if (race1TimeChartInstance && pageId !== 'detailPage') { race1TimeChartInstance.destroy(); race1TimeChartInstance = null; document.getElementById('race1TimeChartContainer')?.classList.add('hidden'); }
             if (zedBalanceChartInstance && pageId !== 'detailPage') { zedBalanceChartInstance.destroy(); zedBalanceChartInstance = null; document.getElementById('zedBalanceChartContainer')?.classList.add('hidden'); }
             allPages.forEach(page => { if(page) page.classList.toggle('hidden', page.id !== pageId); else console.error("Page element null."); });
             if (pageId === 'overviewPage') renderOverviewPage();
             else if (pageId === 'poolPage') renderPoolPage();
             else if (pageId === 'breedsPage') { renderBreedsPage(); populateBreedingSelectors(); }
             else if (pageId === 'lineagePage') renderLineagePage();
             else if (pageId === 'financialsPage') renderFinancialsPage();
             window.scrollTo({ top: 0, behavior: 'smooth' });
         }
        function showDetailPage(itemId) {
            if (itemId === null || itemId === undefined || itemId === '') { console.warn("Invalid ID:", itemId); showPage('overviewPage'); return; }
            if (itemId !== 'ADD_NEW') { const potentialItem = findHorseById(parseInt(itemId)); if (!potentialItem) { alert(`ID ${itemId} not found.`); showPage('overviewPage'); return; } if (potentialItem.status === 'forged') { alert(`"${potentialItem.name}" Removed.`); showPage('overviewPage'); return; } }
            currentDetailHorseId = (itemId !== 'ADD_NEW') ? parseInt(itemId) : null;
            showPage('detailPage');
            horseProfileDisplayDiv.classList.add('hidden'); horseFormDiv.classList.add('hidden'); mainActionsDiv.classList.remove('hidden'); hideDetailActionButtons();
            document.getElementById('race1TimeChartContainer')?.classList.add('hidden'); document.getElementById('zedBalanceChartContainer')?.classList.add('hidden');
            populateHorseSelectorForDetail();
            if (itemId === 'ADD_NEW') showAddForm();
            else if (currentDetailHorseId && !isNaN(currentDetailHorseId)) { horseSelector.value = currentDetailHorseId; renderHorseDetail(currentDetailHorseId); }
            else { horseSelector.value = ""; hideDetailActionButtons(); console.error("Unexpected state:", itemId); horseProfileDisplayDiv.innerHTML = '<p>Error loading details.</p>'; horseProfileDisplayDiv.classList.remove('hidden'); }
        }

        // ========================================================================
        // == RENDERING FUNCTIONS ==
        // ========================================================================
        function renderOverviewPage() { horseTableBody.innerHTML = ''; const activeItems = horsesData.filter(h => h && h.status === 'active').sort((a, b) => (a.order ?? Infinity) - (b.order ?? Infinity)); let totalCost = 0, totalBalance = 0; if (activeItems.length === 0) { horseTableBody.innerHTML = '<tr><td colspan="15" class="no-horses">No active items found.</td></tr>'; return; } activeItems.forEach(item => { const places = calculatePlaces(item), roi = calculateROI(item); totalCost += parseNumericValue(item?.breedCost); totalBalance += parseNumericValue(item?.zedBalance); const row = document.createElement('tr'); row.setAttribute('draggable', true); row.setAttribute('data-horse-id', item.id); row.innerHTML = `<td><span class="drag-handle">↕️</span></td> <td>${item.name}</td> <td>${item.gen||'N/A'}</td> <td>${item.gender||'N/A'}</td> <td>${item.breed||'N/A'}</td> <td class="stars">${item.overall||'-'}</td> <td class="stars">${item.speed||'-'}</td> <td class="stars">${item.sprint||'-'}</td> <td class="stars">${item.endurance||'-'}</td> <td>${item.races??'N/A'}</td> <td>${places}</td> <td>${item.breedCost||'N/A'}</td> <td>${item.zedBalance||'N/A'}</td> <td>${roi}</td> <td><span class="action-link" data-id="${item.id}">Details</span></td>`; row.querySelector('.action-link').addEventListener('click', (e) => { e.stopPropagation(); showDetailPage(item.id); }); horseTableBody.appendChild(row); }); if (activeItems.length > 0) { const footerRow = document.createElement('tr'); footerRow.classList.add('table-footer'); footerRow.innerHTML = `<td colspan="11"></td> <td class="footer-total">${formatNumericValue(totalCost)}</td> <td class="footer-total">${formatNumericValue(totalBalance)}</td> <td colspan="2"></td>`; horseTableBody.appendChild(footerRow); } }
        function populateHorseSelectorForDetail() { const currentSelectedId = horseSelector.value; horseSelector.innerHTML = '<option value="">-- Select an Item --</option>'; getNavigableHorses().forEach(item => { const option = document.createElement('option'); option.value = item.id; option.textContent = item.name; horseSelector.appendChild(option); }); const selectedItem = findHorseById(currentSelectedId); if (selectedItem && selectedItem.status !== 'forged') horseSelector.value = currentSelectedId; else { const currentDetailItem = findHorseById(currentDetailHorseId); if (currentDetailItem && currentDetailItem.status !== 'forged') horseSelector.value = currentDetailHorseId; else horseSelector.value = ""; } }

        // **** MODIFIED renderHorseDetail for Chart Text and Grid Colors ****
        function renderHorseDetail(itemId) {
            const item = findHorseById(itemId);
            const race1TimeChartContainer = document.getElementById('race1TimeChartContainer');
            const race1TimeCanvas = document.getElementById('race1TimeChartCanvas');
            const race1NoDataMsg = document.getElementById('race1ChartNoDataMessage');
            const zedBalanceChartContainer = document.getElementById('zedBalanceChartContainer');
            const zedBalanceCanvas = document.getElementById('zedBalanceChartCanvas');
            const zedBalanceNoDataMsg = document.getElementById('zedBalanceChartNoDataMessage');

            if (!item || item.status === 'forged') { console.error("Cannot render detail for ID:", itemId); horseProfileDisplayDiv.classList.add('hidden'); horseFormDiv.classList.add('hidden'); mainActionsDiv.classList.remove('hidden'); hideDetailActionButtons(); horseSelector.value = ""; if(race1TimeChartContainer) race1TimeChartContainer.classList.add('hidden'); if(zedBalanceChartContainer) zedBalanceChartContainer.classList.add('hidden'); return; }

            profileName.textContent = `${item.name}'s Profile`;
            displayGen.textContent = item.gen || 'N/A'; displayGender.textContent = item.gender || 'N/A'; displayBreed.textContent = item.breed || 'N/A'; displayColourTrait.textContent = item.colourTrait || 'N/A';
            displaySireName.textContent = item.sireName || 'Unknown'; displaySireBreed.textContent = item.sireBreed || 'Unknown'; displaySireColourTrait.textContent = item.sireColourTrait || 'Unknown';
            displayDamName.textContent = item.damName || 'Unknown'; displayDamBreed.textContent = item.damBreed || 'Unknown'; displayDamColourTrait.textContent = item.damColourTrait || 'Unknown';
            displayOverall.textContent = item.overall || '-'; displaySpeed.textContent = item.speed || '-'; displaySprint.textContent = item.sprint || '-'; displayEndurance.textContent = item.endurance || '-';
            displayRaces.textContent = item.races ?? 'N/A'; displayFirst.textContent = item.first ?? 'N/A'; displaySecond.textContent = item.second ?? 'N/A'; displayThird.textContent = item.third ?? 'N/A'; displayPlaces.textContent = calculatePlaces(item);
            displayRace1Time.textContent = item.race1Time || 'N/A'; displayRace2Time.textContent = item.race2Time || 'N/A';
            if (displayAvgRaceTime) displayAvgRaceTime.textContent = calculateAverageRaceTime(item);
            displayCPU.textContent = item.cpu || 'N/A'; displayRAM.textContent = item.ram || 'N/A'; displayHydraulic.textContent = item.hydraulic || 'N/A';
            displayBreedCost.textContent = item.breedCost || 'N/A'; displayStrtZedBal.textContent = item.strtZedBal || 'N/A'; displayZedBalance.textContent = item.zedBalance || 'N/A'; displaySoldBreeds.textContent = item.soldBreeds || 'N/A'; displayROI.textContent = calculateROI(item);
            horseProfileDisplayDiv.classList.remove('hidden'); horseFormDiv.classList.add('hidden'); mainActionsDiv.classList.remove('hidden'); showDetailActionButtons();

            // Get current theme colors for chart text and grids
            const currentChartTextColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-text-color').trim();
            const currentChartGridColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid-color').trim();
            // Chart titles (H3) are styled by CSS directly using --heading-color via the H3 tag itself.

            // --- Race Times Chart (Combined Race 1 and Race 2) ---
            if (race1TimeChartContainer && race1TimeCanvas && race1NoDataMsg) {
                if (race1TimeChartInstance) { race1TimeChartInstance.destroy(); race1TimeChartInstance = null; }
                const race1History = (item.race1TimeHistory || []).filter(e => e && e.time && e.timestamp && parseRaceTime(e.time) !== null).sort((a, b) => a.timestamp - b.timestamp);
                const race2History = (item.race2TimeHistory || []).filter(e => e && e.time && e.timestamp && parseRaceTime(e.time) !== null).sort((a, b) => a.timestamp - b.timestamp);
                const combinedRaceHistory = [...race1History, ...race2History].filter(e => parseRaceTime(e.time) !== null);

                if (race1History.length >= 1 || race2History.length >= 1) {
                    race1TimeChartContainer.classList.remove('hidden'); race1TimeCanvas.classList.remove('hidden'); race1NoDataMsg.classList.add('hidden');
                    // Title "Race Times History" is set in HTML, color comes from H3 style

                    let overallFastestS = Infinity, overallSlowestS = 0, overallFastestT = "N/A", overallSlowestT = "N/A", validOverallT = false;
                    if(combinedRaceHistory.length > 0) { combinedRaceHistory.forEach(e => { const ts = parseRaceTime(e.time); if (ts !== null) { validOverallT = true; if (ts < overallFastestS) { overallFastestS = ts; overallFastestT = e.time; } if (ts > overallSlowestS) { overallSlowestS = ts; overallSlowestT = e.time; } } }); }

                    const datasets = [];
                    if (race1History.length > 0) { datasets.push({ label: 'Race 1 Time (s)', data: race1History.map(e => ({ x: e.timestamp, y: parseRaceTime(e.time), originalTime: e.time })), borderColor: 'rgb(75,192,192)', backgroundColor: 'rgba(75,192,192,0.2)', tension: 0.1, fill: false, order: 2 }); }
                    if (race2History.length > 0) { datasets.push({ label: 'Race 2 Time (s)', data: race2History.map(e => ({ x: e.timestamp, y: parseRaceTime(e.time), originalTime: e.time })), borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255,99,132,0.2)', tension: 0.1, fill: false, order: 3 }); }
                    if (validOverallT && combinedRaceHistory.length > 0) {
                        const allTimestamps = combinedRaceHistory.map(e => e.timestamp); const firstTs = Math.min(...allTimestamps); const lastTs = Math.max(...allTimestamps);
                        if (overallFastestS !== Infinity) { datasets.push({ label: 'Overall Fastest', data: [{x:firstTs,y:overallFastestS},{x:lastTs,y:overallFastestS}], borderColor:'rgb(40,167,69)', borderWidth:2, borderDash:[5,5], pointRadius:0, fill:false, tension:0, order:1 }); }
                        if (overallSlowestS > 0 && overallSlowestS !== Infinity && overallSlowestS !== overallFastestS) { datasets.push({ label: 'Overall Slowest', data: [{x:firstTs,y:overallSlowestS},{x:lastTs,y:overallSlowestS}], borderColor:'rgb(220,53,69)', borderWidth:2, borderDash:[5,5], pointRadius:0, fill:false, tension:0, order:0 }); }
                    }
                    let yOpt = { beginAtZero: false, title: { display: true, text: 'Time (s - Lower is Better)', color: currentChartTextColor }, ticks: { color: currentChartTextColor }, grid: { color: currentChartGridColor } };
                    if (validOverallT && overallFastestS !== Infinity) { const pad = Math.max((overallSlowestS - overallFastestS) * 0.1, 0.5) || 1; yOpt.suggestedMin = Math.max(0, overallFastestS - pad); yOpt.suggestedMax = overallSlowestS + pad; }

                    race1TimeChartInstance = new Chart(race1TimeCanvas.getContext('2d'), { type: 'line', data: { datasets: datasets },
                        options: {
                            responsive: true, maintainAspectRatio: true,
                            scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'PPpp', displayFormats: { day: 'MMM d' }}, title: { display: true, text: 'Date', color: currentChartTextColor }, ticks: { color: currentChartTextColor }, grid: { color: currentChartGridColor } }, y: yOpt },
                            plugins: { legend: {position:'top', labels:{color: currentChartTextColor}},
                                tooltip: { titleColor: currentChartTextColor, bodyColor: currentChartTextColor, backgroundColor: document.body.classList.contains('dark-mode') ? 'rgba(30,30,30,0.9)' : 'rgba(240,240,240,0.9)', callbacks: { title: (i) => (i[0].dataset.label.includes('Fastest') || i[0].dataset.label.includes('Slowest')) ? i[0].dataset.label : new Date(i[0].parsed.x).toLocaleDateString(), label: (c) => { let l=''; if(c.dataset.label==='Overall Fastest')l=`Fastest: ${overallFastestT} (${overallFastestS.toFixed(2)}s)`; else if(c.dataset.label==='Overall Slowest')l=`Slowest: ${overallSlowestT} (${overallSlowestS.toFixed(2)}s)`; else{l=c.dataset.label||'';if(l)l+=': ';const o=c.raw?.originalTime;if(o)l+=`${o} (${c.parsed.y.toFixed(2)}s)`;else if(c.parsed.y!==null)l+=c.parsed.y.toFixed(2)+'s';}return l;}}}}
                        }
                    });
                } else { race1TimeChartContainer.classList.remove('hidden'); race1TimeCanvas.classList.add('hidden'); race1NoDataMsg.textContent = "No race time data for Race 1 or Race 2."; race1NoDataMsg.classList.remove('hidden'); }
            } else console.error("Race Times Chart elements missing.");

            // ZED Balance Chart
            if (zedBalanceChartContainer && zedBalanceCanvas && zedBalanceNoDataMsg) { if (zedBalanceChartInstance) { zedBalanceChartInstance.destroy(); zedBalanceChartInstance = null; } const balHist = (item.zedBalanceHistory || []).filter(e => e && typeof e.balance === 'string' && e.timestamp && e.balance.trim() !== "").map(e => ({ ts: e.timestamp, val: parseNumericValue(e.balance), orig: e.balance })).filter(e => e.val !== null).sort((a,b) => a.ts - b.ts); if (balHist.length >= 1) { zedBalanceChartContainer.classList.remove('hidden'); zedBalanceCanvas.classList.remove('hidden'); zedBalanceNoDataMsg.classList.add('hidden'); const chartData = balHist.map(e => ({ x: e.ts, y: e.val })); zedBalanceChartInstance = new Chart(zedBalanceCanvas.getContext('2d'), { type: 'line', data: { datasets: [{ label: 'ZED Balance', data: chartData, borderColor: 'rgb(255,159,64)', backgroundColor: 'rgba(255,159,64,0.2)', tension: 0.1, fill: true, pointRadius: 3, pointHoverRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: true,
                    scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'PPpp', displayFormats: { day: 'MMM d' } }, title: { display: true, text: 'Date', color: currentChartTextColor }, ticks: { color: currentChartTextColor }, grid: { color: currentChartGridColor } }, y: { beginAtZero: false, title: { display: true, text: 'Balance', color: currentChartTextColor }, ticks: { callback: (v) => v.toLocaleString(undefined, {minimumFractionDigits:0,maximumFractionDigits:2}), color: currentChartTextColor }, grid: { color: currentChartGridColor } } },
                    plugins: { legend: { position:'top', labels:{color: currentChartTextColor} },
                        tooltip: { titleColor: currentChartTextColor, bodyColor: currentChartTextColor, backgroundColor: document.body.classList.contains('dark-mode') ? 'rgba(30,30,30,0.9)' : 'rgba(240,240,240,0.9)', callbacks: { title: (i) => new Date(i[0].parsed.x).toLocaleDateString(), label: (c) => { let l = c.dataset.label || ''; if(l) l+=': '; const origE = balHist.find(bh => bh.ts === c.parsed.x); if (origE && origE.orig) l += origE.orig; else if (c.parsed.y !== null) l += c.parsed.y.toLocaleString(undefined, {minimumFractionDigits:2,maximumFractionDigits:2}); return l; } } }
                    }
                }
            }); } else { zedBalanceChartContainer.classList.remove('hidden'); zedBalanceCanvas.classList.add('hidden'); zedBalanceNoDataMsg.textContent = "No ZED Balance history."; zedBalanceNoDataMsg.classList.remove('hidden'); } } else console.error("ZED Balance Chart elements missing.");
            const navItems = getNavigableHorses(), curIdx = navItems.findIndex(h => h.id === itemId); prevHorseBtn.disabled = (curIdx <= 0); nextHorseBtn.disabled = (curIdx < 0 || curIdx >= navItems.length - 1);
        }
        function renderPoolPage() { const items = horsesData.filter(h => h && h.status === 'breeding'); renderPoolList(items.filter(h => h.gender === 'M'), siresListElement, "Sires"); renderPoolList(items.filter(h => h.gender === 'F'), damsListElement, "Dams"); }
        function renderPoolList(items, target, type) {
            target.innerHTML = ''; if (items.length === 0) { target.innerHTML = `<p class="no-horses">No ${type} in Pool.</p>`; return; }
            items.sort((a, b) => a.name.localeCompare(b.name));
            items.forEach(item => {
                const card = document.createElement('div'); card.className = 'horse-card';
                let finHTML = ''; if (type === "Sires") finHTML = `<div class="financials-pool"><h4>Financials</h4> <p><strong>Cost:</strong> <span>${item.breedCost||'N/A'}</span></p> <p><strong>Start Bal:</strong> <span>${item.strtZedBal||'N/A'}</span></p> <p><strong>Balance:</strong> <span>${item.zedBalance||'N/A'}</span></p> <p><strong>Total Value Sold:</strong> <span>${item.soldBreeds||'N/A'}</span></p> </div>`;
                card.innerHTML = `<h3>${item.name}</h3> <h4>Basic</h4> <p><strong>Gen:</strong> <span>${item.gen||'N/A'}</span></p> <p><strong>Breed:</strong> <span>${item.breed||'N/A'}</span></p> <p><strong>Colour:</strong> <span>${item.colourTrait||'N/A'}</span></p> <h4>Stats</h4> <p><strong>Overall:</strong> <span class="stars">${item.overall||'-'}</span></p> <p><strong>Speed:</strong> <span class="stars">${item.speed||'-'}</span></p> <p><strong>Sprint:</strong> <span class="stars">${item.sprint||'-'}</span></p> <p><strong>Endurance:</strong> <span class="stars">${item.endurance||'-'}</span></p> <h4>Record</h4> <p><strong>Races:</strong> <span>${item.races??'N/A'}</span></p> <p><strong>1st:</strong> <span>${item.first??'N/A'}</span></p> <p><strong>2nd:</strong> <span>${item.second??'N/A'}</span></p> <p><strong>3rd:</strong> <span>${item.third??'N/A'}</span></p> <p><strong>Places:</strong> <span>${calculatePlaces(item)}</span></p> <p><strong>Avg Race Time:</strong> <span>${calculateAverageRaceTime(item)}</span></p> ${finHTML} <a href="#" class="view-details-link" data-id="${item.id}">Details</a>`;
                card.querySelector('.view-details-link').addEventListener('click', (e) => { e.preventDefault(); showDetailPage(item.id); });
                target.appendChild(card);
            });
        }
        function renderBreedsPage() { breedingRecordsList.innerHTML = ''; const offspring = horsesData.filter(h => h && h.status !== 'forged' && (h.sireName || h.damName)); if (offspring.length === 0) { breedingRecordsList.innerHTML = '<p class="no-records">No records found.</p>'; } else { offspring.sort((a, b) => a.name.localeCompare(b.name)); const starOpts = ` <option value="-">-</option> <option>⭐️</option> <option>⭐️⭐️</option> <option>⭐️⭐️☀️</option> <option>⭐️⭐️⭐️</option> <option>⭐️⭐️⭐️☀️</option> <option>⭐️⭐️⭐️⭐️</option> <option>⭐️⭐️⭐️⭐️☀️</option> <option>⭐️⭐️⭐️⭐️⭐️</option> `; const breedOpts = `<option value="">Unknown</option><option>Nakamoto</option><option>Szabo</option><option>Finney</option><option>Buterin</option>`; const genOpts = `<option value="">Unknown</option><option>G0</option><option>G1</option><option>G2</option><option>G3</option><option>G4</option><option>G5</option>`; const createNameEl = (name, obj) => { if (obj && obj.status !== 'forged') return `<span class="clickable-horse-name" onclick="showDetailPage(${obj.id})">${name}</span>`; else if (name) { let suffix = (obj && obj.status === 'forged') ? ' <span class="forged-label">(Removed)</span>' : ' <em style="font-size:0.8em; color:var(--text-color); opacity: 0.7;">(Not found)</em>'; return `<span class="non-clickable-name">${name}</span>${suffix}`; } else return 'Unknown'; }; offspring.forEach(child => { const sire = findHorseByName(child.sireName), dam = findHorseByName(child.damName); const sireP = calculatePlaces(sire), damP = calculatePlaces(dam), childP = calculatePlaces(child); const canEditS = sire && sire.status !== 'forged', canEditD = dam && dam.status !== 'forged'; const sireO = child.sireOverall || (sire ? sire.overall : '-') || '-', sireSp = child.sireSpeed || (sire ? sire.speed : '-') || '-', sireSr = child.sireSprint || (sire ? sire.sprint : '-') || '-', sireE = child.sireEndurance || (sire ? sire.endurance : '-') || '-'; const damO = child.damOverall || (dam ? dam.overall : '-') || '-', damSp = child.damSpeed || (dam ? dam.speed : '-') || '-', damSr = child.damSprint || (dam ? dam.sprint : '-') || '-', damE = child.damEndurance || (dam ? dam.endurance : '-') || '-'; const childO = child.overall || '-', childSp = child.speed || '-', childSr = child.sprint || '-', childE = child.endurance || '-'; const card = document.createElement('div'); card.className = 'breeding-record-card'; card.setAttribute('data-offspring-id', child.id); const sireName = createNameEl(child.sireName, sire), damName = createNameEl(child.damName, dam), childName = createNameEl(child.name, child); let sireHTML = `<div class="parent-section" data-parent-id="${sire?.id || ''}"><h3>Sire</h3><div class="horse-details display-details"><p><strong>Name:</strong> ${sireName}</p><p><strong>Breed:</strong> <span>${sire?.breed || child.sireBreed || 'N/A'}</span></p><p><strong>Colour:</strong> <span>${sire?.colourTrait || child.sireColourTrait || 'N/A'}</span></p><p><strong>Gen:</strong> <span>${sire?.gen || 'N/A'}</span></p><p><strong>Overall:</strong> <span class="stars">${sireO}</span></p><p><strong>Speed:</strong> <span class="stars">${sireSp}</span></p><p><strong>Sprint:</strong> <span class="stars">${sireSr}</span></p><p><strong>Endurance:</strong> <span class="stars">${sireE}</span></p><p><strong>Races:</strong> <span>${sire?.races ?? 'N/A'}</span></p><p><strong>Places:</strong> <span>${sire ? sireP : 'N/A'}</span></p></div><div class="inline-edit-form hidden"><label>Breed:</label> <select class="inline-breed">${breedOpts}</select> <label>Colour:</label> <select class="inline-colour">${breedOpts}</select><label>Gen:</label> <select class="inline-gen">${genOpts}</select> <label>Overall:</label> <select class="inline-overall">${starOpts}</select><label>Speed:</label> <select class="inline-speed">${starOpts}</select> <label>Sprint:</label> <select class="inline-sprint">${starOpts}</select><label>Endurance:</label> <select class="inline-endurance">${starOpts}</select> <label>Races:</label> <input type="number" class="inline-races" min="0"> <div class="inline-edit-buttons"><button class="button-link btn-primary btn-sm save-parent-edit">Save</button> <button type="button" class="button-link btn-secondary btn-sm cancel-parent-edit">Cancel</button></div></div>${canEditS ? `<button class="button-link btn-warning btn-sm edit-parent-button">Edit Sire</button>` : ''}</div>`; let damHTML = `<div class="parent-section" data-parent-id="${dam?.id || ''}"><h3>Dam</h3><div class="horse-details display-details"><p><strong>Name:</strong> ${damName}</p><p><strong>Breed:</strong> <span>${dam?.breed || child.damBreed || 'N/A'}</span></p><p><strong>Colour:</strong> <span>${dam?.colourTrait || child.damColourTrait || 'N/A'}</span></p><p><strong>Gen:</strong> <span>${dam?.gen || 'N/A'}</span></p><p><strong>Overall:</strong> <span class="stars">${damO}</span></p><p><strong>Speed:</strong> <span class="stars">${damSp}</span></p><p><strong>Sprint:</strong> <span class="stars">${damSr}</span></p><p><strong>Endurance:</strong> <span class="stars">${damE}</span></p><p><strong>Races:</strong> <span>${dam?.races ?? 'N/A'}</span></p><p><strong>Places:</strong> <span>${dam ? damP : 'N/A'}</span></p></div><div class="inline-edit-form hidden"><label>Breed:</label> <select class="inline-breed">${breedOpts}</select> <label>Colour:</label> <select class="inline-colour">${breedOpts}</select><label>Gen:</label> <select class="inline-gen">${genOpts}</select> <label>Overall:</label> <select class="inline-overall">${starOpts}</select><label>Speed:</label> <select class="inline-speed">${starOpts}</select> <label>Sprint:</label> <select class="inline-sprint">${starOpts}</select><label>Endurance:</label> <select class="inline-endurance">${starOpts}</select> <label>Races:</label> <input type="number" class="inline-races" min="0"> <div class="inline-edit-buttons"><button class="button-link btn-primary btn-sm save-parent-edit">Save</button> <button type="button" class="button-link btn-secondary btn-sm cancel-parent-edit">Cancel</button></div></div>${canEditD ? `<button class="button-link btn-warning btn-sm edit-parent-button">Edit Dam</button>` : ''}</div>`; let offspringHTML = `<div class="offspring-section"><h3>Offspring</h3><div class="horse-details"><p><strong>Name:</strong> ${childName}</p><p><strong>Breed:</strong> <span>${child.breed||'N/A'}</span></p><p><strong>Colour:</strong> <span>${child.colourTrait||'N/A'}</span></p><p><strong>Gen:</strong> <span>${child.gen||'N/A'}</span></p><p><strong>Overall:</strong> <span class="stars">${childO}</span></p><p><strong>Speed:</strong> <span class="stars">${childSp}</span></p><p><strong>Sprint:</strong> <span class="stars">${childSr}</span></p><p><strong>Endurance:</strong> <span class="stars">${childE}</span></p><p><strong>Races:</strong> <span>${child.races??'N/A'}</span></p><p><strong>Places:</strong> <span>${childP}</span></p><p><strong>Cost:</strong> <span>${child.breedCost||'N/A'}</span></p></div><button class="button-link btn-warning btn-sm edit-offspring-button" data-id="${child.id}">Edit Offspring</button></div>`; card.innerHTML = `<div class="record-details">${sireHTML}${damHTML}${offspringHTML}</div>`; breedingRecordsList.appendChild(card); }); } if (offspringResultDiv) offspringResultDiv.classList.add('hidden'); }
        function renderLineagePage() { lineageDisplayArea.innerHTML = '<p class="no-lineage">Generating lineage...</p>'; const allItems = [...horsesData]; if (allItems.length === 0) { lineageDisplayArea.innerHTML = '<p class="no-lineage">No items found.</p>'; return; } const families = {}; allItems.forEach(item => { if (item.sireName && item.damName) { const key = `${item.sireName.toLowerCase().trim()} & ${item.damName.toLowerCase().trim()}`; if (!families[key]) families[key] = { sire: findHorseByName(item.sireName), dam: findHorseByName(item.damName), sireNameDisplay: item.sireName, damNameDisplay: item.damName, offspring: [] }; families[key].offspring.push(item); } }); if (Object.keys(families).length === 0) { lineageDisplayArea.innerHTML = '<p class="no-lineage">No items with known parents.</p>'; return; } let finalHTML = ''; for (const key in families) { const family = families[key]; family.offspring.sort((a,b) => a.name.localeCompare(b.name)); const ref = family.offspring[0]; finalHTML += `<div class="lineage-family-card">`; finalHTML += `<div class="lineage-parent"><strong>Sire:</strong> <span>${family.sire ? family.sire.name : family.sireNameDisplay}</span>`; if (ref) { let stats = []; if (ref.sireOverall && ref.sireOverall !== '-') stats.push(`O: <span class="stars">${ref.sireOverall}</span>`); if (ref.sireSpeed && ref.sireSpeed !== '-') stats.push(`Spd: <span class="stars">${ref.sireSpeed}</span>`); if (ref.sireSprint && ref.sireSprint !== '-') stats.push(`Spr: <span class="stars">${ref.sireSprint}</span>`); if (ref.sireEndurance && ref.sireEndurance !== '-') stats.push(`End: <span class="stars">${ref.sireEndurance}</span>`); if (stats.length > 0) finalHTML += ` <span class="lineage-parent-stats">(${stats.join(', ')})</span>`; } if (family.sire && family.sire.status === 'forged') finalHTML += ` <span class="forged-label">(Forged)</span>`; finalHTML += `</div>`; finalHTML += `<div class="lineage-parent"><strong>Dam:</strong> <span>${family.dam ? family.dam.name : family.damNameDisplay}</span>`; if (ref) { let stats = []; if (ref.damOverall && ref.damOverall !== '-') stats.push(`O: <span class="stars">${ref.damOverall}</span>`); if (ref.damSpeed && ref.damSpeed !== '-') stats.push(`Spd: <span class="stars">${ref.damSpeed}</span>`); if (ref.damSprint && ref.damSprint !== '-') stats.push(`Spr: <span class="stars">${ref.damSprint}</span>`); if (ref.damEndurance && ref.damEndurance !== '-') stats.push(`End: <span class="stars">${ref.damEndurance}</span>`); if (stats.length > 0) finalHTML += ` <span class="lineage-parent-stats">(${stats.join(', ')})</span>`; } if (family.dam && family.dam.status === 'forged') finalHTML += ` <span class="forged-label">(Forged)</span>`; finalHTML += `</div>`; finalHTML += `<div style="margin-left: 20px; margin-top: 10px;">`; family.offspring.forEach(child => { finalHTML += `<div class="lineage-offspring">↳ <span>${child.name}</span>`; if (child.overall && child.overall !== '-') finalHTML += ` <span class="stars">${child.overall}</span>`; if (child.status === 'forged') finalHTML += ` <span class="forged-label">(Forged)</span>`; finalHTML += `</div>`; }); finalHTML += `</div></div>`; } lineageDisplayArea.innerHTML = finalHTML || '<p class="no-lineage">No lineages found.</p>'; }
        function renderFinancialsPage() { financialsTableBody.innerHTML = ''; financialsTableFooter.innerHTML = ''; const items = horsesData.filter(h => h); if (items.length === 0) { financialsTableBody.innerHTML = '<tr><td colspan="5" class="no-horses">No items found.</td></tr>'; return; } let totCost = 0, totBal = 0, totPL = 0, totSold = 0; items.sort((a,b) => a.name.localeCompare(b.name)); items.forEach(item => { const row = document.createElement('tr'); const costN=parseNumericValue(item.breedCost), balN=parseNumericValue(item.zedBalance), soldN=parseNumericValue(item.soldBreeds); const profitSlsN=soldN*0.05, plStr=calculateROI(item); let nameD = item.name; if (item.status === 'forged') { nameD += ' <span class="forged-label" style="font-weight:normal;">(Forged)</span>'; row.style.opacity = '0.6'; } totCost += costN; totBal += balN; totSold += soldN; totPL += (balN - costN + profitSlsN); row.innerHTML = `<td>${item.status !== 'forged' ? `<span class="action-link" onclick="showDetailPage(${item.id})">${nameD}</span>` : nameD}</td> <td>${item.breedCost||'N/A'}</td> <td>${item.zedBalance||'N/A'}</td> <td>${item.soldBreeds||'N/A'}</td> <td>${plStr}</td>`; financialsTableBody.appendChild(row); }); const footRow = document.createElement('tr'); footRow.classList.add('table-footer'); footRow.innerHTML = `<td><strong>Totals:</strong></td> <td class="footer-total">${formatNumericValue(totCost)}</td> <td class="footer-total">${formatNumericValue(totBal)}</td> <td class="footer-total">${formatNumericValue(totSold)}</td> <td class="footer-total">${(totPL >= 0 ? '+' : '')}${totPL.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>`; financialsTableFooter.appendChild(footRow); }

        // ========================================================================
        // == DETAIL PAGE FORM HANDLING & ACTIONS ==
        // ========================================================================
        function hideDetailActionButtons() { editButton.classList.add('hidden'); sendToBreedingPoolButton.classList.add('hidden'); forgeButton.classList.add('hidden'); prevHorseBtn.classList.add('hidden'); nextHorseBtn.classList.add('hidden'); }
        function showDetailActionButtons() { const item = findHorseById(currentDetailHorseId); if (item && item.status !== 'forged') { editButton.classList.remove('hidden'); sendToBreedingPoolButton.classList.remove('hidden'); forgeButton.classList.remove('hidden'); prevHorseBtn.classList.remove('hidden'); nextHorseBtn.classList.remove('hidden'); } else hideDetailActionButtons(); }
        function clearDetailForm() { editAddForm.reset(); horseIdInput.value = ""; }
        function populateFormForEdit(itemId) {
            const item = findHorseById(itemId); if (!item || item.status === 'forged') return;
            horseIdInput.value = item.id; inputName.value = item.name || ""; inputGen.value = item.gen || ""; inputGender.value = item.gender || "M"; inputBreed.value = item.breed || ""; inputColourTrait.value = item.colourTrait || "";
            inputSireName.value = item.sireName || ""; inputSireBreed.value = item.sireBreed || ""; inputSireColourTrait.value = item.sireColourTrait || ""; inputSireOverall.value = item.sireOverall || "-"; inputSireSpeed.value = item.sireSpeed || "-"; inputSireSprint.value = item.sireSprint || "-"; inputSireEndurance.value = item.sireEndurance || "-";
            inputDamName.value = item.damName || ""; inputDamBreed.value = item.damBreed || ""; inputDamColourTrait.value = item.damColourTrait || ""; inputDamOverall.value = item.damOverall || "-"; inputDamSpeed.value = item.damSpeed || "-"; inputDamSprint.value = item.damSprint || "-"; inputDamEndurance.value = item.damEndurance || "-";
            inputOverall.value = item.overall || "-"; inputSpeed.value = item.speed || "-"; inputSprint.value = item.sprint || "-"; inputEndurance.value = item.endurance || "-";
            inputRaces.value = item.races ?? 0; inputFirst.value = item.first ?? 0; inputSecond.value = item.second ?? 0; inputThird.value = item.third ?? 0;
            inputRace1Time.value = item.race1Time || ""; inputRace2Time.value = item.race2Time || "";
            inputCPU.value = item.cpu || ""; inputRAM.value = item.ram || ""; inputHydraulic.value = item.hydraulic || "";
            inputBreedCost.value = item.breedCost || ""; inputStrtZedBal.value = item.strtZedBal || ""; inputZedBalance.value = item.zedBalance || ""; inputSoldBreeds.value = "";
        }
        function showEditForm() { if (!currentDetailHorseId) return; const item = findHorseById(currentDetailHorseId); if (!item || item.status === 'forged') { alert("Cannot edit removed item."); return; } formTitle.textContent = `Edit ${item.name}`; clearDetailForm(); populateFormForEdit(currentDetailHorseId); inputSoldBreeds.value = ""; horseFormDiv.classList.remove('hidden'); horseProfileDisplayDiv.classList.add('hidden'); mainActionsDiv.classList.add('hidden'); saveChangesButton.classList.remove('hidden'); saveNewButton.classList.add('hidden'); document.getElementById('race1TimeChartContainer')?.classList.add('hidden'); document.getElementById('zedBalanceChartContainer')?.classList.add('hidden'); }
        function showAddForm() { currentDetailHorseId = null; formTitle.textContent = "Add New Item"; clearDetailForm(); inputOverall.value = "-"; inputSpeed.value = "-"; inputSprint.value = "-"; inputEndurance.value = "-"; inputSireOverall.value = "-"; inputSireSpeed.value = "-"; inputSireSprint.value = "-"; inputSireEndurance.value = "-"; inputDamOverall.value = "-"; inputDamSpeed.value = "-"; inputDamSprint.value = "-"; inputDamEndurance.value = "-"; inputSoldBreeds.value = ""; horseFormDiv.classList.remove('hidden'); horseProfileDisplayDiv.classList.add('hidden'); mainActionsDiv.classList.add('hidden'); saveChangesButton.classList.add('hidden'); saveNewButton.classList.remove('hidden'); document.getElementById('race1TimeChartContainer')?.classList.add('hidden'); document.getElementById('zedBalanceChartContainer')?.classList.add('hidden'); }
        function readFormData() {
            const getStarValue = (selectElement) => { if (!selectElement) return ""; return selectElement.value === "-" ? "" : selectElement.value; };
            const formData = {
                id: parseInt(horseIdInput.value) || null, name: inputName.value.trim(), gen: inputGen.value, gender: inputGender.value, breed: inputBreed.value, colourTrait: inputColourTrait.value,
                sireName: inputSireName.value.trim(), sireBreed: inputSireBreed.value, sireColourTrait: inputSireColourTrait.value, sireOverall: getStarValue(inputSireOverall), sireSpeed: getStarValue(inputSireSpeed), sireSprint: getStarValue(inputSireSprint), sireEndurance: getStarValue(inputSireEndurance),
                damName: inputDamName.value.trim(), damBreed: inputDamBreed.value, damColourTrait: inputDamColourTrait.value, damOverall: getStarValue(inputDamOverall), damSpeed: getStarValue(inputDamSpeed), damSprint: getStarValue(inputDamSprint), damEndurance: getStarValue(inputDamEndurance),
                overall: getStarValue(inputOverall), speed: getStarValue(inputSpeed), sprint: getStarValue(inputSprint), endurance: getStarValue(inputEndurance),
                races: parseInt(inputRaces.value) || 0, first: parseInt(inputFirst.value) || 0, second: parseInt(inputSecond.value) || 0, third: parseInt(inputThird.value) || 0,
                race1Time: inputRace1Time.value.trim() || null, race2Time: inputRace2Time.value.trim() || null,
                cpu: inputCPU.value, ram: inputRAM.value, hydraulic: inputHydraulic.value,
                breedCost: inputBreedCost.value.trim(), strtZedBal: inputStrtZedBal.value.trim(), zedBalance: inputZedBalance.value.trim(), soldBreeds: inputSoldBreeds.value.trim(),
                status: 'active', order: null
            };
            if (formData.id) { const originalItem = findHorseById(formData.id); if (originalItem) { formData.status = originalItem.status; formData.order = originalItem.order; } }
            return formData;
        }
        function cancelDetailForm() { horseFormDiv.classList.add('hidden'); mainActionsDiv.classList.remove('hidden'); if (currentDetailHorseId) renderHorseDetail(currentDetailHorseId); else showPage('overviewPage'); }
        function handleSendToBreedingPool() { if (!currentDetailHorseId) { alert("No item selected."); return; } const index = findIndexById(currentDetailHorseId); if (index === -1) { alert("Item not found."); return; } if (horsesData[index].status === 'forged') { alert("Cannot send removed item."); return; } if (window.confirm(`Send "${horsesData[index].name}" to Pool?`)) { horsesData[index].status = 'breeding'; saveHorsesData(); alert(`"${horsesData[index].name}" sent to Pool.`); renderHorseDetail(currentDetailHorseId); populateHorseSelectorForDetail(); } }
        function handleForgeHorse() { if (!currentDetailHorseId) { alert("No item selected."); return; } const index = findIndexById(currentDetailHorseId); if (index === -1) { alert("Item not found."); return; } if (horsesData[index].status === 'forged') { alert("Already removed."); return; } if (window.confirm(`Forge "${horsesData[index].name}"? Kept for records, cannot be undone easily.`)) { horsesData[index].status = 'forged'; horsesData[index].order = null; saveHorsesData(); alert(`"${horsesData[index].name}" Forged.`); currentDetailHorseId = null; showPage('overviewPage'); } }

        // **** REFINED handleFormSubmit for ZED Balance and Race Time Histories ****
        function handleFormSubmit(event) {
             event.preventDefault();
             const formData = readFormData();

             if (!formData.name) { alert("Item Name is required!"); inputName.focus(); return; }
             const editingItemId = formData.id;

             if (editingItemId === null) { // Adding NEW item
                 formData.id = nextId++;
                 formData.order = horsesData.filter(h => h.status === 'active').reduce((max, h) => Math.max(max, h.order ?? -1), -1) + 1;
                 formData.status = 'active';
                 formData.soldBreeds = String(parseNumericValue(formData.soldBreeds));
                 formData.race1TimeHistory = []; formData.race2TimeHistory = [];
                 formData.augmentHistory = []; formData.zedBalanceHistory = [];

                 const startBalance = formData.strtZedBal;
                 const currentBalance = formData.zedBalance;
                 let firstTimestamp = Date.now();

                 if (startBalance && startBalance.trim() !== "") {
                     formData.zedBalanceHistory.push({ timestamp: firstTimestamp, balance: startBalance });
                     if (currentBalance && currentBalance.trim() !== "" && currentBalance !== startBalance) {
                         formData.zedBalanceHistory.push({ timestamp: firstTimestamp + 1, balance: currentBalance });
                     }
                 } else if (currentBalance && currentBalance.trim() !== "") {
                     formData.zedBalanceHistory.push({ timestamp: firstTimestamp, balance: currentBalance });
                 }

                 if (formData.race1Time && parseRaceTime(formData.race1Time) !== null) formData.race1TimeHistory.push({ timestamp: Date.now(), time: formData.race1Time });
                 if (formData.race2Time && parseRaceTime(formData.race2Time) !== null) formData.race2TimeHistory.push({ timestamp: Date.now() + 1, time: formData.race2Time });

                 horsesData.push(formData); currentDetailHorseId = formData.id; alert(`${formData.name} added successfully!`);

             } else { // Editing EXISTING item
                 const index = findIndexById(editingItemId);
                 if (index !== -1) {
                     const originalItem = { ...horsesData[index] };
                     if (originalItem.status === 'forged') { alert("Cannot save changes to a removed item."); cancelDetailForm(); return; }

                     formData.soldBreeds = String(parseNumericValue(originalItem.soldBreeds) + parseNumericValue(formData.soldBreeds));
                     if (!Array.isArray(originalItem.augmentHistory)) originalItem.augmentHistory = [];
                     if (originalItem.cpu !== formData.cpu || originalItem.ram !== formData.ram || originalItem.hydraulic !== formData.hydraulic) {
                         originalItem.augmentHistory.push({ timestamp: Date.now(), cpu: formData.cpu, ram: formData.ram, hydraulic: formData.hydraulic });
                     }
                     formData.augmentHistory = originalItem.augmentHistory;

                     const newZedBalanceFromForm = formData.zedBalance;
                     const newStrtZedBalFromForm = formData.strtZedBal;
                     if (!Array.isArray(originalItem.zedBalanceHistory)) originalItem.zedBalanceHistory = [];

                     let hasStartBalanceChanged = originalItem.strtZedBal !== newStrtZedBalFromForm;

                     // If history is empty AND a start balance is provided in the form (new or changed)
                     if (originalItem.zedBalanceHistory.length === 0 && newStrtZedBalFromForm && newStrtZedBalFromForm.trim() !== "") {
                         originalItem.zedBalanceHistory.push({ timestamp: Date.now() - 100000, balance: newStrtZedBalFromForm });
                         // If current balance is also provided AND different from this newly set start balance, add it too.
                         if (newZedBalanceFromForm && newZedBalanceFromForm.trim() !== "" && newZedBalanceFromForm !== newStrtZedBalFromForm) {
                             originalItem.zedBalanceHistory.push({ timestamp: Date.now() - 99000, balance: newZedBalanceFromForm });
                         }
                     }
                     // If history is NOT empty, but the start balance in the form was changed
                     else if (hasStartBalanceChanged && newStrtZedBalFromForm && newStrtZedBalFromForm.trim() !== "") {
                         // This indicates a correction of the start balance after history has begun.
                         // Simplest approach: update the first record if it was the original start balance.
                         // More robust might involve inserting or indicating a correction.
                         // For now, if the very first entry *was* the old start balance, update it.
                         if (originalItem.zedBalanceHistory.length > 0 && originalItem.zedBalanceHistory[0].balance === originalItem.strtZedBal) {
                             originalItem.zedBalanceHistory[0].balance = newStrtZedBalFromForm;
                             // originalItem.zedBalanceHistory[0].timestamp = Date.now() - 100000; // Optionally update timestamp
                         }
                         // If the history isn't empty but doesn't start with the old strtZedBal (e.g. it was empty then current bal added)
                         // and now a strtZedBal is entered, prepend it.
                         else if (originalItem.zedBalanceHistory.length > 0 && newStrtZedBalFromForm !== originalItem.zedBalanceHistory[0].balance) {
                            // This case is complex if we want to preserve chronological order strictly.
                            // For now, if a strtZedBal is changed and history exists, we focus on currentBalance updates below.
                            // The main strtZedBal property on the horse will be updated by `formData.strtZedBal`.
                         }
                     }

                     // Handle Current Balance (zedBalance) Update from form
                     const lastZedBalanceEntry = originalItem.zedBalanceHistory.length > 0 ? originalItem.zedBalanceHistory[originalItem.zedBalanceHistory.length - 1] : null;
                     if (newZedBalanceFromForm && typeof newZedBalanceFromForm === 'string' && newZedBalanceFromForm.trim() !== "" &&
                         (!lastZedBalanceEntry || lastZedBalanceEntry.balance !== newZedBalanceFromForm)) {
                         originalItem.zedBalanceHistory.push({ timestamp: Date.now(), balance: newZedBalanceFromForm });
                     }
                     formData.zedBalanceHistory = originalItem.zedBalanceHistory;


                     if (!Array.isArray(originalItem.race1TimeHistory)) originalItem.race1TimeHistory = [];
                     const lastRace1TimeEntry = originalItem.race1TimeHistory.length > 0 ? originalItem.race1TimeHistory[originalItem.race1TimeHistory.length - 1] : null;
                     if (formData.race1Time && parseRaceTime(formData.race1Time) !== null && (!lastRace1TimeEntry || lastRace1TimeEntry.time !== formData.race1Time)) {
                         originalItem.race1TimeHistory.push({ timestamp: Date.now(), time: formData.race1Time });
                     }
                     formData.race1TimeHistory = originalItem.race1TimeHistory;

                     if (!Array.isArray(originalItem.race2TimeHistory)) originalItem.race2TimeHistory = [];
                     const lastRace2TimeEntry = originalItem.race2TimeHistory.length > 0 ? originalItem.race2TimeHistory[originalItem.race2TimeHistory.length - 1] : null;
                     if (formData.race2Time && parseRaceTime(formData.race2Time) !== null && (!lastRace2TimeEntry || lastRace2TimeEntry.time !== formData.race2Time)) {
                         originalItem.race2TimeHistory.push({ timestamp: Date.now() + 1, time: formData.race2Time });
                     }
                     formData.race2TimeHistory = originalItem.race2TimeHistory;

                     horsesData[index] = { ...originalItem, ...formData };
                     currentDetailHorseId = editingItemId;
                     alert(`${formData.name} updated successfully!`);
                 } else { console.error("Update Error: Could not find item with ID", editingItemId); alert("Error updating item data. Item not found."); cancelDetailForm(); return; }
             }
             saveHorsesData(); horseFormDiv.classList.add('hidden'); mainActionsDiv.classList.remove('hidden'); populateHorseSelectorForDetail(); renderHorseDetail(currentDetailHorseId);
         }

        // ========================================================================
        // == BREEDING SIMULATION FUNCTIONS ==
        // ========================================================================
        function populateBreedingSelectors() { selectSire.innerHTML = '<option value="">-- Select Sire --</option>'; selectDam.innerHTML = '<option value="">-- Select Dam --</option>'; breedButton.disabled = true; offspringResultDiv.classList.add('hidden'); const sires = horsesData.filter(h => h.gender === 'M' && h.status !== 'forged').sort((a, b) => a.name.localeCompare(b.name)); const dams = horsesData.filter(h => h.gender === 'F' && h.status !== 'forged').sort((a, b) => a.name.localeCompare(b.name)); sires.forEach(s => { const o=document.createElement('option'); o.value=s.id; o.textContent=`${s.name} (${s.gen})`; selectSire.appendChild(o); }); dams.forEach(d => { const o=document.createElement('option'); o.value=d.id; o.textContent=`${d.name} (${d.gen})`; selectDam.appendChild(o); }); }
        function checkBreedButtonState() { breedButton.disabled = !(selectSire.value && selectDam.value); }
        function handleBreedClick() { const sire = findHorseById(parseInt(selectSire.value)), dam = findHorseById(parseInt(selectDam.value)); if (!sire || !dam) { alert("Select Sire & Dam."); return; } tempOffspringData = generateOffspring(sire, dam); displayOffspringResult(tempOffspringData); }
        function generateOffspring(sire, dam) {
            const offGen=`G${Math.max(parseGen(sire.gen),parseGen(dam.gen))+1}`, offGender=Math.random()<0.5?'M':'F', offBreed=Math.random()<0.5?sire.breed:dam.breed, offColour=Math.random()<0.5?sire.colourTrait:dam.colourTrait;
            const calcStat=(sStat,dStat,breed,statName)=>{let sVal=getStarNumericValue(sStat),dVal=getStarNumericValue(dStat),avg=(sVal+dVal)/2,adj=0,rand=(Math.random()*0.5)-0.25;switch(breed){case 'Nakamoto':if(statName==='sprint')adj=0.25;if(statName==='endurance')adj=-0.15;break;case 'Szabo':if(statName==='endurance')adj=0.2;if(statName==='sprint')adj=-0.1;if(statName==='speed')adj=0.1;break;case 'Finney':if(statName==='endurance')adj=0.25;if(statName==='sprint')adj=-0.15;break;case 'Buterin':rand+=(Math.random()*1.0)-0.5;break;} return mapNumericToStars(Math.max(1,Math.min(5,avg+adj+rand)));};
            return {
                name:"", gen:offGen, gender:offGender, breed:offBreed, colourTrait:offColour,
                sireName:sire.name, sireBreed:sire.breed, sireColourTrait:sire.colourTrait, sireOverall:sire.overall||"-", sireSpeed:sire.speed||"-", sireSprint:sire.sprint||"-", sireEndurance:sire.endurance||"-",
                damName:dam.name, damBreed:dam.breed, damColourTrait:dam.colourTrait, damOverall:dam.overall||"-", damSpeed:dam.speed||"-", damSprint:dam.sprint||"-", damEndurance:dam.endurance||"-",
                overall:calcStat(sire.overall,dam.overall,offBreed,'overall'), speed:calcStat(sire.speed,dam.speed,offBreed,'speed'), sprint:calcStat(sire.sprint,dam.sprint,offBreed,'sprint'), endurance:calcStat(sire.endurance,dam.endurance,offBreed,'endurance'),
                races:0, first:0, second:0, third:0,
                race1Time:null, race2Time:null,
                cpu:null, ram:null, hydraulic:null,
                breedCost:"", strtZedBal:"", zedBalance:"", soldBreeds:"",
                race1TimeHistory:[], race2TimeHistory:[],
                augmentHistory:[], zedBalanceHistory:[], status:'active', order:null
            };
        }
        function displayOffspringResult(data) { if (!data || !offspringResultDiv) return; inputOffspringName.value = ""; offspringGenSpan.textContent = data.gen||'N/A'; offspringGenderSpan.textContent = data.gender||'N/A'; offspringBreedSpan.textContent = data.breed||'N/A'; offspringColourTraitSpan.textContent = data.colourTrait||'N/A'; offspringOverallSpan.textContent = data.overall||'-'; offspringSpeedSpan.textContent = data.speed||'-'; offspringSprintSpan.textContent = data.sprint||'-'; offspringEnduranceSpan.textContent = data.endurance||'-'; offspringSireNameSpan.textContent = data.sireName||'N/A'; offspringDamNameSpan.textContent = data.damName||'N/A'; offspringResultDiv.classList.remove('hidden'); }
        function handleAddOffspring() {
            if (!tempOffspringData) { alert("No offspring generated."); return; }
            const name = inputOffspringName.value.trim(); if (!name) { alert("Enter unique name."); inputOffspringName.focus(); return; }
            if (findHorseByName(name)) { alert(`"${name}" exists.`); inputOffspringName.focus(); return; }
            tempOffspringData.name=name; tempOffspringData.id=nextId++; tempOffspringData.order=horsesData.reduce((max, h) => Math.max(max, h.order ?? -1), -1) + 1;
            if (!Array.isArray(tempOffspringData.zedBalanceHistory)) tempOffspringData.zedBalanceHistory = [];
            if (!Array.isArray(tempOffspringData.race1TimeHistory)) tempOffspringData.race1TimeHistory = [];
            if (!Array.isArray(tempOffspringData.race2TimeHistory)) tempOffspringData.race2TimeHistory = [];
            horsesData.push(tempOffspringData); saveHorsesData(); alert(`"${name}" added!`); renderBreedsPage(); populateBreedingSelectors(); cancelOffspring();
        }
        function cancelOffspring() { offspringResultDiv.classList.add('hidden'); tempOffspringData = null; inputOffspringName.value = ""; }

        // ========================================================================
        // == BREEDS PAGE INLINE EDIT FUNCTIONS ==
        // ========================================================================
        function toggleParentEditMode(btn) { const sect=btn.closest('.parent-section'); if(!sect)return; const disp=sect.querySelector('.display-details'), edit=sect.querySelector('.inline-edit-form'), parent=findHorseById(sect.getAttribute('data-parent-id')); if(!disp||!edit||!parent||parent.status==='forged'){alert("Cannot edit not found/removed.");return;} const hidden=edit.classList.contains('hidden'); disp.classList.toggle('hidden',hidden); edit.classList.toggle('hidden',!hidden); btn.classList.toggle('hidden',hidden); if(hidden){ edit.querySelector('.inline-breed').value=parent.breed||""; edit.querySelector('.inline-colour').value=parent.colourTrait||""; edit.querySelector('.inline-gen').value=parent.gen||""; edit.querySelector('.inline-overall').value=parent.overall||"-"; edit.querySelector('.inline-speed').value=parent.speed||"-"; edit.querySelector('.inline-sprint').value=parent.sprint||"-"; edit.querySelector('.inline-endurance').value=parent.endurance||"-"; edit.querySelector('.inline-races').value=parent.races??0; } }
        function cancelParentEdit(btn) { const sect=btn.closest('.parent-section'); if(!sect)return; sect.querySelector('.display-details').classList.remove('hidden'); sect.querySelector('.inline-edit-form').classList.add('hidden'); const editBtn=sect.querySelector('.edit-parent-button'); if(editBtn)editBtn.classList.remove('hidden'); }
        function saveParentEdit(btn) { const sect=btn.closest('.parent-section'); if(!sect)return; const pId=parseInt(sect.getAttribute('data-parent-id')), idx=findIndexById(pId); if(isNaN(pId)||idx===-1||horsesData[idx].status==='forged'){alert("Error saving parent.");cancelParentEdit(btn);return;} const editDiv=sect.querySelector('.inline-edit-form'),getStar=(sel)=>editDiv.querySelector(sel).value==='-'?"":editDiv.querySelector(sel).value; Object.assign(horsesData[idx],{breed:editDiv.querySelector('.inline-breed').value,colourTrait:editDiv.querySelector('.inline-colour').value,gen:editDiv.querySelector('.inline-gen').value,overall:getStar('.inline-overall'),speed:getStar('.inline-speed'),sprint:getStar('.inline-sprint'),endurance:getStar('.inline-endurance'),races:parseInt(editDiv.querySelector('.inline-races').value)||0}); saveHorsesData(); alert(`Details for ${horsesData[idx].name} updated.`); renderBreedsPage(); renderLineagePage(); }

        // ========================================================================
        // == THEME TOGGLE & SCROLL ==
        // ========================================================================
        function applyTheme(dark) {
            document.body.classList.toggle('dark-mode', dark);
            darkModeToggle.checked = dark;
            // Update Chart.js global defaults when theme changes for future chart renders
            // This will be picked up by charts when they are re-rendered.
            Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--chart-text-color').trim();
            Chart.defaults.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid-color').trim();
        }
        function toggleTheme() {
            const newIsDark = !document.body.classList.contains('dark-mode');
            applyTheme(newIsDark);
            localStorage.setItem('darkMode', newIsDark);
            if (detailPage && !detailPage.classList.contains('hidden') && currentDetailHorseId !== null) {
                renderHorseDetail(currentDetailHorseId); // Re-render to apply new chart defaults
            }
        }
        window.onscroll = function() { scrollTrigger() }; function scrollTrigger() { if (scrollTopButton) scrollTopButton.style.display = (document.documentElement.scrollTop || document.body.scrollTop) > 200 ? "block" : "none"; }
        function backToTop() { window.scrollTo({top: 0, behavior: 'smooth'}); }

        // ========================================================================
        // == CSV IMPORT FUNCTION ==
        // ========================================================================
        function importRaceDataFromCSV(event) {
            const file=event.target.files[0];if(!file)return;if(!file.name.endsWith('.csv')){alert("Select CSV file.");event.target.value=null;return;}if(!window.Papa){alert("Papa Parse not loaded.");event.target.value=null;return;}
            Papa.parse(file,{header:true,skipEmptyLines:true,dynamicTyping:true,
                complete:function(results){
                    if(results.errors.length>0){console.error("CSV Errors:",results.errors);alert("CSV parse errors.");event.target.value=null;return;}
                    const nameCol='Horse Name',dateCol='Race Date',timeCol='Race Time',posCol='Position';
                    if(!results.data.length||!results.data[0].hasOwnProperty(nameCol)){alert(`'${nameCol}' column missing.`);event.target.value=null;return;}
                    if(!window.confirm(`Found ${results.data.length} records. Import and update Race 1 data?`)){event.target.value=null;return;}
                    let updated=0,processed=0,ids=[];
                    results.data.forEach(rec=>{
                        processed++;const ident=rec[nameCol];if(!ident)return;
                        const idx=horsesData.findIndex(h=>h.name.toLowerCase().trim()===String(ident).toLowerCase().trim());
                        if(idx!==-1){
                            const horse=horsesData[idx];let changed=false;
                            horse.races=(parseInt(horse.races)||0)+1;changed=true;
                            const pos=rec[posCol];
                            if(pos===1||String(pos).toLowerCase()==='1st')horse.first=(parseInt(horse.first)||0)+1;
                            else if(pos===2||String(pos).toLowerCase()==='2nd')horse.second=(parseInt(horse.second)||0)+1;
                            else if(pos===3||String(pos).toLowerCase()==='3rd')horse.third=(parseInt(horse.third)||0)+1;
                            const newTime=rec[timeCol];
                            if(newTime&&typeof newTime==='string'&&parseRaceTime(newTime)!==null){
                                horse.race1Time=newTime;
                                let ts=Date.now();if(rec[dateCol]){const pDate=new Date(rec[dateCol]);if(!isNaN(pDate.getTime()))ts=pDate.getTime();}
                                if(!Array.isArray(horse.race1TimeHistory))horse.race1TimeHistory=[];
                                horse.race1TimeHistory.push({timestamp:ts,time:newTime});
                                changed=true;
                            }
                            if(changed&&!ids.includes(horse.id))ids.push(horse.id);
                        }else console.warn(`Horse "${ident}" not found.`);
                    });
                    updated=ids.length;
                    if(updated>0){saveHorsesData();alert(`${updated} horse(s) updated with ${processed} records for Race 1.`);const currentPg=allPages.find(p=>!p.classList.contains('hidden'));if(currentPg){showPage(currentPg.id);if(currentPg.id==='detailPage'&&currentDetailHorseId){renderHorseDetail(currentDetailHorseId);populateHorseSelectorForDetail();}}else showPage('overviewPage');}else if(processed>0)alert(`Processed ${processed} records, no matches found.`);else alert("No records processed.");
                },error:(err)=>{console.error("CSV Parse Error:",err);alert("Error parsing CSV.");}
            });
            event.target.value = null;
        }

        // ========================================================================
        // == DRAG AND DROP FOR OVERVIEW TABLE ==
        // ========================================================================
        function getDragAfterElement(container, y) { const els=[...container.querySelectorAll('tr[draggable="true"]:not(.dragging)')]; return els.reduce((closest, child)=>{const box=child.getBoundingClientRect(),offset=y-box.top-box.height/2; return (offset<0&&offset>closest.offset)?{offset:offset,element:child}:closest;},{offset:Number.NEGATIVE_INFINITY}).element; }
        horseTableBody.addEventListener('dragstart', (e) => { if (e.target.tagName==='TR'&&e.target.hasAttribute('draggable')) { draggedRow=e.target; draggedRow.classList.add('dragging'); e.dataTransfer.setData('text/plain', draggedRow.dataset.horseId); e.dataTransfer.effectAllowed='move'; } else e.preventDefault(); });
        horseTableBody.addEventListener('dragend', () => { if(draggedRow) draggedRow.classList.remove('dragging'); horseTableBody.querySelectorAll('.drag-over').forEach(row => row.classList.remove('drag-over')); draggedRow=null; });
        horseTableBody.addEventListener('dragover', (e) => { e.preventDefault(); const after=getDragAfterElement(horseTableBody, e.clientY); const current=horseTableBody.querySelector('.drag-over'); if (current&&current!==after&&current!==after?.previousElementSibling) current.classList.remove('drag-over'); if (after&&after!==draggedRow) after.classList.add('drag-over'); e.dataTransfer.dropEffect='move'; });
        horseTableBody.addEventListener('dragleave', (e) => { if (e.relatedTarget && e.relatedTarget.closest('tbody') !== horseTableBody) horseTableBody.querySelectorAll('.drag-over').forEach(row => row.classList.remove('drag-over')); });
        horseTableBody.addEventListener('drop', (e) => { e.preventDefault(); horseTableBody.querySelectorAll('.drag-over').forEach(row => row.classList.remove('drag-over')); if (!draggedRow) return; const after=getDragAfterElement(horseTableBody, e.clientY), droppedId=parseInt(draggedRow.dataset.horseId); let orderedIds=horsesData.filter(h => h.status === 'active').sort((a, b) => (a.order ?? Infinity) - (b.order ?? Infinity)).map(h => h.id); const oldIdx=orderedIds.indexOf(droppedId); if (oldIdx > -1) orderedIds.splice(oldIdx, 1); let insertIdx=orderedIds.length; if (after) { const targetId=parseInt(after.dataset.horseId), targetIdx=orderedIds.indexOf(targetId); if (targetIdx > -1) insertIdx=targetIdx; } orderedIds.splice(insertIdx, 0, droppedId); let currentOrder=0; orderedIds.forEach(id => { const idx=findIndexById(id); if (idx !== -1) horsesData[idx].order=currentOrder++; }); saveHorsesData(); renderOverviewPage(); draggedRow=null; });

        // ========================================================================
        // == EVENT LISTENERS ==
        // ========================================================================
        horseSelector.addEventListener('change', (e) => { const id = e.target.value; if (id && id !== "") showDetailPage(id); else { currentDetailHorseId = null; horseProfileDisplayDiv.classList.add('hidden'); horseFormDiv.classList.add('hidden'); mainActionsDiv.classList.remove('hidden'); hideDetailActionButtons(); horseProfileDisplayDiv.innerHTML = '<p>Select item.</p>'; horseProfileDisplayDiv.classList.remove('hidden'); document.getElementById('race1TimeChartContainer')?.classList.add('hidden'); document.getElementById('zedBalanceChartContainer')?.classList.add('hidden'); } });
        editButton.addEventListener('click', showEditForm); sendToBreedingPoolButton.addEventListener('click', handleSendToBreedingPool); forgeButton.addEventListener('click', handleForgeHorse); cancelButton.addEventListener('click', cancelDetailForm); editAddForm.addEventListener('submit', handleFormSubmit);
        prevHorseBtn.addEventListener('click', () => { if (!currentDetailHorseId) return; const items = getNavigableHorses(), index = items.findIndex(h => h.id === currentDetailHorseId); if (index > 0) showDetailPage(items[index - 1].id); });
        nextHorseBtn.addEventListener('click', () => { if (!currentDetailHorseId) return; const items = getNavigableHorses(), index = items.findIndex(h => h.id === currentDetailHorseId); if (index !== -1 && index < items.length - 1) showDetailPage(items[index + 1].id); });
        breedingRecordsList.addEventListener('click', (e) => { const btn = e.target.closest('button'); if (btn) { if (btn.classList.contains('edit-offspring-button')) { const id=btn.getAttribute('data-id'); if(id) showDetailPage(id); } else if (btn.classList.contains('edit-parent-button')) toggleParentEditMode(btn); else if (btn.classList.contains('save-parent-edit')) saveParentEdit(btn); else if (btn.classList.contains('cancel-parent-edit')) cancelParentEdit(btn); } });
        if(selectSire && selectDam && breedButton) { selectSire.addEventListener('change', checkBreedButtonState); selectDam.addEventListener('change', checkBreedButtonState); breedButton.addEventListener('click', handleBreedClick); }
        if(addOffspringButton) addOffspringButton.addEventListener('click', handleAddOffspring);
        importFileInput.addEventListener('change', importData);
        if (importRaceCsvFileInput) importRaceCsvFileInput.addEventListener('change', importRaceDataFromCSV);
        darkModeToggle.addEventListener('change', toggleTheme);
        if (scrollTopButton) scrollTopButton.addEventListener('click', backToTop); else console.warn("Scroll button not found.");

        // ========================================================================
        // == INITIALISATION ==
        // ========================================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadHorsesData();
            applyTheme(localStorage.getItem('darkMode') === 'true');
            showPage('overviewPage');
            scrollTrigger();
        });
    </script>
</body>
</html>
